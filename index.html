<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>LIGMOT</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* === ãƒ‡ã‚¶ã‚¤ãƒ³ã¯å¤‰æ›´ã—ã¦ã„ã¾ã›ã‚“ï¼ˆè¦‹ãŸç›®ãã®ã¾ã¾ï¼‰ === */
    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background: #f4f6f8;
      color: #333;
    }
    /* ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ */
    #login-page {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background: #e9ecef;
    }
    .login-box {
      background: #fff;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      text-align: center;
      width: 300px;
    }
    .login-box h2 { margin-bottom: 1rem; }
    .login-box input {
      width: 100%;
      padding: 0.6rem;
      margin: 0.5rem 0;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    .login-box button {
      width: 100%;
      padding: 0.6rem;
      margin-top: 1rem;
      border: none;
      border-radius: 6px;
      background: #28a745;
      color: #fff;
      font-size: 1rem;
      cursor: pointer;
    }
    .login-box button:hover { background: #218838; }
    .error { color: red; font-size: 0.9rem; margin-top: 0.5rem; }

    /* ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ï¼ˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã¯çµ¶å¯¾ã«å¤‰ãˆãªã„ï¼‰ */
    #main-page { display: none; height: 100vh; }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #2c3e50;
      color: #fff;
      padding: 0.8rem 1.2rem;
    }
    .logo { font-size: 1.2rem; font-weight: bold; }
    .user-info { display:flex; align-items:center; gap:1rem; }
    #session-timer { font-size: 0.95rem; color:#f1c40f; } /* è¿½åŠ è¡¨ç¤ºï¼ˆè¦‹ãŸç›®ã«æº¶ã‘ã‚‹ã‚ˆã†æ§ãˆã‚ï¼‰ */
    #test-timer { font-size:0.95rem; color:#2ecc71; font-weight:bold; margin-left:8px; } /* ãƒ†ã‚¹ãƒˆã‚¿ã‚¤ãƒãƒ¼ï¼ˆå³ä¸Šè¡¨ç¤ºï¼‰ */
    .logout-btn {
      background: #e74c3c;
      border: none;
      padding: 0.4rem 0.8rem;
      color: #fff;
      border-radius: 6px;
      cursor: pointer;
    }
    .logout-btn:hover { background: #c0392b; }

    main { display:flex; height: calc(100vh - 50px); }
    nav {
      width: 200px;
      background: #34495e;
      color: #fff;
      padding-top: 1rem;
    }
    nav ul { list-style:none; padding:0; margin:0; }
    nav ul li {
      padding: 0.8rem 1rem;
      cursor: pointer;
    }
    nav ul li:hover { background: #3d566e; }
    nav ul li.disabled { opacity: 0.4; pointer-events: none; } /* ãƒ†ã‚¹ãƒˆä¸­ã¯ç„¡åŠ¹åŒ– */
    section { flex: 1; padding: 2rem; overflow-y: auto; }

    .card { background:#fff; border-radius:10px; padding:18px; box-shadow:0 4px 12px rgba(0,0,0,0.06); margin-bottom:16px; }
    .q-block{ border:1px solid #e7eef2; padding:12px; border-radius:8px; margin-bottom:12px; background:#fbfdff; }
    .choice-row{ display:flex; gap:8px; align-items:center; margin:6px 0; }
    .choice-row input[type="text"]{ flex:1; padding:8px; border-radius:6px; border:1px solid #d0d7dc; }
    .choice-row input[type="number"]{ width:100px; padding:8px; border-radius:6px; border:1px solid #d0d7dc; }
    .choice-row select{ width:120px; padding:8px; border-radius:6px; border:1px solid #d0d7dc; }
    .btn-plain{ padding:8px 10px; border-radius:6px; border:0; cursor:pointer; }
    .btn-primary{ background:#2c3e50; color:#fff; }
    .btn-danger{ background:#e74c3c; color:#fff; }
    .hidden{ display:none !important; }

    /* small helper for edit buttons list */
    .part-item { border:1px solid #eef3f5; padding:12px; border-radius:8px; margin-bottom:12px; background:#fff; }
    .part-actions { margin-top:8px; display:flex; gap:8px; }

    /* ãƒˆãƒ­ãƒ•ã‚£ãƒ¼ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    .trophy-anim {
      animation: shine 2s infinite linear;
      display: inline-block;
    }
    @keyframes shine {
      0%   { transform: scale(1) rotate(0deg); filter: drop-shadow(0 0 2px rgba(255,255,255,0.5)); }
      25%  { transform: scale(1.1) rotate(-5deg); filter: drop-shadow(0 0 6px rgba(255,255,255,0.8)); }
      50%  { transform: scale(1.2) rotate(5deg); filter: drop-shadow(0 0 12px rgba(255,255,255,1)); }
      75%  { transform: scale(1.1) rotate(-5deg); filter: drop-shadow(0 0 6px rgba(255,255,255,0.8)); }
      100% { transform: scale(1) rotate(0deg); filter: drop-shadow(0 0 2px rgba(255,255,255,0.5)); }
    }

/* --- bnp pill --- */
#bnp-display{
  background: #fff;
  color: #2c3e50;
  padding: 6px 30px;
  border-radius: 999px; /* åŠå††å½¢ */
  display:inline-flex;
  align-items:center;
  gap:8px;
  min-width:88px;
  justify-content:flex-end; /* æ•°å­—ã¯å³å¯„ã› */
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  font-weight:700;
  margin-right: 8px; /* user-info å†…ã®ä½™ç™½ */
}
#bnp-value{ font-size:1.05em; }
#bnp-unit{ font-size:0.85em; color:#666; padding-left:4px; }

/* æ–‡æ³•ç‰¹è¨“ã®è¨­å•æ–‡ â†’ ã‚¹ãƒšãƒ¼ã‚¹ã‚„æ”¹è¡Œã‚’ä¿æŒ */
.grammar-question-text {
  white-space: pre-wrap;
}

/* ä¸¦ã¹æ›¿ãˆå•é¡Œã®UI */
#answer-area {
  border:2px solid black;
  padding:8px;
  min-height:40px;
  margin-bottom:10px;
}

.word-table {
  width: 100%;
  border-collapse: collapse;
}
.word-table th, .word-table td {
  border: 1px solid #ccc;
  padding: 6px;
  text-align: left;
}
.word-table th {
  background: #f8f8f8;
  font-weight: bold;
}
.word-table td[contenteditable="true"]:focus {
  background: #fff9d6;
  outline: none;
}
  </style>
<style>
  /* æ”¹è¡Œã‚„ã‚¹ãƒšãƒ¼ã‚¹ã‚’ãã®ã¾ã¾åæ˜  */
  .activity-question-text {
    white-space: pre-wrap;
  }
</style>

  <!-- Font Awesome èª­ã¿è¾¼ã¿ -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>


<body>
  <!-- ãƒ­ã‚°ã‚¤ãƒ³ -->
  <div id="login-page">
    <div class="login-box">
      <h2>ãƒ­ã‚°ã‚¤ãƒ³</h2>
      <form id="login-form">
        <input type="text" id="login-id" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼ID" required>
        <input type="password" id="login-password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" required>
        <button type="submit">ãƒ­ã‚°ã‚¤ãƒ³</button>
      </form>
      <div id="login-error" class="error"></div>
      <div style="margin-top:8px;font-size:12px;color:#666">
        IDã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ã€ç®¡ç†è€…ã«å•ã„åˆã‚ã›ã¦ãã ã•ã„ã€‚
      </div>
    </div>
  </div>

  <!-- ãƒ¡ã‚¤ãƒ³ -->
  <div id="main-page">
    <header>
      <div class="logo">ğŸ“˜ LIGMOT</div>
      <div class="user-info" aria-live="polite">
<!-- æ—¢å­˜ã® .user-info ã®ä¸€ç•ªä¸Šï¼ˆã¾ãŸã¯ user-name ã®å·¦ï¼‰ã«è¿½åŠ  -->
<div id="bnp-display" title="ç²å¾—ãƒãƒŠãƒ">
  <span id="bnp-value">0</span>
  <span id="bnp-unit"> bnp</span>
</div>
        <span id="user-name">â€”</span>
        <span id="session-timer">æ®‹ã‚Š: 60:00</span>
        <span id="test-timer" class="hidden">ãƒ†ã‚¹ãƒˆæ®‹ã‚Š: 15:00</span> <!-- ãƒ†ã‚¹ãƒˆä¸­ã®ã¿è¡¨ç¤º -->
        <button id="logout-btn" class="logout-btn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>
    </header>

    <main>
      <nav>
        <ul>
          <li id="menu-userinfo">ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±</li>
          <li id="menu-activity">ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£</li>
          <li id="menu-test">ãƒ†ã‚¹ãƒˆ</li>
          <li id="menu-history">éå»ã®æˆç¸¾</li>
          <li id="menu-mywordlist">ãƒã‚¤å˜èªãƒªã‚¹ãƒˆ</li>
          <li id="menu-audio">éŸ³å£°ã‚³ãƒ³ãƒ†ãƒ³ãƒ„</li>
          <li id="menu-studylog">å­¦ç¿’ã®è¨˜éŒ²</li>
          <li id="menu-adactivity" class="hidden">ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ç®¡ç†</li>
          <li id="menu-japaneses" class="hidden">å›½èª å•é¡Œç®¡ç†</li>
          <li id="menu-socials" class="hidden">ç¤¾ä¼š å•é¡Œç®¡ç†</li>
          <li id="menu-sciences" class="hidden">ç†ç§‘ å•é¡Œç®¡ç†</li>
          <li id="menu-create" class="hidden">å•é¡Œä½œæˆ</li>
          <li id="menu-list" class="hidden">å•é¡Œä¸€è¦§</li>
          <li id="menu-grammar-admin" class="hidden">æ–‡æ³•å•é¡Œä½œæˆ</li>
          <li id="menu-wordlist" class="hidden">å˜èªãƒªã‚¹ãƒˆç®¡ç†</li>
          <li id="menu-useradmin" class="hidden">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</li>
        </ul>
      </nav>
      <section id="content">
        <div class="card"><h2>ã‚ˆã†ã“ãï¼</h2><p>å·¦ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰æ“ä½œã‚’é¸ã‚“ã§ãã ã•ã„ã€‚</p></div>
      </section>
    </main>
  </div>

  <!-- Firebase SDK + æ©Ÿèƒ½è¿½åŠ ï¼ˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼‰ -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import {
      getFirestore, collection, getDocs, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, serverTimestamp, query, where, orderBy
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-storage.js";



    const firebaseConfig = {
      apiKey: "AIzaSyAIg8mvIn8K5qDfP_ozemtZRqKIEioTfMY",
      authDomain: "la-estacion-ymd.firebaseapp.com",
      projectId: "la-estacion-ymd",
      storageBucket: "la-estacion-ymd.firebasestorage.app",
      messagingSenderId: "996153459691",
      appId: "1:996153459691:web:5d9054f92f521fb8388fae",
      measurementId: "G-QKD7SC860Y"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";

const auth = getAuth(app);
let myWordList = []; // å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã®å˜èªã‚’å…¥ã‚Œã‚‹é…åˆ—

onAuthStateChanged(auth, async (user) => {
  if (user) {
    currentUser = { id: user.uid, email: user.email };
    console.log("âœ… ãƒ­ã‚°ã‚¤ãƒ³ä¸­:", currentUser.email);
    await loadMyWordListFromFirestore(); // â† Firestoreã‹ã‚‰è‡ªåˆ†ã®å˜èªã‚’èª­ã¿è¾¼ã¿
  } else {
    console.log("âš ï¸ ãƒ­ã‚°ã‚¢ã‚¦ãƒˆçŠ¶æ…‹");
    currentUser = null;
    myWordList = [];
  }
});
// ===== ä¿å­˜ãƒœã‚¿ãƒ³ =====
document.addEventListener("click", async (e) => {
  if (e.target && e.target.id === "btn-save-activity") {

    const title = document.getElementById('activity-title').value.trim();
    const deadline = document.getElementById('activity-deadline').value;
    if (!title || !deadline) {
      alert('ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£åã¨æå‡ºæœŸé™ã¯å¿…é ˆã§ã™');
      return;
    }

    // Vocabularyå–å¾—
    const vocabQuestions = Array.from(document.querySelectorAll('#vocab-questions .card')).map(div => {
      const q = div.querySelector('.vocab-question').value.trim();
      const choices = Array.from(div.querySelectorAll('.vocab-choice')).map(i => i.value.trim());
      const answer = div.querySelector('.vocab-answer').value;
      return { question: q, choices, answer };
    });

    // Grammarå–å¾—
    const grammarQuestions = Array.from(document.querySelectorAll('#grammar-questions .card')).map(div => {
      const type = div.querySelector('.grammar-type').value;
      const question = div.querySelector('.grammar-question').value.trim();
      const correct = div.querySelector('.grammar-correct').value.trim();
      const choices = Array.from(div.querySelectorAll('.grammar-choice')).map(i => i.value.trim());
      const answer = div.querySelector('.grammar-answer').value;
      return { type, question, correct, choices, answer };
    });

    // Readingå–å¾—
  const readingQuestions = Array.from(document.querySelectorAll('#reading-questions > .card')).map(div => {
  const textArea = div.querySelector('.reading-text');
  const text = textArea ? textArea.value.trim() : ""; // å¿µã®ãŸã‚å®‰å…¨ã«å–å¾—
  const subquestions = Array.from(div.querySelectorAll('.reading-questions-list .card')).map(qDiv => {
    const type = qDiv.querySelector('.reading-type').value;
    const question = qDiv.querySelector('.reading-question').value.trim();
    const correct = qDiv.querySelector('.reading-correct').value.trim();
    const choices = Array.from(qDiv.querySelectorAll('.reading-choice')).map(i => i.value.trim());
    const answer = qDiv.querySelector('.reading-answer').value;
    return { type, question, correct, choices, answer };
  });
  return { text, subquestions };
});


    // å…¬é–‹å¯¾è±¡å–å¾—
    let publishTo = 'all';
    if (document.querySelector('#publish-container input[name="publishOption"]:checked')?.value === 'custom') {
      const checked = Array.from(document.querySelectorAll('#custom-user-list input[type="checkbox"]:checked')).map(i => i.value);
      if (checked.length === 0) {
        alert('å°‘ãªãã¨ã‚‚1äººã¯é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      publishTo = checked;
    }

    const { serverTimestamp } = await import("https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js");

    // ä¿å­˜
    const activityData = {
      title,
      deadline,
      vocabQuestions,
      grammarQuestions,
      readingQuestions,
      publishTo,
      createdAt: serverTimestamp()
    };

    try {
      const docRef = await addDoc(collection(db, "activities"), activityData);
      alert('âœ… ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ˆID: ' + docRef.id + 'ï¼‰');
      console.log("ä¿å­˜å®Œäº†:", activityData);
    } catch (err) {
      console.error(err);
      alert('âŒ ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (err.message || err));
    }
  }
});
    const users = {
      "aduser0110": { password: "ady8453", role: "admin" },
      "test0110":   { password: "assalam", role: "user" },
      "user011001": { password: "assalam", role: "user" },
      "user011002": { password: "assalam", role: "user" },
      "user011003": { password: "urayaha", role: "user" },
      "user011004": { password: "assalam", role: "user" },
      "user011005": { password: "assalam", role: "user" },
      "user011006": { password: "iloveakio", role: "user" },
      "user011007": { password: "assalam", role: "user" }
    };
    let currentUser = null;
    // ===== ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ï¼ˆæ—¢å­˜ä»•æ§˜ï¼‰ =====
    let idleSeconds = 60 * 60;
    let idleInterval = null;
    function startSessionCountdown(){
      idleSeconds = 60 * 60;
      if(idleInterval) clearInterval(idleInterval);
      updateSessionDisplay();
      idleInterval = setInterval(()=>{
        idleSeconds--;
        updateSessionDisplay();
        if(idleSeconds <= 0){
          clearInterval(idleInterval);
          idleInterval = null;
          alert('60åˆ†ç„¡æ“ä½œã®ãŸã‚è‡ªå‹•ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã€‚');
          doLogout();
        }
      }, 1000);
    }
    function updateSessionDisplay(){
      const mm = String(Math.floor(idleSeconds/60)).padStart(2,'0');
      const ss = String(idleSeconds % 60).padStart(2,'0');
      const el = document.getElementById('session-timer');
      if(el) el.textContent = `æ®‹ã‚Š: ${mm}:${ss}`;
    }
    function resetIdle(){ idleSeconds = 60 * 60; updateSessionDisplay(); }
    ['mousemove','keydown','click','touchstart','scroll'].forEach(ev=>{
      document.addEventListener(ev, ()=>{ if(currentUser) resetIdle(); }, {passive:true});
    });

    // ===== ãƒ­ã‚°ã‚¤ãƒ³ =====
    document.getElementById('login-form').addEventListener('submit', e=>{
      e.preventDefault();
      const id = document.getElementById('login-id').value.trim();
      const pw = document.getElementById('login-password').value.trim();
      const errEl = document.getElementById('login-error');
      errEl.textContent = '';
      if(!id || !pw){ errEl.textContent = 'IDã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'; return; }
      if(users[id] && users[id].password === pw){
        currentUser = { id, role: users[id].role };
        showMain();
      } else {
        errEl.textContent = 'IDã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™';
      }
    });

    // ===== è¡¨ç¤ºåˆ‡æ›¿ï¼ˆãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸæ™‚ï¼‰ =====
    function showMain(){
      document.getElementById('login-page').style.display = 'none';
      document.getElementById('main-page').style.display = 'block';
      document.getElementById('user-name').textContent = currentUser.id;
      // ç®¡ç†è€…ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤ºåˆ¶å¾¡
      if(currentUser.role === 'admin'){
        document.getElementById('menu-create').classList.remove('hidden');
        document.getElementById('menu-list').classList.remove('hidden');
        document.getElementById('menu-useradmin').classList.remove('hidden');
        document.getElementById('menu-grammar-admin').classList.remove('hidden');
        document.getElementById('menu-wordlist').classList.remove('hidden');
        document.getElementById('menu-adactivity').classList.remove('hidden');
        document.getElementById('menu-socials').classList.remove('hidden');
        document.getElementById('menu-sciences').classList.remove('hidden');
        document.getElementById('menu-japaneses').classList.remove('hidden');
      } else {
        document.getElementById('menu-create').classList.add('hidden');
        document.getElementById('menu-list').classList.add('hidden');
        document.getElementById('menu-useradmin').classList.add('hidden');
        document.getElementById('menu-grammar-admin').classList.add('hidden');
        document.getElementById('menu-wordlist').classList.add('hidden');
        document.getElementById('menu-adactivity').classList.add('hidden');
        document.getElementById('menu-socials').classList.add('hidden');
        document.getElementById('menu-sciences').classList.add('hidden');
        document.getElementById('menu-japaneses').classList.add('hidden');

      }
      // start session countdown
      startSessionCountdown();
      // default content (test menu)
      renderTestMenu();
    }

    // ===== ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ =====
    document.getElementById('logout-btn').addEventListener('click', ()=> {
      if(confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) doLogout();
    });
    function doLogout(){
      // stop test if running
      if(testActive) {
        stopTest(); // stop timers and UI
      }
      currentUser = null;
      if(idleInterval){ clearInterval(idleInterval); idleInterval = null; }
      document.getElementById('main-page').style.display = 'none';
      document.getElementById('login-page').style.display = 'flex';
      document.getElementById('login-form').reset();
      // reset display
      document.getElementById('session-timer').textContent = 'æ®‹ã‚Š: 60:00';
      document.getElementById('content').innerHTML = `<div class="card"><h2>ã‚ˆã†ã“ãï¼</h2><p>å·¦ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰æ“ä½œã‚’é¸ã‚“ã§ãã ã•ã„ã€‚</p></div>`;
    }

// ===== ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼å‹•ä½œï¼ˆãã®ã¾ã¾ï¼‰ =====
document.getElementById('menu-test').addEventListener('click', ()=> { if(!testActive) renderTestMenu(); });
document.getElementById('menu-history').addEventListener('click', ()=> { if(!testActive) renderHistory(); });
document.getElementById('menu-create').addEventListener('click', ()=> { if(!testActive) renderCreateForm(); });
document.getElementById('menu-list').addEventListener('click', ()=> { if(!testActive) loadPartsList(); });
document.getElementById('menu-useradmin').addEventListener('click', ()=> { if(!testActive) renderUserManagement(); });
document.getElementById('menu-grammar-admin').addEventListener('click', ()=> { if(!testActive) renderGrammarAdminHome(); });
document.getElementById('menu-wordlist').addEventListener('click', ()=> { 
  if(!testActive) renderWordList(); 
});
document.getElementById('menu-mywordlist').addEventListener('click', ()=> {
  if (!testActive) renderMyWordList();
});
document.getElementById('menu-adactivity').addEventListener('click', () => {
    renderActivityAdmin();
});


function renderActivityAdmin() {
    document.getElementById('content').innerHTML = `
        <div class="card">
            <h2>ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ç®¡ç†</h2>
            <p>ã“ã“ã‹ã‚‰å®¿é¡Œï¼ˆã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ï¼‰ã®ä½œæˆã€æå‡ºæœŸé™è¨­å®šã€æå‡ºçŠ¶æ³ã®ç¢ºèªãŒã§ãã¾ã™ã€‚</p>
            <div style="margin-top:20px;">
                <button id="btn-create-activity" class="btn-plain btn-primary">ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ä½œæˆ</button>
                <button id="btn-view-submissions" class="btn-plain">æå‡ºçŠ¶æ³ç¢ºèª</button>
            </div>
            <div id="activity-admin-area" style="margin-top:20px;"></div>
        </div>
    `;

    // ãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆè¿½åŠ 
    document.getElementById('btn-create-activity').addEventListener('click', () => {
        renderCreateActivity();
    });

    document.getElementById('btn-view-submissions').addEventListener('click', () => {
        renderActivitySubmissions();
    });
}


function renderCreateActivity() {
    document.getElementById('activity-admin-area').innerHTML = `
        <h3 style="font-family:sans-serif; margin-bottom:16px;">æ–°ã—ã„ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ä½œæˆ</h3>
        
        <div class="card" style="padding:16px; margin-bottom:16px;">
            <label>ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£å:</label>
            <input id="activity-title" type="text" style="width:100%; padding:10px; border-radius:8px; border:1px solid #ccc; margin-bottom:12px; font-size:16px;">
            
            <label>æå‡ºæœŸé™:</label>
            <input id="activity-deadline" type="date" style="padding:10px; border-radius:8px; border:1px solid #ccc; font-size:16px;">
        </div>

        <!-- Vocabulary -->
        <div class="card" style="padding:16px; margin-bottom:16px;">
            <h4>1. Vocabulary</h4>
            <label>å•é¡Œæ•°:</label>
            <input id="vocab-count" type="number" min="1" value="20" style="width:60px; padding:6px; margin-bottom:8px;">
            <div id="vocab-questions"></div>
            <button id="btn-add-vocab" class="btn-plain" style="margin-top:8px;">å•é¡Œã‚’è¿½åŠ </button>
        </div>

        <!-- Grammar -->
        <div class="card" style="padding:16px; margin-bottom:16px;">
            <h4>2. Grammar</h4>
            <label>å•é¡Œæ•°:</label>
            <input id="grammar-count" type="number" min="1" value="10" style="width:60px; padding:6px; margin-bottom:8px;">
            <div id="grammar-questions"></div>
            <button id="btn-add-grammar" class="btn-plain" style="margin-top:8px;">å•é¡Œã‚’è¿½åŠ </button>
        </div>

        <!-- Reading -->
        <div class="card" style="padding:16px; margin-bottom:16px;">
            <h4>3. Reading</h4>
            <label>å•é¡Œæ•°:</label>
            <input id="reading-count" type="number" min="1" value="5" style="width:60px; padding:6px; margin-bottom:8px;">
            <div id="reading-questions"></div>
            <button id="btn-add-reading" class="btn-plain" style="margin-top:8px;">å•é¡Œã‚’è¿½åŠ </button>
        </div>

        <!-- å…¬é–‹å¯¾è±¡ -->
        <div class="card" style="padding:16px; margin-bottom:16px;" id="publish-container">
            <h3>å…¬é–‹å¯¾è±¡</h3>
            <label><input type="radio" name="publishOption" value="all" checked> å…¨å“¡ã«å…¬é–‹</label>
            <label><input type="radio" name="publishOption" value="custom"> å€‹åˆ¥ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠ</label>
            <div id="custom-user-list" style="margin-top:8px; display:none; max-height:200px; overflow-y:auto; border:1px solid #ccc; padding:6px; border-radius:6px; background:#fff;">
                ${Object.keys(users)
                  .filter(u => users[u].role !== "admin")
                  .map(u => `<label style="display:block; margin-bottom:4px;"><input type="checkbox" value="${u}"> ${u}</label>`).join('')}
            </div>
        </div>

        <button id="btn-save-activity" class="btn-plain btn-primary" style="padding:12px 24px; border-radius:8px; font-size:16px;">ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’ä¿å­˜</button>
    `;

    // å…¬é–‹å¯¾è±¡ãƒ©ã‚¸ã‚ª
    const radios = document.querySelectorAll('#publish-container input[name="publishOption"]');
    const customList = document.getElementById('custom-user-list');
    radios.forEach(radio => {
        radio.addEventListener('change', () => {
            customList.style.display = radio.value === 'custom' ? 'block' : 'none';
        });
    });

    // ===== Vocaè¿½åŠ  =====
    document.getElementById('btn-add-vocab').addEventListener('click', () => {
        const container = document.getElementById('vocab-questions');
        const index = container.children.length + 1;
        const div = document.createElement('div');
        div.className = 'card';
        div.style.padding = '12px';
        div.style.marginBottom = '8px';
        div.style.background = '#fff';
        div.style.boxShadow = '0 2px 6px rgba(0,0,0,0.08)';
        div.innerHTML = `
            <p>å•é¡Œ ${index}:</p>
            <textarea placeholder="å•é¡Œæ–‡" class="vocab-question" style="width:100%; height:60px; padding:8px; margin-bottom:6px;"></textarea>
            <div style="display:flex; gap:8px; margin-bottom:6px;">
                <input placeholder="é¸æŠè‚¢A" class="vocab-choice" style="flex:1; padding:6px;">
                <input placeholder="é¸æŠè‚¢B" class="vocab-choice" style="flex:1; padding:6px;">
            </div>
            <div style="display:flex; gap:8px; margin-bottom:6px;">
                <input placeholder="é¸æŠè‚¢C" class="vocab-choice" style="flex:1; padding:6px;">
                <input placeholder="é¸æŠè‚¢D" class="vocab-choice" style="flex:1; padding:6px;">
            </div>
            <label>æ­£è§£:</label>
            <select class="vocab-answer" style="padding:6px;">
                <option value="A">A</option>
                <option value="B">B</option>
                <option value="C">C</option>
                <option value="D">D</option>
            </select>
        `;
        container.appendChild(div);
    });

    // ===== Graè¿½åŠ  =====
    document.getElementById('btn-add-grammar').addEventListener('click', () => {
        const container = document.getElementById('grammar-questions');
        const index = container.children.length + 1;
        const div = document.createElement('div');
        div.className = 'card';
        div.style.padding = '12px';
        div.style.marginBottom = '8px';
        div.style.background = '#fff';
        div.style.boxShadow = '0 2px 6px rgba(0,0,0,0.08)';
        div.innerHTML = `
            <p>å•é¡Œ ${index}:</p>
            <select class="grammar-type" style="margin-bottom:6px; padding:6px;">
                <option value="multiple">å››æŠ</option>
                <option value="fill">é©èªè£œå……</option>
                <option value="order">ä¸¦ã¹æ›¿ãˆ</option>
            </select>
            <div class="grammar-input-area" style="margin-top:6px;">
                <textarea placeholder="å•é¡Œæ–‡" class="grammar-question" style="width:100%; height:80px; padding:8px; margin-bottom:6px;"></textarea>

                <div class="grammar-choices" style="display:flex; gap:8px; margin-bottom:6px;">
                    <input placeholder="é¸æŠè‚¢A" class="grammar-choice" style="flex:1; padding:6px;">
                    <input placeholder="é¸æŠè‚¢B" class="grammar-choice" style="flex:1; padding:6px;">
                    <input placeholder="é¸æŠè‚¢C" class="grammar-choice" style="flex:1; padding:6px;">
                    <input placeholder="é¸æŠè‚¢D" class="grammar-choice" style="flex:1; padding:6px;">
                </div>

                <label>æ­£ç­”å…¥åŠ›:</label>
                <input type="text" class="grammar-correct" placeholder="æ­£ã—ã„ç­”ãˆ" style="width:100%; padding:6px; margin-bottom:6px;">
                <label>æ­£è§£ï¼ˆå››æŠã®å ´åˆï¼‰:</label>
                <select class="grammar-answer" style="padding:6px;">
                    <option value="A">A</option>
                    <option value="B">B</option>
                    <option value="C">C</option>
                    <option value="D">D</option>
                </select>
            </div>
        `;
        container.appendChild(div);

        const typeSelect = div.querySelector('.grammar-type');
        const inputArea = div.querySelector('.grammar-input-area');
        const choices = inputArea.querySelector('.grammar-choices');
        const answerSelect = inputArea.querySelector('.grammar-answer');
        const correctInput = inputArea.querySelector('.grammar-correct');

        typeSelect.addEventListener('change', () => {
            const type = typeSelect.value;
            if(type === 'multiple') {
                choices.style.display = 'flex';
                answerSelect.style.display = 'inline-block';
                correctInput.style.display = 'none';
            } else {
                choices.style.display = 'none';
                answerSelect.style.display = 'none';
                correctInput.style.display = 'block';
                correctInput.placeholder = type === 'fill' ? "ç©ºæ¬„ã«å…¥ã‚‹æ­£ã—ã„èªã‚’å…¥åŠ›" : "æ­£ã—ã„é †åºã‚’ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§å…¥åŠ›";
            }
        });
        typeSelect.dispatchEvent(new Event('change'));
    });

    // ===== Readingå•é¡Œè¿½åŠ  =====
    document.getElementById('btn-add-reading').addEventListener('click', () => {
        const container = document.getElementById('reading-questions');
        const index = container.children.length + 1;
        const div = document.createElement('div');
        div.className = 'card';
        div.style.padding = '12px';
        div.style.marginBottom = '8px';
        div.style.background = '#fff';
        div.style.boxShadow = '0 2px 6px rgba(0,0,0,0.08)';
        
        div.innerHTML = `
            <p>è‹±æ–‡ ${index}:</p>
            <textarea placeholder="è‹±æ–‡ï¼ˆ600èªç¨‹åº¦ï¼‰" class="reading-text" style="width:100%; height:400px; padding:8px; margin-bottom:8px;"></textarea>
            <div class="reading-questions-list"></div>
            <button class="btn-plain btn-add-reading-question" style="margin-top:6px;">è¨­å•ã‚’è¿½åŠ </button>
        `;
        container.appendChild(div);

        const questionsList = div.querySelector('.reading-questions-list');
        const addBtn = div.querySelector('.btn-add-reading-question');

        addBtn.addEventListener('click', () => {
            const qIndex = questionsList.children.length + 1;
            const qDiv = document.createElement('div');
            qDiv.className = 'card';
            qDiv.style.padding = '8px';
            qDiv.style.marginBottom = '6px';
            qDiv.style.background = '#f9f9f9';
            qDiv.innerHTML = `
                <p>è¨­å• ${qIndex}:</p>
                <select class="reading-type" style="margin-bottom:6px; padding:6px;">
                    <option value="multiple">å››æŠ</option>
                    <option value="input">å…¥åŠ›å¼</option>
                </select>
                <textarea placeholder="è¨­å•æ–‡" class="reading-question" style="width:100%; height:60px; padding:6px; margin-bottom:6px;"></textarea>

                <div class="reading-choices" style="display:flex; gap:8px; margin-bottom:6px;">
                    <input placeholder="é¸æŠè‚¢A" class="reading-choice" style="flex:1; padding:6px;">
                    <input placeholder="é¸æŠè‚¢B" class="reading-choice" style="flex:1; padding:6px;">
                    <input placeholder="é¸æŠè‚¢C" class="reading-choice" style="flex:1; padding:6px;">
                    <input placeholder="é¸æŠè‚¢D" class="reading-choice" style="flex:1; padding:6px;">
                </div>

                <label>æ­£ç­”å…¥åŠ›:</label>
                <input type="text" class="reading-correct" placeholder="æ­£ã—ã„ç­”ãˆ" style="width:100%; padding:6px; margin-bottom:6px;">

                <label>æ­£è§£ï¼ˆå››æŠã®å ´åˆï¼‰:</label>
                <select class="reading-answer" style="padding:6px;">
                    <option value="A">A</option>
                    <option value="B">B</option>
                    <option value="C">C</option>
                    <option value="D">D</option>
                </select>
            `;
            questionsList.appendChild(qDiv);

            const typeSelect = qDiv.querySelector('.reading-type');
            const choicesDiv = qDiv.querySelector('.reading-choices');
            const answerSelect = qDiv.querySelector('.reading-answer');
            const correctInput = qDiv.querySelector('.reading-correct');

            typeSelect.addEventListener('change', () => {
                if(typeSelect.value === 'multiple') {
                    choicesDiv.style.display = 'flex';
                    answerSelect.style.display = 'inline-block';
                    correctInput.style.display = 'none';
                } else {
                    choicesDiv.style.display = 'none';
                    answerSelect.style.display = 'none';
                    correctInput.style.display = 'block';
                    correctInput.placeholder = "æ­£ã—ã„ç­”ãˆã‚’å…¥åŠ›";
                }
            });
            typeSelect.dispatchEvent(new Event('change'));
        });
    });

   }


// ğŸ§­ ç®¡ç†è€…ç”¨ï¼šæå‡ºçŠ¶æ³ç¢ºèªï¼ˆæŠ˜ã‚ŠãŸãŸã¿å¼ï¼‰
// ğŸ§­ ç®¡ç†è€…ç”¨ï¼šæå‡ºçŠ¶æ³ç¢ºèªï¼ˆæŠ˜ã‚ŠãŸãŸã¿å¼ + æ¡ç‚¹å¯èƒ½ï¼‰
async function renderActivitySubmissions() {
  const content = document.getElementById("activity-admin-area");
  content.innerHTML = `<div class="card"><p>èª­ã¿è¾¼ã¿ä¸­...</p></div>`;

  const submissionsSnap = await getDocs(collection(db, "activity_submissions"));

  // ğŸ”¹ Firestore Timestamp â†’ Date ã«å¤‰æ›
  let submissions = submissionsSnap.docs.map(doc => {
    const data = doc.data();
    return {
      id: doc.id,
      ...data,
      submittedAt: data.submittedAt?.toDate() || new Date(0)
    };
  });

  // ğŸ”¹ æ–°ã—ã„æå‡ºé †ã«ä¸¦ã¹ã‚‹
  submissions.sort((a, b) => b.submittedAt.getTime() - a.submittedAt.getTime());

  let html = `
    <div class="card">
      <h2>æå‡ºé †ä¸€è¦§</h2>
      <div id="submission-list" style="display:flex; flex-direction:column; gap:8px;"></div>
    </div>
  `;
  content.innerHTML = html;
  const listDiv = document.getElementById("submission-list");

  // ğŸ”¹ æå‡ºã‚’ 1 ä»¶ãšã¤ã‚«ãƒ¼ãƒ‰è¡¨ç¤º
  for (const sub of submissions) {
    const detailId = `detail-${sub.id}`;
    const submittedAt = sub.submittedAt.toLocaleString();

    const card = document.createElement("div");
    card.className = "card";
    card.style.padding = "12px";
    card.style.border = "2px solid #ccc";
    card.style.borderRadius = "8px";
    card.style.marginBottom = "12px";
    card.innerHTML = `
      <div>
        <strong>${sub.userId}</strong><br>
        <span style="font-size:13px;">ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£åï¼š${sub.activityName || "æœªè¨­å®š"}</span><br>
        <span style="font-size:13px; color:#555;">æå‡ºæ—¥æ™‚ï¼š${submittedAt}</span>
      </div>
      <div id="${detailId}" style="display:none; margin-top:12px;"></div>
    `;
    listDiv.appendChild(card);

    // ğŸ”¹ ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°å±•é–‹
    const clickableArea = card.querySelector("strong");
    clickableArea.style.cursor = "pointer";
    clickableArea.style.textDecoration = "underline";

    clickableArea.addEventListener("click", async () => {
      const detail = document.getElementById(detailId);
      if (detail.style.display === "none") {
        detail.style.display = "block";

        // ğŸ”¹ activity ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const actSnap = await getDoc(doc(db, "activities", sub.activityId));
        const activity = actSnap.exists() ? actSnap.data() : { vocabQuestions: [], grammarQuestions: [], readingQuestions: [] };

        detail.innerHTML = renderSubmissionDetail(sub.id, sub.answers, activity);
      } else {
        detail.style.display = "none";
      }
    });
  }
}

// ğŸ”¹ æå‡ºå†…å®¹ã®è©³ç´°è¡¨ç¤º + æ¡ç‚¹ãƒ•ã‚©ãƒ¼ãƒ 
function renderSubmissionDetail(submissionId, answers, activity) {
  let html = `<div class="card" style="padding:10px;">`;

  // Vocabulary
  html += `<h4>Vocabulary</h4>`;
  activity.vocabQuestions.forEach((q, i) => {
    const userAns = answers.vocab.find(a => Number(a.q) === i)?.choice || "æœªè§£ç­”";
    const correct = q.answer;
    html += `<div>${i + 1}. ${q.question}<br>é¸æŠè‚¢: ${q.choices.join(", ")}<br>ã‚ãªãŸã®ç­”ãˆ: ${userAns}<br>æ­£ç­”: ${correct}</div>`;
  });

  // Grammar
  html += `<h4 style="margin-top:10px;">Grammar</h4>`;
  activity.grammarQuestions.forEach((q, i) => {
    const userChoice = answers.grammar.find(a => Number(a.q) === i && a.choice)?.choice;
    const userText = answers.grammar.find(a => Number(a.q) === i && a.answer)?.answer;
    const userAns = userChoice || userText || "æœªè§£ç­”";
    const correct = q.answer;
    html += `<div>${i + 1}. ${q.question}<br>é¸æŠè‚¢: ${q.choices ? q.choices.join(", ") : "-"}<br>ã‚ãªãŸã®ç­”ãˆ: ${userAns}<br>æ­£ç­”: ${correct}</div>`;
  });

  // Reading
  html += `<h4 style="margin-top:10px;">Reading</h4>`;
  activity.readingQuestions.forEach((r, i) => {
    html += `<div>è‹±æ–‡${i + 1}: ${r.text}</div>`;
    r.subquestions.forEach((sq, j) => {
      const key = `${i}_${j}`;
      const userChoice = answers.reading.find(a => a.q === key && a.choice)?.choice;
      const userText = answers.reading.find(a => a.q === key && a.answer)?.answer;
      const userAns = userChoice || userText || "æœªè§£ç­”";
      const correct = sq.answer;
      html += `<div style="margin-left:12px;">${j + 1}. ${sq.question}<br>é¸æŠè‚¢: ${sq.choices ? sq.choices.join(", ") : "-"}<br>ã‚ãªãŸã®ç­”ãˆ: ${userAns}<br>æ­£ç­”: ${correct}</div>`;
    });
  });

  // æ¡ç‚¹ãƒ•ã‚©ãƒ¼ãƒ 
  html += `
    <div style="margin-top:20px; padding:12px; border-top:1px solid #ccc;">
      <h4>æ¡ç‚¹ãƒ»ã‚³ãƒ¡ãƒ³ãƒˆ</h4>
      <label>ç‚¹æ•° (0ã€œ50)ï¼š<input type="number" id="score-input" min="0" max="50" style="width:60px;"></label><br><br>
      <label>ã‚³ãƒ¡ãƒ³ãƒˆï¼š</label><br>
      <textarea id="comment-input" rows="3" style="width:100%;"></textarea><br><br>
      <button id="btn-submit-score" class="modern-btn">é€ä¿¡</button>
      <span id="score-status" style="margin-left:10px;color:green;"></span>
    </div>
  </div>`;

  // ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
  setTimeout(() => {
    document.getElementById("btn-submit-score").addEventListener("click", async () => {
      const score = parseInt(document.getElementById("score-input").value);
      const comment = document.getElementById("comment-input").value;

      if (isNaN(score) || score < 0 || score > 50) {
        alert("0ã€œ50ã®ç¯„å›²ã§ç‚¹æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        return;
      }

      try {
        await updateDoc(doc(db, "activity_submissions", submissionId), {
          score,
          comment,
          gradedAt: serverTimestamp()
        });
        document.getElementById("score-status").textContent = "âœ… æ¡ç‚¹æ¸ˆã¿";
      } catch (err) {
        console.error(err);
        alert("æ¡ç‚¹ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: " + err.message);
      }
    });
  }, 50);

  return html;
}


// ================================
// ğŸ§­ ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£æ©Ÿèƒ½ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ç”¨ï¼‰
// ================================
document.getElementById("menu-activity").addEventListener("click", async () => {
  const content = document.getElementById("content");
  content.innerHTML = `<div class="card"><h2>ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ä¸€è¦§</h2><p>èª­ã¿è¾¼ã¿ä¸­...</p></div>`;

  const qSnap = await getDocs(collection(db, "activities"));
  const activities = qSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

  if (activities.length === 0) {
    content.innerHTML = `<div class="card"><p>ã¾ã ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p></div>`;
    return;
  }

  content.innerHTML = `
    <div class="card">
      <h2>ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ä¸€è¦§</h2>
      <div id="activity-list" style="display:flex; flex-direction:column; gap:12px;"></div>
    </div>
  `;

  const listDiv = document.getElementById("activity-list");

  // ğŸ”¹ å…¨æå‡ºãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
  const submissionsSnap = await getDocs(collection(db, "activity_submissions"));
  const submissions = submissionsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

  const today = new Date();

  activities.forEach(act => {
    const deadlineDate = new Date(act.deadline);
    const expired = today > deadlineDate;

    // ğŸ” ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æå‡ºãƒ‡ãƒ¼ã‚¿
    const userSubmission = submissions.find(s => s.activityId === act.id && s.userId === currentUser.id);

    const submitted = !!userSubmission;
    const returned = userSubmission?.score !== undefined; // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚ã‚Š

    const showNew = !submitted && !expired;
    const showSubmitted = submitted && !expired;

    const btnText = expired ? "æœŸé™åˆ‡ã‚Œ" : "å®Ÿæ–½ã™ã‚‹";
    const btnClass = expired ? "btn-expired" : "btn-execute";

    const div = document.createElement("div");
    div.className = "card";
    div.style.padding = "12px";
    div.style.background = "#fff";
    div.style.boxShadow = "0 2px 6px rgba(0,0,0,0.08)";
    div.style.position = "relative";
    div.style.border = "2px solid #ccc";

    let badgeHtml = "";
    if (showNew) {
      badgeHtml = '<span style="position:absolute; top:10px; left:10px; background:#ff3b30; color:#fff; padding:2px 6px; border-radius:6px; font-size:12px;">NEW</span>';
    } else if (showSubmitted) {
      badgeHtml = '<span style="position:absolute; top:10px; left:10px; background:#aaa; color:#fff; padding:2px 6px; border-radius:6px; font-size:12px;">æå‡ºæ¸ˆã¿</span>';
    }

    div.innerHTML = `
      ${badgeHtml}
      <h3>${act.title}</h3>
      <p>æå‡ºæœŸé™ï¼š${act.deadline}</p>

      <div style="display:flex; gap:10px; margin-top:10px;">

        <!-- å®Ÿæ–½ãƒœã‚¿ãƒ³ -->
        <button class="btn-do-activity ${btnClass}" data-id="${act.id}" ${expired ? "disabled" : ""}>
          ${btnText}
        </button>

        <!-- ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’è¦‹ã‚‹ -->
        ${returned ? `
          <button class="btn-feedback" data-id="${act.id}" style="
            background:#4CAF50; color:#fff; border:none; border-radius:8px;
            padding:8px 14px; cursor:pointer;
          ">
            ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’è¦‹ã‚‹
          </button>
        ` : ""}
      </div>
    `;

    listDiv.appendChild(div);
  });

  // ãƒœã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«
  const style = document.createElement("style");
  style.textContent = `
    .btn-execute { background:#ff3b30; color:#fff; border:none; border-radius:8px; padding:8px 14px; cursor:pointer; }
    .btn-expired { background:#ccc; color:#666; border:none; border-radius:8px; padding:8px 14px; cursor:not-allowed; }
  `;
  document.head.appendChild(style);

  // å®Ÿæ–½ãƒœã‚¿ãƒ³
  document.querySelectorAll(".btn-do-activity").forEach(btn => {
    btn.addEventListener("click", async (e) => {
      const actId = e.target.dataset.id;
      const confirmed = confirm("ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’å®Ÿæ–½ã—ã¾ã™ã‹ï¼Ÿ\nä¸€åº¦å®Ÿæ–½ã™ã‚‹ã¨æå‡ºã™ã‚‹ã¾ã§ä¸€æ™‚ä¸­æ–­ã§ãã¾ã›ã‚“ã€‚");
      if (confirmed) await renderActivityExecution(actId);
    });
  });

  // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’è¦‹ã‚‹
  document.querySelectorAll(".btn-feedback").forEach(btn => {
    btn.addEventListener("click", () => {
      const actId = btn.dataset.id;
      const submission = submissions.find(s => s.activityId === actId && s.userId === currentUser.id);
      renderActivityFeedback(actId, submission);
    });
  });
});


// ===============================
// ğŸ“˜ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¡¨ç¤ºç”»é¢ï¼ˆä¿®æ­£ç‰ˆï¼‰
// ===============================
function renderActivityFeedback(activityId, submission) {
  const content = document.getElementById("content");

  content.innerHTML = `
    <div class="card">
      <h2>ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</h2>

      <p><strong>ç‚¹æ•°ï¼š</strong> ${submission.score ?? "æœªæ¡ç‚¹"}</p>

      <p><strong>ã‚³ãƒ¡ãƒ³ãƒˆï¼š</strong></p>
      <div style="
        white-space:pre-wrap;
        padding:12px;
        border:1px solid #ccc;
        border-radius:8px;
        background:#f9f9f9;
      ">
        ${submission.comment ?? "ã¾ã ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚"}
      </div>

      <button id="btn-back" style="margin-top:20px;">ä¸€è¦§ã«æˆ»ã‚‹</button>
    </div>
  `;

  document.getElementById("btn-back").addEventListener("click", () => {
    document.getElementById("menu-activity").click();
  });
}


// ================================
// ä¸€æ™‚ä¿å­˜ï¼ˆãƒšãƒ¼ã‚¸ç§»å‹•æ™‚ã«æ›´æ–°ï¼‰
const answersTemp = {
  vocab: {},    // { "0": "A", ... }
  grammar: {},  // { "0": "B", "1": "text answer", ... }
  reading: {}   // { "0_0": "A", "1_0": "text answer", ... }
};

// ğŸ§­ ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£å®Ÿæ–½ç”»é¢ï¼ˆNextã§ãƒšãƒ¼ã‚¸ä¿å­˜ãƒ»å¾©å…ƒã‚ã‚Šï¼‰
async function renderActivityExecution(activityId) {
  const docSnap = await getDoc(doc(db, "activities", activityId));
  if (!docSnap.exists()) {
    alert("ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
    return;
  }
  const activity = docSnap.data();
  const content = document.getElementById("content");

  const sections = ["Vocabulary", "Grammar", "Reading"];
  let currentIndex = 0;

  // --- ãƒšãƒ¼ã‚¸ã®å›ç­”ã‚’ answersTemp ã«ä¿å­˜ã™ã‚‹ï¼ˆcurrent pageï¼‰
  function saveCurrentPageAnswers(section) {
    if (section === "Vocabulary") {
      // for each question (by q id) grab selected choice
      document.querySelectorAll('.choice-card[data-section="vocab"]').forEach(card => {
        const q = card.dataset.q;
        if (card.dataset.selected === "true") {
          answersTemp.vocab[q] = card.dataset.choice;
        }
      });
    } else if (section === "Grammar") {
      // multiple choice
      document.querySelectorAll('.choice-card[data-section="grammar"]').forEach(card => {
        const q = card.dataset.q;
        if (card.dataset.selected === "true") {
          answersTemp.grammar[q] = card.dataset.choice;
        }
      });
      // text inputs (may overwrite if both exist; text inputs use same q index)
      document.querySelectorAll('.grammar-input').forEach(input => {
        const q = input.dataset.q;
        if (input.value.trim() !== "") {
          answersTemp.grammar[q] = input.value.trim();
        } else {
          // if no text and a multiple choice exists, keep the choice; otherwise remove if empty
          if (!answersTemp.grammar[q]) {
            delete answersTemp.grammar[q];
          }
        }
      });
    } else if (section === "Reading") {
      // reading multiple choices
      document.querySelectorAll('.choice-card[data-section="reading"]').forEach(card => {
        const q = card.dataset.q; // "i_j"
        if (card.dataset.selected === "true") {
          answersTemp.reading[q] = card.dataset.choice;
        }
      });
      // reading text inputs
      document.querySelectorAll('.reading-input').forEach(input => {
        const q = input.dataset.q;
        if (input.value.trim() !== "") {
          answersTemp.reading[q] = input.value.trim();
        } else {
          if (!answersTemp.reading[q]) delete answersTemp.reading[q];
        }
      });
    }
  }

  // --- ç¾åœ¨ã® answersTemp ã‚’ãƒšãƒ¼ã‚¸ã«åæ˜ ï¼ˆå¾©å…ƒï¼‰
  function restorePageSelections(section) {
    if (section === "Vocabulary") {
      Object.keys(answersTemp.vocab).forEach(q => {
        const choice = answersTemp.vocab[q];
        if (choice == null) return;
        const selector = `.choice-card[data-section="vocab"][data-q="${q}"][data-choice="${choice}"]`;
        const el = document.querySelector(selector);
        if (el) {
          // reset siblings
          document.querySelectorAll(`.choice-card[data-section="vocab"][data-q="${q}"]`).forEach(c => {
            c.dataset.selected = "false";
            c.style.background = "#fff";
          });
          el.dataset.selected = "true";
          el.style.background = "#d0f0ff";
        }
      });
    } else if (section === "Grammar") {
      // restore multiple choices
      Object.keys(answersTemp.grammar).forEach(q => {
        const val = answersTemp.grammar[q];
        // if val is single letter like "A" treat as choice; else treat as text
        if (typeof val === "string" && val.length === 1 && /^[A-Z]$/.test(val)) {
          const el = document.querySelector(`.choice-card[data-section="grammar"][data-q="${q}"][data-choice="${val}"]`);
          if (el) {
            document.querySelectorAll(`.choice-card[data-section="grammar"][data-q="${q}"]`).forEach(c => {
              c.dataset.selected = "false";
              c.style.background = "#fff";
            });
            el.dataset.selected = "true";
            el.style.background = "#d0f0ff";
          }
        } else {
          // try to find text input and fill
          const input = document.querySelector(`.grammar-input[data-q="${q}"]`);
          if (input) input.value = val;
        }
      });
    } else if (section === "Reading") {
      Object.keys(answersTemp.reading).forEach(key => {
        const val = answersTemp.reading[key];
        if (typeof val === "string" && val.length === 1 && /^[A-Z]$/.test(val)) {
          const el = document.querySelector(`.choice-card[data-section="reading"][data-q="${key}"][data-choice="${val}"]`);
          if (el) {
            document.querySelectorAll(`.choice-card[data-section="reading"][data-q="${key}"]`).forEach(c => {
              c.dataset.selected = "false";
              c.style.background = "#fff";
            });
            el.dataset.selected = "true";
            el.style.background = "#d0f0ff";
          }
        } else {
          const input = document.querySelector(`.reading-input[data-q="${key}"]`);
          if (input) input.value = val;
        }
      });
    }
  }

  // --- ãƒšãƒ¼ã‚¸æç”»
  const renderPage = () => {
    const section = sections[currentIndex];
    let html = `<div class="card"><h2>${section}</h2>`;

    if (section === "Vocabulary") {
      activity.vocabQuestions.forEach((q, i) => {
        html += `
          <div class="card" style="margin:8px 0; padding:12px;">
            <p class="activity-question-text">${i + 1}. ${q.question}</p>
            <div class="choice-grid" style="display:grid; gap:8px; grid-template-columns:1fr 1fr;">
              ${q.choices.map((c, idx) => `
                <div class="choice-card" 
                  style="padding:10px; border:1px solid #ccc; border-radius:8px; cursor:pointer;"
                  data-q="${i}" 
                  data-choice="${String.fromCharCode(65 + idx)}"
                  data-section="vocab"
                  data-selected="false"
                >${String.fromCharCode(65 + idx)}. ${c}</div>
              `).join("")}
            </div>
          </div>`;
      });
    } else if (section === "Grammar") {
      activity.grammarQuestions.forEach((q, i) => {
        html += `
          <div class="card" style="margin:8px 0; padding:12px;">
            <p class="activity-question-text">${i + 1}. ${q.question}</p>
            ${q.type === "multiple"
              ? `<div class="choice-grid" style="display:grid; gap:8px; grid-template-columns:1fr 1fr;">
                  ${q.choices.map((c, idx) => `
                    <div class="choice-card" 
                      style="padding:10px; border:1px solid #ccc; border-radius:8px; cursor:pointer;"
                      data-q="${i}" 
                      data-choice="${String.fromCharCode(65 + idx)}"
                      data-section="grammar"
                      data-selected="false"
                    >${String.fromCharCode(65 + idx)}. ${c}</div>
                  `).join("")}
                 </div>`
              : `<input class="grammar-input" data-q="${i}" placeholder="å…¥åŠ›ã—ã¦ãã ã•ã„" style="width:100%; padding:8px;">`}
          </div>`;
      });
    } else if (section === "Reading") {
      activity.readingQuestions.forEach((r, i) => {
        html += `<div class="card" style="padding:12px; margin-bottom:8px;"><h3>è‹±æ–‡${i + 1}</h3><p class="activity-question-text">${r.text}</p>`;
        r.subquestions.forEach((sq, j) => {
          html += `
            <div class="card" style="margin:8px 0; padding:8px;">
              <p class="activity-question-text">${j + 1}. ${sq.question}</p>
              ${sq.type === "multiple"
                ? `<div class="choice-grid" style="display:grid; gap:8px; grid-template-columns:1fr 1fr;">
                    ${sq.choices.map((c, idx) => `
                      <div class="choice-card" 
                        style="padding:10px; border:1px solid #ccc; border-radius:8px; cursor:pointer;"
                        data-q="${i}_${j}" 
                        data-choice="${String.fromCharCode(65 + idx)}"
                        data-section="reading"
                        data-selected="false"
                      >${String.fromCharCode(65 + idx)}. ${c}</div>
                    `).join("")}
                  </div>`
                : `<input class="reading-input" data-q="${i}_${j}" placeholder="å…¥åŠ›ã—ã¦ãã ã•ã„" style="width:100%; padding:8px;">`}
            </div>`;
        });
        html += `</div>`;
      });
    }

    html += `
      <div style="display:flex; justify-content:space-between; margin-top:16px;">
        <button id="btn-prev" ${currentIndex === 0 ? "disabled" : ""}>â† æˆ»ã‚‹</button>
        <button id="btn-next">${currentIndex === sections.length - 1 ? "æå‡ºã™ã‚‹" : "æ¬¡ã¸ â†’"}</button>
      </div></div>`;

    // æç”»
    content.innerHTML = html;

    // å¾©å…ƒï¼ˆãƒšãƒ¼ã‚¸ã«å­˜åœ¨ã™ã‚‹è¦ç´ ã«å¯¾ã—ã¦ï¼‰
    restorePageSelections(section);

    // ãƒœã‚¿ãƒ³æ“ä½œï¼ˆä¿å­˜ã—ã¦ã‹ã‚‰ãƒšãƒ¼ã‚¸ç§»å‹•ï¼‰
    document.getElementById("btn-prev").addEventListener("click", () => {
      saveCurrentPageAnswers(section); // ä¿å­˜
      if (currentIndex > 0) currentIndex--;
      renderPage();
    });

    document.getElementById("btn-next").addEventListener("click", async () => {
      // æ¬¡ã¸ or æå‡ºå‰ã«ç¾åœ¨ãƒšãƒ¼ã‚¸ã‚’ä¿å­˜
      saveCurrentPageAnswers(section);

      if (currentIndex < sections.length - 1) {
        currentIndex++;
        renderPage();
      } else {
        // æœ€çµ‚ãƒšãƒ¼ã‚¸ã®ä¿å­˜ãŒçµ‚ã‚ã£ãŸ answersTemp ã‚’ä½¿ã£ã¦ submit
        await submitActivityWithTemp(activityId, activity, answersTemp);
      }
    });

    // é¸æŠè‚¢ã‚¯ãƒªãƒƒã‚¯ï¼ˆã‚«ãƒ¼ãƒ‰é¸æŠå¼ï¼‰ â€” dataset.selected ç®¡ç† + UIè‰²å¤‰æ›´
    document.querySelectorAll(".choice-card").forEach(card => {
      card.addEventListener("click", () => {
        const qId = card.dataset.q;
        const sectionAttr = card.dataset.section;
        // åŒã˜å•é¡Œã®é¸æŠè‚¢ã ã‘ãƒªã‚»ãƒƒãƒˆï¼ˆsectionã§é™å®šï¼‰
        document.querySelectorAll(`.choice-card[data-section="${sectionAttr}"][data-q="${qId}"]`).forEach(c => {
          c.dataset.selected = "false";
          c.style.background = "#fff";
        });
        // é¸æŠã—ãŸã‚«ãƒ¼ãƒ‰ã ã‘é’
        card.dataset.selected = "true";
        card.style.background = "#d0f0ff";
      });
    });
  }; // renderPage end

  renderPage();
}

// ================================
// ğŸ§­ æå‡ºï¼ˆanswersTemp ã‚’å—ã‘å–ã‚‹ãƒ©ãƒƒãƒ‘ãƒ¼ï¼‰
// ================================
async function submitActivityWithTemp(activityId, activity, temp) {
  // temp ã¯ answersTempï¼ˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå½¢å¼ï¼‰
  // Firestore ã«ä¿å­˜ã™ã‚‹é…åˆ—å½¢å¼ã«å¤‰æ›ã™ã‚‹
  const answersForSave = {
    vocab: [],
    grammar: [],
    reading: [],
    submittedAt: serverTimestamp(),
    userId: currentUser?.id || "unknown"
  };

  // convert vocab
  Object.keys(temp.vocab).forEach(q => {
    answersForSave.vocab.push({ q: q, choice: temp.vocab[q] });
  });

  // convert grammar (could be choice or text)
  Object.keys(temp.grammar).forEach(q => {
    const v = temp.grammar[q];
    if (typeof v === "string" && v.length === 1 && /^[A-Z]$/.test(v)) {
      answersForSave.grammar.push({ q: q, choice: v });
    } else {
      answersForSave.grammar.push({ q: q, answer: v });
    }
  });

  // convert reading
  Object.keys(temp.reading).forEach(k => {
    const v = temp.reading[k];
    if (typeof v === "string" && v.length === 1 && /^[A-Z]$/.test(v)) {
      answersForSave.reading.push({ q: k, choice: v });
    } else {
      answersForSave.reading.push({ q: k, answer: v });
    }
  });

  try {
    await addDoc(collection(db, "activity_submissions"), {
      activityId,
      userId: currentUser?.id,
      answers: answersForSave,
      submittedAt: serverTimestamp()
    });

    alert("âœ… ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’æå‡ºã—ã¾ã—ãŸï¼");

    // è©³ç´°ç”»é¢
      document.getElementById("content").innerHTML = `
  <div class="card" style="
      max-width: 600px;
      margin: 60px auto;
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      text-align: center;
  ">
    <h2 style="margin-bottom: 16px;">æå‡ºå®Œäº†ï¼</h2>
    <p style="margin-bottom: 32px;">ãŠç–²ã‚Œã•ã¾ã§ã—ãŸï¼</p>

    <button id="btn-detail" style="
        padding: 14px 28px;
        border-radius: 12px;
        border: none;
        background: #4A90E2;
        color: white;
        font-size: 16px;
        cursor: pointer;
        transition: 0.2s;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    ">
      ãã‚ã—ãè¦‹ã‚‹
    </button>
  </div>
`;

document.getElementById("btn-detail").addEventListener("click", () => {
  renderActivityResult(activityId, answersForSave, activity);
});

// é€ä¿¡å¾Œã€answersTemp ã‚’ã‚¯ãƒªã‚¢ï¼ˆå¿…è¦ãªã‚‰æ®‹ã™ï¼‰
answersTemp.vocab = {};
answersTemp.grammar = {};
answersTemp.reading = {};

  } catch (err) {
    console.error(err);
    alert("âŒ æå‡ºã«å¤±æ•—ã—ã¾ã—ãŸ: " + err.message);
  }
}

// ================================
// ğŸ§­ çµæœè©³ç´°
// ================================
const style = document.createElement("style");
style.textContent = `
  .modern-btn {
    padding: 10px 18px;
    background: #4a90e2;
    color: #fff;
    border: none;
    border-radius: 10px;
    font-size: 16px;
    cursor: pointer;
    box-shadow: 0 2px 5px rgba(0,0,0,0.15);
    transition: 0.2s;
  }
  .modern-btn:hover {
    background: #6ab0ff;
  }
  .modern-btn-secondary {
    padding: 10px 18px;
    background: #ccc;
    color: #333;
    border: none;
    border-radius: 10px;
    font-size: 16px;
    cursor: pointer;
    box-shadow: 0 2px 5px rgba(0,0,0,0.15);
    transition: 0.2s;
  }
  .modern-btn-secondary:hover {
    background: #e2e2e2;
  }
`;
document.head.appendChild(style);

function renderActivityResult(activityId, answers, activity) {
  const content = document.getElementById("content");

  let html = `<div class="card"><h2>çµæœã®è©³ç´°</h2>`;

  // Vocabulary
  html += `<h3>Vocabulary</h3>`;
  activity.vocabQuestions.forEach((q, i) => {
    const userAns = answers.vocab.find(a => Number(a.q) === i)?.choice || "æœªè§£ç­”";
    const correct = q.answer;

    html += `
      <div class="card" style="padding:12px; margin:8px 0;">
        <p style="white-space:pre-wrap;">${i + 1}. ${q.question}</p>
        <div style="margin-left:12px;">
          ${q.choices.map((c, idx) => {
            const letter = String.fromCharCode(65 + idx);
            return `<div>${letter}. ${c}</div>`;
          }).join("")}
        </div>
        <p><strong>ã‚ãªãŸã®ç­”ãˆï¼š</strong> ${userAns}</p>
        <p><strong>æ­£ã—ã„ç­”ãˆï¼š</strong> ${correct}</p>
      </div>`;
  });

  // Grammar
  html += `<h3>Grammar</h3>`;
  activity.grammarQuestions.forEach((q, i) => {
    const userChoice = answers.grammar.find(a => Number(a.q) === i && a.choice)?.choice;
    const userText = answers.grammar.find(a => Number(a.q) === i && a.answer)?.answer;
    const userAns = userChoice || userText || "æœªè§£ç­”";
    const correct = q.answer;

    html += `
      <div class="card" style="padding:12px; margin:8px 0;">
        <p style="white-space:pre-wrap;">${i + 1}. ${q.question}</p>
    `;

    if (q.type === "multiple") {
      html += `<div style="margin-left:12px;">
        ${q.choices.map((c, idx) => {
          const letter = String.fromCharCode(65 + idx);
          return `<div>${letter}. ${c}</div>`;
        }).join("")}
      </div>`;
    }

    html += `
        <p><strong>ã‚ãªãŸã®ç­”ãˆï¼š</strong> ${userAns}</p>
        <p><strong>æ­£ã—ã„ç­”ãˆï¼š</strong> ${correct}</p>
      </div>`;
  });

  // Reading
  html += `<h3>Reading</h3>`;
  activity.readingQuestions.forEach((r, i) => {
    html += `<div class="card" style="padding:12px; margin:8px 0;">
      <h4>è‹±æ–‡${i + 1}</h4>
      <p style="white-space:pre-wrap;">${r.text}</p>`;

    r.subquestions.forEach((sq, j) => {
      const key = `${i}_${j}`;
      const userChoice = answers.reading.find(a => a.q === key && a.choice)?.choice;
      const userText = answers.reading.find(a => a.q === key && a.answer)?.answer;
      const userAns = userChoice || userText || "æœªè§£ç­”";
      const correct = sq.answer;

      html += `
        <div class="card" style="padding:8px; margin:8px 0;">
          <p style="white-space:pre-wrap;">${j + 1}. ${sq.question}</p>
      `;

      if (sq.type === "multiple") {
        html += `<div style="margin-left:12px;">
          ${sq.choices.map((c, idx) => {
            const letter = String.fromCharCode(65 + idx);
            return `<div>${letter}. ${c}</div>`;
          }).join("")}
        </div>`;
      }

      html += `
          <p><strong>ã‚ãªãŸã®ç­”ãˆï¼š</strong> ${userAns}</p>
          <p><strong>æ­£ã—ã„ç­”ãˆï¼š</strong> ${correct}</p>
        </div>`;
    });

    html += `</div>`;
  });

  // ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹ï¼ˆãƒ¢ãƒ€ãƒ³ãƒœã‚¿ãƒ³ï¼‰
  html += `
    <button id="btn-home" class="modern-btn-secondary" style="margin-top:20px;">ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
  </div>`;

  content.innerHTML = html;

  //
  document.getElementById("btn-home").addEventListener("click", () => {
    renderHome();
  });
}


// ================================
// ğŸ§­ æå‡ºå¾Œã®ã€Œãã‚ã—ãè¦‹ã‚‹ã€ãƒœã‚¿ãƒ³ã‚‚ãƒ¢ãƒ€ãƒ³ã«
// ================================
async function submitActivity(activityId, activity) {
  const answers = {
    vocab: [],
    grammar: [],
    reading: [],
    submittedAt: serverTimestamp(),
    userId: currentUser?.id || "unknown"
  };

  // æ—¢å­˜ã®å›ç­”å‡¦ç†ï¼ˆçœç•¥ï¼‰â€¦

  document.getElementById("content").innerHTML = `
    <div class="card">
      <h2>æå‡ºå®Œäº†ï¼</h2>
      <p>ãŠç–²ã‚Œã•ã¾ã§ã—ãŸï¼</p>
      <button id="btn-detail" class="modern-btn" style="margin-top:20px;">ãã‚ã—ãè¦‹ã‚‹</button>
    </div>
  `;

  document.getElementById("btn-detail").addEventListener("click", () => {
    renderActivityResult(activityId, answers, activity);
  });
}












/* ===========================
   ç¤¾ä¼šï¼šå•é¡Œç®¡ç†ï¼ˆå¹´å·ãƒ†ã‚¹ãƒˆï¼‰æ©Ÿèƒ½
   =========================== */

// --- ãƒ˜ãƒ«ãƒ‘: ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ï¼ˆè¡¨ç¤ºç”¨ï¼‰ ---
function escHtml(s){
  if(s === null || s === undefined) return '';
  return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}

// --- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚¯ãƒªãƒƒã‚¯ç™»éŒ²ï¼ˆmenu-socials ãŒæ—¢ã«ã‚ã‚‹æƒ³å®šï¼‰ ---
const menuSocials = document.getElementById('menu-socials');
if(menuSocials){
  menuSocials.addEventListener('click', renderSocialsAdmin);
}

// --- ãƒ«ãƒ¼ãƒˆæç”»: ç¤¾ä¼šã®ç®¡ç†ç”»é¢ï¼ˆã‚«ãƒ¼ãƒ‰è¡¨ç¤ºï¼‰ ---
function renderSocialsAdmin(){
  const content = document.getElementById('content');
  content.innerHTML = `
    <div class="card">
      <h2>ç¤¾ä¼š â€” å•é¡Œç®¡ç†</h2>
      <p style="color:#666;margin-bottom:12px;">å·¦ã‹ã‚‰ã€Œå¹´å·ãƒ†ã‚¹ãƒˆã€ã€Œä¸€å•ä¸€ç­”ã€ã€Œè¨˜è¿°ç‰¹è¨“ã€ã€‚å¹´å·ãƒ†ã‚¹ãƒˆã¨ä¸€å•ä¸€ç­”ã®ä½œæˆãƒ»ç·¨é›†æ©Ÿèƒ½ã‚’æä¾›ã—ã¾ã™ã€‚</p>

      <div style="display:flex;gap:16px;flex-wrap:wrap;">
        <!-- å¹´å·ãƒ†ã‚¹ãƒˆ -->
        <div class="card" style="flex:1;min-width:260px;">
          <h3>å¹´å·ãƒ†ã‚¹ãƒˆ</h3>
          <p>ä½œæˆ / ç·¨é›† / ä¸€è¦§</p>
          <div style="display:flex;gap:8px;margin-top:8px;">
            <button id="btn-year-create" class="btn-plain btn-primary">æ–°è¦ä½œæˆ</button>
            <button id="btn-year-list" class="btn-plain">ä¸€è¦§ãƒ»ç·¨é›†</button>
          </div>
        </div>

        <!-- ä¸€å•ä¸€ç­” -->
        <div class="card" style="flex:1;min-width:260px;">
          <h3>ä¸€å•ä¸€ç­”</h3>
          <p>ä½œæˆ / ç·¨é›† / ä¸€è¦§</p>
          <div style="display:flex;gap:8px;margin-top:8px;">
            <button id="btn-ichimon-create" class="btn-plain btn-primary">æ–°è¦ä½œæˆ</button>
            <button id="btn-ichimon-list" class="btn-plain">ä¸€è¦§ãƒ»ç·¨é›†</button>
          </div>
        </div>

        <!-- è¨˜è¿°ç‰¹è¨“ -->
        <div class="card" style="flex:1;min-width:260px;">
          <h3>è¨˜è¿°ç‰¹è¨“</h3>
          <p>ï¼ˆæœªå®Ÿè£… â€” å¾Œã§è¿½åŠ ã—ã¾ã™ï¼‰</p>
          <div style="margin-top:8px;">
            <button class="btn-plain" disabled>ä½œæˆï¼ˆæœªå®Ÿè£…ï¼‰</button>
            <button class="btn-plain" disabled>ä¸€è¦§ï¼ˆæœªå®Ÿè£…ï¼‰</button>
          </div>
        </div>
      </div>

      <div id="social-admin-area" style="margin-top:16px;"></div>
    </div>
  `;

  // === ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ² ===
  // å¹´å·ãƒ†ã‚¹ãƒˆ
  document.getElementById('btn-year-create').addEventListener('click', renderYearCreateForm);
  document.getElementById('btn-year-list').addEventListener('click', renderYearList);

  // ä¸€å•ä¸€ç­”
  document.getElementById('btn-ichimon-create').addEventListener('click', renderIchimonCreateForm);
  document.getElementById('btn-ichimon-list').addEventListener('click', renderIchimonList);
}


// --- å¹´å·ãƒ†ã‚¹ãƒˆï¼šä½œæˆãƒ•ã‚©ãƒ¼ãƒ ã‚’æç”» ---
function renderYearCreateForm(editDoc = null) {
  // editDoc ãŒã‚ã‚‹å ´åˆã®ã¿ data ã‚’å‚ç…§
  const isEdit = !!editDoc;
  const data = editDoc?.data || {};
  const q = data.question || '';
  const year = data.year || '';
  const score = data.score || 1;

  const area = document.getElementById('social-admin-area');

  area.innerHTML = `
    <div class="card">
      <h3>${isEdit ? 'å¹´å·ãƒ†ã‚¹ãƒˆï¼šç·¨é›†' : 'å¹´å·ãƒ†ã‚¹ãƒˆï¼šæ–°è¦ä½œæˆ'}</h3>
      <div style="display:flex;flex-direction:column;gap:10px;margin-top:12px;">
        <label>å•é¡Œæ–‡</label>
        <textarea id="yt-question" style="width:100%; min-height:120px; padding:10px; font-size:15px;">${escHtml(q)}</textarea>

        <label>ç­”ãˆï¼ˆå¹´å·ï¼‰</label>
        <input id="yt-year" type="text" style="width:100%; padding:10px; font-size:15px;" value="${escHtml(year)}">

        <label>é…ç‚¹</label>
        <input id="yt-score" type="number" min="0" step="1" style="width:120px; padding:8px;" value="${escHtml(score)}">

        <div style="display:flex;gap:8px;">
          <button id="yt-save-btn" class="btn-plain btn-primary">${isEdit ? 'æ›´æ–°ã—ã¦ä¿å­˜' : 'ä¿å­˜'}</button>
          <button id="yt-cancel-btn" class="btn-plain">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
      </div>
    </div>
  `;

  // ã‚¤ãƒ™ãƒ³ãƒˆ
  document.getElementById('yt-cancel-btn').addEventListener('click', () => {
    document.getElementById('social-admin-area').innerHTML = '';
  });

  document.getElementById('yt-save-btn').addEventListener('click', async () => {
    const question = document.getElementById('yt-question').value.trim();
    const answerYear = document.getElementById('yt-year').value.trim();
    const scoreVal = parseInt(document.getElementById('yt-score').value, 10) || 0;

    if (!question || !answerYear) {
      alert('å•é¡Œæ–‡ã¨ç­”ãˆï¼ˆå¹´å·ï¼‰ã¯å¿…é ˆã§ã™ã€‚');
      return;
    }

    try {
      if (isEdit && editDoc?.id) {
        // update
        const docRef = doc(db, 'social_year_questions', editDoc.id);
        await updateDoc(docRef, {
          question,
          year: answerYear,
          score: scoreVal,
          updatedAt: serverTimestamp()
        });
        alert('æ›´æ–°ã—ã¾ã—ãŸ');
      } else {
        // create new
        await addDoc(collection(db, 'social_year_questions'), {
          question,
          year: answerYear,
          score: scoreVal,
          createdBy: currentUser?.id || null,
          createdAt: serverTimestamp()
        });
        alert('ä¿å­˜ã—ã¾ã—ãŸ');
      }
      await renderYearList();
    } catch (err) {
      console.error(err);
      alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (err.message || err));
    }
  });
}

// --- å¹´å·ãƒ†ã‚¹ãƒˆï¼šä¸€è¦§ã¨æ¤œç´¢ï¼ˆç·¨é›†ãƒœã‚¿ãƒ³ã‚’å«ã‚€ï¼‰ ---
async function renderYearList() {
  const area = document.getElementById('social-admin-area');
  area.innerHTML = `
    <div class="card">
      <h3>å¹´å·ãƒ†ã‚¹ãƒˆ å•é¡Œä¸€è¦§ãƒ»ç·¨é›†</h3>
      <div style="display:flex;gap:8px;margin-top:8px;align-items:center;">
        <input id="yt-search" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ï¼ˆå•é¡Œæ–‡ã«éƒ¨åˆ†ä¸€è‡´ï¼‰" style="flex:1;padding:8px;">
        <button id="yt-search-btn" class="btn-plain btn-primary">æ¤œç´¢</button>
        <button id="yt-refresh-btn" class="btn-plain">æœ€æ–°ã‚’èª­ã¿è¾¼ã¿</button>
        <button id="yt-new-btn" class="btn-plain" style="margin-left:8px;">æ–°è¦ä½œæˆ</button>
      </div>
      <div id="yt-list" style="margin-top:12px;"></div>
    </div>
  `;

  document.getElementById('yt-new-btn').addEventListener('click', () => renderYearCreateForm());
  document.getElementById('yt-refresh-btn').addEventListener('click', () => loadAndShowYearQuestions());
  document.getElementById('yt-search-btn').addEventListener('click', () => loadAndShowYearQuestions(document.getElementById('yt-search').value.trim()));

  // initial
  await loadAndShowYearQuestions();
}

// --- ãƒ‡ãƒ¼ã‚¿å–å¾—ã¨æç”»ï¼ˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«ã‚ˆã‚‹éƒ¨åˆ†ä¸€è‡´ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ãƒ•ã‚£ãƒ«ã‚¿ï¼‰ ---
async function loadAndShowYearQuestions(keyword = '') {
  const listEl = document.getElementById('yt-list');
  listEl.innerHTML = `<div style="color:#666">èª­ã¿è¾¼ã¿ä¸­...</div>`;
  try {
    const qSnap = await getDocs(collection(db, 'social_year_questions'));
    const docs = qSnap.docs.map(d => ({ id: d.id, ...d.data() }));

    // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§éƒ¨åˆ†ä¸€è‡´ãƒ•ã‚£ãƒ«ã‚¿
    const filtered = keyword ? docs.filter(d => (d.question || '').toLowerCase().includes(keyword.toLowerCase())) : docs;

    if (filtered.length === 0) {
      listEl.innerHTML = `<div style="color:#666;padding:12px;border:1px dashed #eef3f5;border-radius:8px">è©²å½“ã™ã‚‹å•é¡Œã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
      return;
    }

    let html = `<div style="display:flex;flex-direction:column;gap:8px;">`;
    filtered.forEach(item => {
      html += `
        <div style="display:flex;justify-content:space-between;gap:12px;align-items:flex-start;padding:12px;border:1px solid #eef3f5;border-radius:8px;background:#fff;">
          <div style="flex:1;">
            <div style="font-weight:700;margin-bottom:6px;">${escHtml(item.question)}</div>
            <div style="font-size:14px;color:#666;">ç­”ãˆ: <strong>${escHtml(String(item.year))}</strong> ãƒ» é…ç‚¹: ${escHtml(String(item.score || 0))}</div>
            <div style="font-size:12px;color:#999;margin-top:6px;">ä½œæˆè€…: ${escHtml(item.createdBy || '-')}${item.createdAt ? ' â€¢ ' + new Date(item.createdAt.seconds ? item.createdAt.seconds*1000 : item.createdAt).toLocaleString() : ''}</div>
          </div>
          <div style="display:flex;flex-direction:column;gap:6px;">
            <button class="btn-plain btn-edit-year" data-id="${item.id}">ç·¨é›†</button>
            <button class="btn-plain btn-danger btn-del-year" data-id="${item.id}">å‰Šé™¤</button>
          </div>
        </div>
      `;
    });
    html += `</div>`;
    listEl.innerHTML = html;

    // attach edit/delete handlers
    listEl.querySelectorAll('.btn-edit-year').forEach(b => {
      b.addEventListener('click', async (e) => {
        const id = e.currentTarget.dataset.id;
        const docSnap = await getDoc(doc(db, 'social_year_questions', id));
        if(!docSnap.exists()){
          alert('è©²å½“ã®å•é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          return;
        }
        renderYearCreateForm({ id, data: docSnap.data() });
      });
    });

    listEl.querySelectorAll('.btn-del-year').forEach(b => {
      b.addEventListener('click', async (e) => {
        const id = e.currentTarget.dataset.id;
        if(!confirm('ã“ã®å•é¡Œã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
        try {
          await deleteDoc(doc(db, 'social_year_questions', id));
          alert('å‰Šé™¤ã—ã¾ã—ãŸ');
          await loadAndShowYearQuestions(document.getElementById('yt-search').value.trim());
        } catch(err) {
          console.error(err);
          alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (err.message || err));
        }
      });
    });

  } catch(err) {
    console.error(err);
    listEl.innerHTML = `<div style="color:#c00">å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${escHtml(err.message || err)}</div>`;
  }
}




// ==========================
// ä¸€å•ä¸€ç­”ï¼šå•é¡Œä½œæˆãƒ•ã‚©ãƒ¼ãƒ 
function renderIchimonCreateForm(editData) {
  const area = document.getElementById("social-admin-area");

  const isEdit = editData && editData.id;
  const data = editData?.data || {};

  area.innerHTML = `
    <div class="card">
      <h3>ä¸€å•ä¸€ç­” â€” ${isEdit ? 'å•é¡Œç·¨é›†' : 'å•é¡Œä½œæˆ'}</h3>
      <p style="color:#666;margin-bottom:12px;">
        å•é¡Œæ–‡ãƒ»ç­”ãˆï¼ˆè¤‡æ•°å¯ï¼‰ãƒ»åˆ¥è§£ãƒ»ã‚¹ã‚³ã‚¢ãƒ»ã‚¯ãƒ©ã‚¹ãƒ»ãƒ¬ãƒ™ãƒ«ã‚’å…¥åŠ›ã—ã¦ä¿å­˜ã—ã¾ã™ã€‚
      </p>

      <label>ã‚¯ãƒ©ã‚¹</label><br>
      <input id="ichimon-class" type="text" style="width:200px;margin-bottom:12px;" value="${data.class || ''}">

      <label>ãƒ¬ãƒ™ãƒ«</label><br>
      <select id="ichimon-level" style="width:120px;margin-bottom:12px;">
        <option value="A" ${data.level === 'A' ? 'selected' : ''}>A</option>
        <option value="B" ${data.level === 'B' ? 'selected' : ''}>B</option>
        <option value="C" ${data.level === 'C' ? 'selected' : ''}>C</option>
      </select>

      <label>å•é¡Œæ–‡</label><br>
      <textarea id="ichimon-question" style="width:100%;height:100px;margin-bottom:12px;">${data.question || ''}</textarea>

      <label>ç­”ãˆï¼ˆãƒ¡ã‚¤ãƒ³ã¨åˆ¥è§£ã‚’è¿½åŠ å¯èƒ½ï¼‰</label>
      <div id="ichimon-answers" style="margin-bottom:12px;"></div>
      <button id="add-answer" class="btn-plain" style="margin-bottom:12px;">ï¼‹ ç­”ãˆã‚’è¿½åŠ </button>

      <label>ã‚¹ã‚³ã‚¢</label><br>
      <input id="ichimon-score" type="number" style="width:100px;margin-bottom:16px;" value="${data.score || 1}">

      <div style="display:flex;gap:8px;">
        <button id="save-ichimon" class="btn-plain btn-primary">${isEdit ? 'æ›´æ–°' : 'ä¿å­˜'}</button>
        <button id="back-to-socials" class="btn-plain">æˆ»ã‚‹</button>
      </div>
    </div>
  `;

  const answersDiv = document.getElementById("ichimon-answers");

  // æ—¢å­˜ã®ç­”ãˆãŒã‚ã‚‹å ´åˆã¯è¿½åŠ 
  if (data.answers?.length) {
    data.answers.forEach(ansObj => addAnswerField(ansObj.main, ansObj.alternatives || []));
  } else {
    addAnswerField();
  }

  document.getElementById("add-answer").addEventListener("click", () => addAnswerField());
  document.getElementById("back-to-socials").addEventListener("click", renderSocialsAdmin);

  // --- ç­”ãˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ  ---
  function addAnswerField(mainValue = "", altValues = []) {
    const idx = answersDiv.children.length + 1;
    const wrapper = document.createElement("div");
    wrapper.style.marginBottom = "12px";
    wrapper.innerHTML = `
      <label>ç­”ãˆ ${idx}ï¼š</label><br>
      <input type="text" class="ichimon-main-answer" placeholder="ãƒ¡ã‚¤ãƒ³ç­”ãˆ" style="width:60%;" value="${mainValue}">
      <button class="btn-plain btn-delete-answer">å‰Šé™¤</button>
      <div class="alt-answers" style="margin-top:4px; margin-left:16px;"></div>
      <button class="btn-plain btn-add-alt">ï¼‹ åˆ¥è§£ã‚’è¿½åŠ </button>
    `;
    answersDiv.appendChild(wrapper);

    const altDiv = wrapper.querySelector(".alt-answers");

    // æ—¢å­˜ã®åˆ¥è§£ãŒã‚ã‚‹å ´åˆã¯è¿½åŠ 
    altValues.forEach(v => addAltField(v));

    // å‰Šé™¤ãƒœã‚¿ãƒ³
    wrapper.querySelector(".btn-delete-answer").addEventListener("click", () => {
      wrapper.remove();
      Array.from(answersDiv.children).forEach((c, i) => {
        c.querySelector("label").innerText = "ç­”ãˆ " + (i + 1) + "ï¼š";
      });
    });

    // åˆ¥è§£è¿½åŠ ãƒœã‚¿ãƒ³
    wrapper.querySelector(".btn-add-alt").addEventListener("click", () => addAltField());

    function addAltField(value = "") {
      const altWrapper = document.createElement("div");
      altWrapper.style.marginBottom = "4px";
      altWrapper.innerHTML = `
        <input type="text" class="ichimon-alt-answer" placeholder="åˆ¥è§£" style="width:50%;" value="${value}">
        <button class="btn-plain btn-delete-alt">å‰Šé™¤</button>
      `;
      altDiv.appendChild(altWrapper);

      altWrapper.querySelector(".btn-delete-alt").addEventListener("click", () => altWrapper.remove());
    }
  }

  // --- ä¿å­˜/æ›´æ–° ---
  document.getElementById("save-ichimon").addEventListener("click", async () => {
    const ichimonClass = document.getElementById("ichimon-class").value.trim();
    const level = document.getElementById("ichimon-level").value;
    const question = document.getElementById("ichimon-question").value.trim();
    const score = Number(document.getElementById("ichimon-score").value);

    // answersã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§å–å¾—
    const answers = Array.from(answersDiv.children).map(wrapper => {
      const main = wrapper.querySelector(".ichimon-main-answer")?.value.trim();
      const alternatives = Array.from(wrapper.querySelectorAll(".ichimon-alt-answer"))
        .map(a => a.value.trim())
        .filter(a => a);
      return main ? { main, alternatives } : null;
    }).filter(a => a);

    if (!question || answers.length === 0) {
      alert("å•é¡Œæ–‡ã¨ç­”ãˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
      return;
    }

    try {
      if (isEdit) {
        await updateDoc(doc(db, "ichimon_questions", editData.id), {
          class: ichimonClass || "",
          level,
          question,
          answers,
          score,
        });
        alert("æ›´æ–°ã—ã¾ã—ãŸï¼");
      } else {
        await addDoc(collection(db, "ichimon_questions"), {
          class: ichimonClass || "",
          level,
          question,
          answers,
          score,
          createdAt: serverTimestamp(),
        });
        alert("ä¿å­˜ã—ã¾ã—ãŸï¼");
      }
      renderSocialsAdmin();
    } catch (err) {
      console.error(err);
      alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
    }
  });
}


// ==========================
// ä¸€å•ä¸€ç­”ï¼šä¸€è¦§ãƒ»ç·¨é›†ç”»é¢ 
// ==========================
async function renderIchimonList() {
  const area = document.getElementById('social-admin-area');
  area.innerHTML = `
    <div class="card">
      <h3>ä¸€å•ä¸€ç­” å•é¡Œä¸€è¦§ãƒ»ç·¨é›†</h3>
      <div style="display:flex;gap:8px;margin-top:8px;align-items:center;">
        <input id="ichimon-search" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢" style="flex:1;padding:8px;">
        <button id="ichimon-search-btn" class="btn-plain btn-primary">æ¤œç´¢</button>
        <button id="ichimon-refresh-btn" class="btn-plain">æœ€æ–°ã‚’èª­ã¿è¾¼ã¿</button>
        <button id="ichimon-new-btn" class="btn-plain" style="margin-left:8px;">æ–°è¦ä½œæˆ</button>
      </div>
      <div id="ichimon-list" style="margin-top:12px;"></div>
    </div>
  `;

  document.getElementById('ichimon-new-btn').addEventListener('click', () => renderIchimonCreateForm());
  document.getElementById('ichimon-refresh-btn').addEventListener('click', () => loadAndShowIchimonQuestions());
  document.getElementById('ichimon-search-btn').addEventListener('click', () => {
    const keyword = document.getElementById('ichimon-search').value.trim();
    loadAndShowIchimonQuestions(keyword);
  });

  await loadAndShowIchimonQuestions();
}

// --- ãƒ‡ãƒ¼ã‚¿å–å¾—ã¨æç”»ï¼ˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«ã‚ˆã‚‹éƒ¨åˆ†ä¸€è‡´ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ãƒ•ã‚£ãƒ«ã‚¿ï¼‰ ---
async function loadAndShowIchimonQuestions(keyword = '') {
  const listEl = document.getElementById('ichimon-list');
  listEl.innerHTML = `<div style="color:#666">èª­ã¿è¾¼ã¿ä¸­...</div>`;
  try {
    const qSnap = await getDocs(collection(db, 'ichimon_questions'));
    const docs = qSnap.docs.map(d => ({ id: d.id, ...d.data() }));

    const filtered = keyword
      ? docs.filter(d => {
          const qMatch = (d.question || '').toLowerCase().includes(keyword.toLowerCase());
          const aMatch = (d.answers || []).some(a => {
            // æ—§å½¢å¼æ–‡å­—åˆ—ã‹æ–°å½¢å¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚’åˆ¤å®š
            if (typeof a === "string") return a.toLowerCase().includes(keyword.toLowerCase());
            const main = a.main || "";
            const alts = Array.isArray(a.alternatives) ? a.alternatives : [];
            return main.toLowerCase().includes(keyword.toLowerCase()) || alts.some(alt => alt.toLowerCase().includes(keyword.toLowerCase()));
          });
          return qMatch || aMatch;
        })
      : docs;

    if (filtered.length === 0) {
      listEl.innerHTML = `
        <div style="color:#666;padding:12px;border:1px dashed #eef3f5;border-radius:8px">
          è©²å½“ã™ã‚‹å•é¡Œã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
        </div>
      `;
      return;
    }

    const displayAnswer = (a) => {
      if (!a) return "";
      if (typeof a === "string") return escHtml(a); // æ—§å½¢å¼å¯¾å¿œ
      const main = a.main || "";
      const alts = Array.isArray(a.alternatives) ? a.alternatives : [];
      return escHtml(main + (alts.length ? " (" + alts.join(", ") + ")" : ""));
    };

    let html = `<div style="display:flex;flex-direction:column;gap:8px;">`;
    filtered.forEach(item => {
      html += `
        <div style="display:flex;justify-content:space-between;gap:12px;align-items:flex-start;
                    padding:12px;border:1px solid #eef3f5;border-radius:8px;background:#fff;">
          <div style="flex:1;">
            <div style="font-weight:700;margin-bottom:6px;">${escHtml(item.question)}</div>
            <div style="font-size:14px;color:#666;margin-bottom:2px;">
              ç­”ãˆ: <strong>${
                (item.answers || []).map(displayAnswer).join(", ")
              }</strong>
            </div>
            <div style="font-size:14px;color:#666;margin-bottom:2px;">
              é…ç‚¹: ${escHtml(String(item.score || 0))} ãƒ» ãƒ¬ãƒ™ãƒ«: ${escHtml(item.level || '-')}
            </div>
            <div style="font-size:13px;color:#666;margin-bottom:2px;">
              ã‚¯ãƒ©ã‚¹: <strong>${escHtml(item.class || '-')}</strong>
            </div>
            <div style="font-size:12px;color:#999;margin-top:6px;">
              ä½œæˆè€…: ${escHtml(item.createdBy || '-')}${item.createdAt ? ' â€¢ ' + new Date(item.createdAt.seconds ? item.createdAt.seconds*1000 : item.createdAt).toLocaleString() : ''}
            </div>
          </div>
          <div style="display:flex;flex-direction:column;gap:6px;">
            <button class="btn-plain btn-edit-ichimon" data-id="${item.id}">ç·¨é›†</button>
            <button class="btn-plain btn-danger btn-del-ichimon" data-id="${item.id}">å‰Šé™¤</button>
          </div>
        </div>
      `;
    });
    html += `</div>`;
    listEl.innerHTML = html;

    // ç·¨é›†ãƒœã‚¿ãƒ³
    listEl.querySelectorAll('.btn-edit-ichimon').forEach(b => {
      b.addEventListener('click', async (e) => {
        const id = e.currentTarget.dataset.id;
        const docSnap = await getDoc(doc(db, 'ichimon_questions', id));
        if (!docSnap.exists()) {
          alert('è©²å½“ã®å•é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          return;
        }
        renderIchimonCreateForm({ id, data: docSnap.data() });
      });
    });

    // å‰Šé™¤ãƒœã‚¿ãƒ³
    listEl.querySelectorAll('.btn-del-ichimon').forEach(b => {
      b.addEventListener('click', async (e) => {
        const id = e.currentTarget.dataset.id;
        if (!confirm('ã“ã®å•é¡Œã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
        try {
          await deleteDoc(doc(db, 'ichimon_questions', id));
          alert('å‰Šé™¤ã—ã¾ã—ãŸ');
          await loadAndShowIchimonQuestions(document.getElementById('ichimon-search').value.trim());
        } catch (err) {
          console.error(err);
          alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (err.message || err));
        }
      });
    });

  } catch (err) {
    console.error(err);
    listEl.innerHTML = `<div style="color:#c00">å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${escHtml(err.message || err)}</div>`;
  }
}

// ç¤¾ä¼šä¸€å•ä¸€ç­”ç¯„å›²é¸æŠç”»é¢ 
function renderIchimonTrainingSetup() {
  const area = document.getElementById("content");

  const levels = ["A", "B", "C"];
  const counts = [10, 20, 30];

  const subjectRanges = {
    geography: ["ä¸–ç•Œåœ°å›³","æ—¥æœ¬åœ°ç†","ä¸–ç•Œã®æ°—å€™","ã‚¢ã‚¸ã‚¢ãƒ»ã‚ªã‚»ã‚¢ãƒ‹ã‚¢","ãƒ¨ãƒ¼ãƒ­ãƒƒãƒ‘","ã‚¢ãƒ•ãƒªã‚«","åŒ—å—ç±³","å…¨ç¯„å›²"],
    history: ["åŸå§‹","å¤ä»£","ä¸­ä¸–","è¿‘ä¸–","è¿‘ä»£","ç¾ä»£","å…¨ç¯„å›²"],
    civics: ["ç¾ä»£ç¤¾ä¼š","æ—¥æœ¬å›½æ†²æ³•","ç«‹æ³•ãƒ»è¡Œæ”¿ãƒ»å¸æ³•","åœ°æ–¹è‡ªæ²»","å®¶è¨ˆã¨ä¼æ¥­","é‡‘èã¨çµŒæ¸ˆ","ç¤¾ä¼šç¦ç¥‰","å…¨ç¯„å›²"]
  };

  area.innerHTML = `
  <div class="card" style="max-width:900px;margin:40px auto;padding:32px;text-align:center;">
    <h2 style="margin-bottom:32px;">ä¸€å•ä¸€ç­” ç‰¹è¨“ç¯„å›²ãƒ»ãƒ¬ãƒ™ãƒ«è¨­å®š</h2>
    <div id="mastery-bars" style="margin-bottom:24px;"></div>


    <div style="display:flex; align-items:center; justify-content:flex-start; gap:12px; margin-bottom:24px;">
      <h3 style="margin:0;">å‡ºé¡Œç¯„å›²ã‚’é¸æŠã—ã¦ãã ã•ã„</h3>
      <select id="subject-select" style="
        padding:8px 12px; 
        border-radius:12px; 
        border:2px solid #ccc; 
        font-size:16px; 
        cursor:pointer;
      ">
        <option value="geography" selected>åœ°ç†</option>
        <option value="history">æ­´å²</option>
        <option value="civics">å…¬æ°‘</option>
      </select>
    </div>

    <div id="range-selection" style="display:flex;flex-wrap:wrap;gap:16px;justify-content:center;margin:24px 0;"></div>

    <h3 style="text-align:left;">ãƒ¬ãƒ™ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</h3>
    <div id="level-selection" style="display:flex;gap:16px;justify-content:center;margin:24px 0;"></div>

    <h3 style="text-align:left;">å‡ºé¡Œæ•°ã‚’é¸æŠã—ã¦ãã ã•ã„</h3>
    <div id="count-selection" style="display:flex;gap:16px;justify-content:center;margin:24px 0;"></div>

    <div style="margin-top:32px;">
      <button id="start-ichimon-test" class="btn-plain btn-primary" style="padding:12px 28px;font-size:18px;">ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã™ã‚‹</button>
      <button id="ichimon-back" class="btn-plain" style="padding:12px 28px;font-size:18px;">æˆ»ã‚‹</button>
    </div>
  </div>
  `;

  const rangeDiv = document.getElementById("range-selection");
  const levelDiv = document.getElementById("level-selection");
  const countDiv = document.getElementById("count-selection");
  const subjectSelect = document.getElementById("subject-select");

  function renderRangeCards(subject) {
    rangeDiv.innerHTML = "";
    subjectRanges[subject].forEach(r => {
      const card = document.createElement("div");
      card.innerText = r;
      Object.assign(card.style, {
        padding: "16px 0",
        border: "2px solid #ccc",
        borderRadius: "12px",
        cursor: "pointer",
        fontSize: "18px",
        width: "240px",
        textAlign: "center",
      });
      card.addEventListener("click", () => {
        card.classList.toggle("selected");
        card.style.background = card.classList.contains("selected") ? "#fff9b0" : "white";
        card.style.borderColor = card.classList.contains("selected") ? "#f5e663" : "#ccc";
      });
      rangeDiv.appendChild(card);
    });
  }

  renderRangeCards("geography");

  subjectSelect.addEventListener("change", () => {
    renderRangeCards(subjectSelect.value);
  });

  levels.forEach(l => {
    const card = document.createElement("div");
    card.innerText = l;
    Object.assign(card.style, {
      padding: "16px 44px",
      border: "2px solid #ccc",
      borderRadius: "12px",
      cursor: "pointer",
      fontSize: "20px",
    });
    card.addEventListener("click", () => {
      Array.from(levelDiv.children).forEach(c => {
        c.classList.remove("selected");
        c.style.background = "white";
        c.style.borderColor = "#ccc";
      });
      card.classList.add("selected");
      card.style.background = "#fff9b0";
      card.style.borderColor = "#f5e663";
    });
    levelDiv.appendChild(card);
  });

  counts.forEach(n => {
    const card = document.createElement("div");
    card.innerText = n + "å•";
    Object.assign(card.style, {
      padding: "16px 44px",
      border: "2px solid #ccc",
      borderRadius: "12px",
      cursor: "pointer",
      fontSize: "20px",
    });
    card.addEventListener("click", () => {
      Array.from(countDiv.children).forEach(c => {
        c.classList.remove("selected");
        c.style.background = "white";
        c.style.borderColor = "#ccc";
      });
      card.classList.add("selected");
      card.style.background = "#fff9b0";
      card.style.borderColor = "#f5e663";
    });
    countDiv.appendChild(card);
  });

  document.getElementById("ichimon-back").addEventListener("click", renderTestMenu);

  document.getElementById("start-ichimon-test").addEventListener("click", () => {
    const selectedRanges = Array.from(rangeDiv.children)
      .filter(c => c.classList.contains("selected"))
      .map(c => c.innerText);

    const selectedLevel = Array.from(levelDiv.children)
      .find(c => c.classList.contains("selected"))?.innerText;

    const selectedCountText = Array.from(countDiv.children)
      .find(c => c.classList.contains("selected"))?.innerText;

    if (selectedRanges.length === 0) return alert("å‡ºé¡Œç¯„å›²ã‚’1ã¤ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„ã€‚");
    if (!selectedLevel) return alert("ãƒ¬ãƒ™ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
    if (!selectedCountText) return alert("å‡ºé¡Œæ•°ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");

    const countNumber = Number(selectedCountText.replace("å•", ""));

    startIchimonTest(selectedRanges, selectedLevel, countNumber);
  });
renderMasteryBars();
}



// ================================
// ç¿’å¾—ç®¡ç†ç”¨ å®šç¾©
// ================================
const subjectClassesMap = {
  geography: ["ä¸–ç•Œåœ°å›³","æ—¥æœ¬åœ°ç†","ä¸–ç•Œã®æ°—å€™","ã‚¢ã‚¸ã‚¢ãƒ»ã‚ªã‚»ã‚¢ãƒ‹ã‚¢","ãƒ¨ãƒ¼ãƒ­ãƒƒãƒ‘","ã‚¢ãƒ•ãƒªã‚«","åŒ—å—ç±³"],
  history: ["åŸå§‹","å¤ä»£","ä¸­ä¸–","è¿‘ä¸–","è¿‘ä»£","ç¾ä»£"],
  civics: ["ç¾ä»£ç¤¾ä¼š","æ—¥æœ¬å›½æ†²æ³•","ç«‹æ³•ãƒ»è¡Œæ”¿ãƒ»å¸æ³•","åœ°æ–¹è‡ªæ²»","å®¶è¨ˆã¨ä¼æ¥­","é‡‘èã¨çµŒæ¸ˆ","ç¤¾ä¼šç¦ç¥‰"]
};

// â˜… ç·å•é¡Œæ•°
const TOTAL_QUESTION_COUNT = {
  geography: 471,
  history: 609,
  civics: 0
};

function getSubjectByClass(cls) {
  for (const subject in subjectClassesMap) {
    if (subjectClassesMap[subject].includes(cls)) return subject;
  }
  return null;
}

// ================================
// ç¿’å¾—ç‡ãƒãƒ¼æç”»
// ================================
async function renderMasteryBars() {
  const uid = currentUser ? currentUser.id : "guest";
  const barArea = document.getElementById("mastery-bars");
  if (!barArea) return;

  barArea.innerHTML = "";

  // é€²æ—
  const pSnap = await getDocs(query(
    collection(db, "ichimon_progress"),
    where("uid", "==", uid)
  ));

  // subjectåˆ¥ã« mastered æ•°ã‚’é›†è¨ˆ
  const masteredCount = {
    geography: 0,
    history: 0,
    civics: 0
  };

  pSnap.forEach(d => {
    const data = d.data();
    if (data.mastered && masteredCount[data.subject] !== undefined) {
      masteredCount[data.subject]++;
    }
  });

  for (const subject of ["geography","history","civics"]) {
    const total = TOTAL_QUESTION_COUNT[subject];
    const mastered = masteredCount[subject];
    const rate = total === 0 ? 0 : Math.round((mastered / total) * 100);

    const label =
      subject === "geography" ? "åœ°ç†" :
      subject === "history" ? "æ­´å²" : "å…¬æ°‘";

    barArea.innerHTML += `
      <div style="margin-bottom:12px;text-align:left;">
        <b>${label}ï¼š${rate}%</b>
        <div style="width:100%;height:14px;background:#eee;border-radius:7px;">
          <div style="width:${rate}%;height:100%;background:#fff3a0;border-radius:7px;"></div>
        </div>
      </div>
    `;
  }
}

// ================================
// ä¸€å•ä¸€ç­” ç¿’å¾—é€²æ—ä¿å­˜
// ================================
async function updateIchimonProgress(question, isCorrect) {
  const uid = currentUser ? currentUser.id : "guest";
  const subject = getSubjectByClass(question.class);
  if (!subject) return; // å…¨ç¯„å›²ã¯ç„¡è¦–

  const ref = doc(db, "ichimon_progress", `${uid}_${question.id}`);
  const snap = await getDoc(ref);

  let streak = 0;
  let mastered = false;

  if (snap.exists()) {
    streak = snap.data().streak || 0;
  }

  if (isCorrect) {
    streak++;
    if (streak >= 3) mastered = true;
  } else {
    streak = 0;
    mastered = false;
  }

  await setDoc(ref, {
    uid,
    questionId: question.id,
    subject,
    class: question.class,
    streak,
    mastered,
    updatedAt: new Date()
  });
}




// ç¤¾ä¼šä¸€å•ä¸€ç­”ãƒ†ã‚¹ãƒˆå®Ÿæ–½ç”»é¢ //
let currentIchimonTest = null;

async function loadIchimonQuestions(selectedRanges, selectedLevel, limitCount) {
  let allowedLevels = [];
  if (selectedLevel === "A") allowedLevels = ["A"];
  if (selectedLevel === "B") allowedLevels = ["B"];
  if (selectedLevel === "C") allowedLevels = ["C"];

  const q = query(
    collection(db, "ichimon_questions"),
    where("class", "in", selectedRanges),
    where("level", "in", allowedLevels)
  );

  const snapshot = await getDocs(q);
  let questions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
  questions = questions.sort(() => Math.random() - 0.5);
  return questions.slice(0, limitCount);
}

// ãƒ†ã‚¹ãƒˆé–‹å§‹
async function startIchimonTest(selectedRanges, selectedLevel, questionCount) {
  const questionList = await loadIchimonQuestions(selectedRanges, selectedLevel, questionCount);
  if (questionList.length === 0) {
    alert("æŒ‡å®šã—ãŸç¯„å›²ãƒ»ãƒ¬ãƒ™ãƒ«ã®å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
    return;
  }

  currentIchimonTest = {
    questions: questionList,
    index: 0,
    correct: 0,
    userAnswers: []
  };

  renderIchimonTestQuestion();
}


// ======================================================
// å•é¡Œè¡¨ç¤º
// ======================================================
function renderIchimonTestQuestion() {
  const area = document.getElementById("content");
  const test = currentIchimonTest;
  const q = test.questions[test.index];

  let answerFields = "";
  q.answers.forEach((_, i) => {
    answerFields += `
      <div style="margin-bottom:12px;">
        <label>ï¼ˆ${i + 1}ï¼‰</label>
        <input id="ichimon-answer-${i}" class="input"
          style="
            width:80%;
            height:40px;
            margin-top:4px;
            padding:6px 8px;
            border-radius:12px;
            border:2px solid #ccc;
            font-size:16px;
            outline:none;
            box-shadow:none;
            white-space: pre-wrap;
          ">
      </div>
    `;
  });

  area.innerHTML = `
    <div class="card" style="position:relative; padding:32px;">
      <h2>ç¬¬ ${test.index + 1} å• / ${test.questions.length}</h2>
      <div style="margin-top:20px;font-size:20px; white-space: pre-wrap;">${q.question}</div>

      <div id="answer-area" style="margin-top:24px;">
        ${answerFields}
      </div>

      <div style="text-align:left;margin-top:32px;">
        <button id="ichimon-next" class="btn-primary"
          style="padding:14px 36px; font-size:18px; border-radius:12px;">
          ç­”ãˆåˆã‚ã›
        </button>
      </div>

      <div id="correct-answer"
        style="margin-top:12px; color:red; font-size:20px; font-weight:bold;"></div>

      <div id="popup-judge"
        style="
          position:absolute;
          top:50%; left:50%;
          transform:translate(-50%, -50%);
          font-size:120px;
          font-weight:bold;
          display:none;
          pointer-events:none;
          z-index:999;">
      </div>
    </div>
  `;

  document.getElementById("ichimon-next").onclick = checkIchimonAnswer;
}

// ======================================================
// ç­”ãˆåˆã‚ã›ï¼ˆåˆ¥è§£å¯¾å¿œæ¸ˆã¿ï¼‰
// ======================================================
function checkIchimonAnswer() {
  const test = currentIchimonTest;
  const q = test.questions[test.index];

  let isAllCorrect = true;
  const userAnsList = [];

  q.answers.forEach((ansObj, i) => {
    const val = document.getElementById(`ichimon-answer-${i}`).value.trim();
    userAnsList.push(val);

    // ansObjãŒæ–‡å­—åˆ—ã‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹åˆ¤å®š
    let validAnswers = [];
    if (typeof ansObj === "string") {
      validAnswers = [ansObj];
    } else {
      validAnswers = [ansObj.main, ...(Array.isArray(ansObj.alternatives) ? ansObj.alternatives : [])];
    }

    const matched = validAnswers.some(a => a.toLowerCase() === val.toLowerCase());
    if (!matched) isAllCorrect = false;
  });

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼è§£ç­”ã‚’ä¿å­˜ï¼ˆæ–‡å­—åˆ—åŒ–ã—ã¦è¡¨ç¤ºç”¨ã«åŠ å·¥ï¼‰
  const correctAnswerText = q.answers.map(ansObj => {
    if (typeof ansObj === "string") return ansObj;
    const alts = Array.isArray(ansObj.alternatives) ? ansObj.alternatives : [];
    return ansObj.main + (alts.length ? " (" + alts.join(", ") + ")" : "");
  });

  test.userAnswers[test.index] = {
  question: q.question,           // â† è¿½åŠ ï¼šå•é¡Œæ–‡
  userAnswer: userAnsList,        // â† yourAnswer â†’ userAnswer ã«å¤‰æ›´
  correctAnswer: correctAnswerText,
  isCorrect: isAllCorrect,
  score: isAllCorrect ? (q.score || 0) : 0
};
  renderIchimonJudge();
  document.getElementById("ichimon-next").style.display = "none";
  updateIchimonProgress(q, isAllCorrect);

}

// ======================================================
// â—‹Ã—è¡¨ç¤º + æ¬¡ã¸
// ======================================================
function renderIchimonJudge() {
  const test = currentIchimonTest;
  const ua = test.userAnswers[test.index];
  const popup = document.getElementById("popup-judge");
  const correctArea = document.getElementById("correct-answer");

  // ã€‡Ã—ã‚’ä¸­å¤®ã«è¡¨ç¤º
  popup.innerText = ua.isCorrect ? "â­•" : "âŒ";
  popup.style.color = ua.isCorrect ? "green" : "red";
  popup.style.display = "block";
  popup.style.opacity = "1";
  popup.style.transition = "opacity 0.5s ease-out";

  setTimeout(() => {
    popup.style.opacity = "0";
    setTimeout(() => popup.style.display = "none", 500);
  }, 1000);

  // æ­£ç­”è¡¨ç¤º
  correctArea.innerText = "æ­£ã—ã„ç­”ãˆ: " + ua.correctAnswer.join(" / ");

  if (ua.isCorrect) test.correct++;

  // æ¬¡ã¸ãƒœã‚¿ãƒ³
  let nextBtn = document.getElementById("next-btn");
  if (!nextBtn) {
    nextBtn = document.createElement("button");
    nextBtn.id = "next-btn";
    nextBtn.innerText = "æ¬¡ã¸";
    Object.assign(nextBtn.style, {
      marginTop: "16px",
      padding: "10px 28px",
      fontSize: "16px",
      borderRadius: "12px",
      cursor: "pointer",
      display: "block"
    });
    document.querySelector(".card").appendChild(nextBtn);
  }

  nextBtn.onclick = () => {
    test.index++;
    if (test.index >= test.questions.length) {
      renderIchimonResult();
    } else {
      renderIchimonTestQuestion();
    }
  };
}

// ======================================================
// ============================================
// Firestore ã«ä¸€å•ä¸€ç­”çµæœã‚’ä¿å­˜ã™ã‚‹é–¢æ•°
// ============================================
async function saveIchimonResult(test) {
  try {
    const uid = currentUser ? currentUser.id : 'guest';

    const answersRecord = test.userAnswers.map(a => ({
      question: a.question || "",
      userAnswer: a.userAnswer || "",
      correctAnswer: a.correctAnswer || "",
      score: a.score || 0
    }));

    await addDoc(collection(db, "results"), {
      uid,
      type: "ä¸€å•ä¸€ç­”",
      testType: "soichimon",
      score: test.correct,
      totalScore: test.userAnswers.reduce((s, a) => s + (a?.score || 0), 0),
      totalQuestions: test.questions.length,
      answers: answersRecord,
      createdAt: new Date()
    });

    console.log("ğŸ”¥ ä¸€å•ä¸€ç­”çµæœã‚’ Firestore ã«ä¿å­˜ã—ã¾ã—ãŸ");
  } catch (err) {
    console.error("saveIchimonResult error", err);
  }
}

// ============================================
// çµæœç”»é¢
// ============================================
function renderIchimonResult() {
  const area = document.getElementById("content");
  const test = currentIchimonTest;

  // çµæœã‚’ Firestore ã«ä¿å­˜
  saveIchimonResult(test);

  const totalScore = test.userAnswers.reduce((s, a) => s + (a?.score || 0), 0);

  area.innerHTML = `
    <div class="card" style="padding:32px; border:none; box-shadow:none; text-align:center;">
      <h2>çµæœ</h2>

      <div style="font-size:24px; margin-top:20px;">
        æ­£è§£æ•°ï¼š${test.correct} / ${test.questions.length}
      </div>

      <div style="font-size:24px; margin-top:12px; color:#333;">
        ã‚¹ã‚³ã‚¢ï¼š${totalScore}
      </div>

      <div style="display:flex; gap:16px; justify-content:center; margin-top:24px; flex-wrap:wrap;">
        <button id="ichimon-detail" class="btn-primary"
          style="padding:14px 36px; font-size:18px; border-radius:12px;">
          ãã‚ã—ãè¦‹ã‚‹
        </button>

        <button id="ichimon-restart" class="btn-primary"
          style="padding:14px 36px; font-size:18px; border-radius:12px;">
          ã‚‚ã†ä¸€åº¦
        </button>

        <button id="ichimon-home" class="btn-primary"
          style="padding:14px 36px; font-size:18px; border-radius:12px;">
          ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹
        </button>
      </div>
    </div>
  `;

  // BNP åŠ ç®—
  try {
    if (typeof addBnp === 'function') {
      addBnp(totalScore);
      console.log("BNP ã«ã‚¹ã‚³ã‚¢ã‚’åŠ ç®—ã—ã¾ã—ãŸ:", totalScore);
    } else {
      console.warn("addBnpãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
    }
  } catch (e) {
    console.warn("BNPã‚¨ãƒ©ãƒ¼:", e);
  }

  // ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
  document.getElementById("ichimon-detail").addEventListener("click", renderIchimonDetail);
  document.getElementById("ichimon-restart").addEventListener("click", () => {
    renderIchimonTrainingSetup();
  });
  document.getElementById("ichimon-home").addEventListener("click", () => {
    renderHome();
  });
}

// ============================================
// ãã‚ã—ãè¦‹ã‚‹ç”»é¢
// ============================================
function renderIchimonDetail() {
  const area = document.getElementById("content");
  const test = currentIchimonTest;

  let cards = "";

  test.questions.forEach((q, i) => {
    const ua = test.userAnswers[i];
    const bg = ua.isCorrect ? "#d8f5d0" : "#f8d0d0";

    cards += `
      <div class="card" style="padding:20px; margin-bottom:16px; background:${bg}; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.1);">
        <h3 style="margin-bottom:12px;">ç¬¬ ${i + 1} å•</h3>

        <div style="margin-bottom:12px; padding:8px; background:#ffffff; border-radius:8px; box-shadow:inset 0 1px 3px rgba(0,0,0,0.1); white-space: pre-wrap;">
          <b>å•é¡Œï¼š</b><br>
          <span style="font-size:16px; line-height:1.5;">${q.question}</span>
        </div>

        <div style="margin-bottom:8px; padding:8px; background:#f0f8ff; border-radius:8px; box-shadow:inset 0 1px 3px rgba(0,0,0,0.1); white-space: pre-wrap;">
          <b>ã‚ãªãŸã®è§£ç­”ï¼š</b><br>
          <span style="font-size:16px; line-height:1.5;">${ua.userAnswer.join(" / ")}</span>
        </div>

        <div style="margin-bottom:8px; padding:8px; background:#fff8f8; border-radius:8px; box-shadow:inset 0 1px 3px rgba(0,0,0,0.1); white-space: pre-wrap;">
          <b>æ­£è§£ï¼š</b><br>
          <span style="font-size:16px; line-height:1.5;">${ua.correctAnswer.join(" / ")}</span>
        </div>

        <div style="margin-top:8px; font-weight:bold;">
          ã‚¹ã‚³ã‚¢ï¼š${ua.score} ç‚¹
        </div>
      </div>
    `;
  });

  area.innerHTML = `
    <div class="card" style="padding:32px;">
      <h2>ãã‚ã—ãè¦‹ã‚‹</h2>
      <div style="margin-top:20px;">
        ${cards}
      </div>

      <div style="margin-top:24px; display:flex; justify-content:center;">
        <button id="detail-back" class="btn-primary"
          style="padding:14px 36px; font-size:18px; border-radius:12px;">
          çµæœã«æˆ»ã‚‹
        </button>
      </div>
    </div>
  `;

  document.getElementById("detail-back").addEventListener("click", renderIchimonResult);
}








    // ===== ãƒ†ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆé››å½¢ï¼‰ =====
// ===== ãƒ†ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆãƒ”ãƒ³ã‚¯æ ãƒ»æ¨ªä¸€åˆ—ç‰ˆï¼‰ =====
function renderTestMenu() {
  document.getElementById('content').innerHTML = `
    <div class="card test-main-card">
      <h2 class="test-title">è‹±èª</h2>

      <div class="test-card-row">
        <div class="test-card">
          <h3>é€Ÿèª­åŠ›æ¸¬å®šãƒ†ã‚¹ãƒˆ</h3>
          <button class="btn-plain btn-primary" id="start-speed">ãƒ†ã‚¹ãƒˆã‚’å§‹ã‚ã‚‹</button>
        </div>

        <div class="test-card">
          <h3>æ–‡æ³•ç‰¹è¨“</h3>
          <button class="btn-plain btn-primary" id="start-grammar">ç‰¹è¨“é–‹å§‹</button>
        </div>

        <div class="test-card">
          <h3>å˜èªãƒ†ã‚¹ãƒˆ</h3>
          <button class="btn-plain btn-primary" id="start-wordtest">ãƒ†ã‚¹ãƒˆã‚’å§‹ã‚ã‚‹</button>
        </div>
      </div>
    </div>

<!-- å›½èªã‚«ãƒ¼ãƒ‰ç¾¤ -->
<div class="card test-main-card japanese-card">
  <h2 class="test-title">å›½èª</h2>

  <div class="test-card-row">
    <div class="test-card">
      <h3>æ¼¢å­—ãƒ†ã‚¹ãƒˆ</h3>
      <button class="btn-plain btn-primary" id="start-kanji">ãƒ†ã‚¹ãƒˆã‚’å§‹ã‚ã‚‹</button>
    </div>

    <div class="test-card">
      <h3>èªå½™åŠ›ç‰¹è¨“</h3>
      <button class="btn-plain btn-primary" id="start-vocab">ç‰¹è¨“é–‹å§‹</button>
    </div>

    <div class="test-card">
      <h3>å¤æ–‡å˜èªãƒ†ã‚¹ãƒˆ</h3>
      <button class="btn-plain btn-primary" id="start-kobun">ãƒ†ã‚¹ãƒˆã‚’å§‹ã‚ã‚‹</button>
    </div>
  </div>
</div>

<!-- ç¤¾ä¼šã‚«ãƒ¼ãƒ‰ç¾¤ -->
<div class="card test-main-card social-card">
  <h2 class="test-title">ç¤¾ä¼š</h2>

  <div class="test-card-row">
    <div class="test-card">
      <h3>å¹´å·ãƒ†ã‚¹ãƒˆ</h3>
      <button class="btn-plain btn-primary" id="start-nen">ãƒ†ã‚¹ãƒˆã‚’å§‹ã‚ã‚‹</button>
    </div>

    <div class="test-card">
      <h3>ä¸€å•ä¸€ç­”</h3>
      <button class="btn-plain btn-primary" id="start-ichimon">ç‰¹è¨“é–‹å§‹</button>
    </div>

    <div class="test-card">
      <h3>è¨˜è¿°ç‰¹è¨“</h3>
      <button class="btn-plain btn-primary" id="start-kijutsu">ç‰¹è¨“é–‹å§‹</button>
    </div>
  </div>
</div>

<!-- ç†ç§‘ã‚«ãƒ¼ãƒ‰ç¾¤ -->
<div class="card test-main-card science-card">
  <h2 class="test-title">ç†ç§‘</h2>

  <div class="test-card-row">
    <div class="test-card">
      <h3>ä¸€å•ä¸€ç­”</h3>
      <button class="btn-plain btn-primary" id="start-science-ichimon">æŒ‘æˆ¦ã™ã‚‹</button>
    </div>

    <div class="test-card">
      <h3>ï¼Ÿï¼Ÿï¼Ÿ</h3>
      <button class="btn-plain btn-primary" id="start-science-q2">ï¼Ÿï¼Ÿï¼Ÿé–‹å§‹</button>
    </div>

    <div class="test-card">
      <h3>ï¼Ÿï¼Ÿï¼Ÿ</h3>
      <button class="btn-plain btn-primary" id="start-science-q3">ï¼Ÿï¼Ÿï¼Ÿé–‹å§‹</button>
    </div>
  </div>
</div>

  `;

  // ã‚¹ã‚¿ã‚¤ãƒ«è¿½åŠ  
const styleTag = document.createElement('style');
styleTag.innerHTML = `
  /* === å…¨ä½“ã‚«ãƒ¼ãƒ‰ === */
  .test-main-card {
    position: relative; /* ä¸‰è§’å½¢ */
    max-width: 1200px;
    margin: 40px auto;
    padding-top: 6px;  
    padding-bottom: 20px;
    padding-left: 24px;
    padding-right: 24px;
    background: #fff; /* èƒŒæ™¯*/
    border: 3px solid #ccc; /* æ ç·š */
    border-radius: 20px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    height: 265px;
    overflow: hidden; /* ä¸‰è§’å½¢ã¯ã¿å‡ºã•ãªã„ */
  }

  /* å·¦ä¸Šã¨å³ä¸‹ã®è–„ãƒ”ãƒ³ã‚¯ä¸‰è§’å½¢ */
  .test-main-card::before,
  .test-main-card::after {
    content: '';
    position: absolute;
    width: 0;
    height: 0;
    border-style: solid;
    z-index: 1;
  }

  .test-main-card::before {
    top: 0;
    left: 0;
    border-width: 60px 60px 0 0;
    border-color: #ffeef2 transparent transparent transparent;
  }

  .test-main-card::after {
    bottom: 0;
    right: 0;
    border-width: 0 0 60px 60px;
    border-color: transparent transparent #ffeef2 transparent;
  }

  /* === ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆä¸Šå¯„ã›ãƒ»å¤ªããƒ»ãƒ¢ãƒ€ãƒ³ãƒ•ã‚©ãƒ³ãƒˆï¼‰ === */
  .test-title {
    text-align: left;
    font-size: 36px;
    color: #f5b5c5; /* â† æ–‡å­—è‰² */
    margin-top: 0;    
    margin-left: 10px;
    margin-bottom: 16px;  
    font-weight: 800;     
    font-family: 'Poppins', 'Noto Sans JP', sans-serif;
    line-height: 1.2;
    padding-left: 50px;
  }

  /* === 3ã‚«ãƒ¼ãƒ‰æ¨ªä¸¦ã³ === */
  .test-card-row {
    display: flex;
    justify-content: center;
    align-items: stretch;
    gap: 24px;
    flex-wrap: nowrap;
  }

  /* === å„ã‚«ãƒ¼ãƒ‰ === */
  .test-card {
    flex: 1 1 280px;
    max-width: 300px;
    background: white;
    border: 2px solid #f5b5c5;
    border-radius: 16px;
    padding: 28px 16px;
    text-align: center;
    box-shadow: 0 4px 8px rgba(0,0,0,0.08);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .test-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.15);
  }

  .test-card h3 {
    font-size: 20px;
    margin-bottom: 16px;
    color: #333;
    font-weight: 600;
  }

  .test-card button {
  font-size: 17px;
  padding: 12px 32px;
  border-radius: 8px;
  background-color: #f5b5c5; /* è–„ã„ãƒ”ãƒ³ã‚¯ */
  color: #fff; /* èª­ã¿ã‚„ã™ã„æ¿ƒã„ã‚ã®æ–‡å­—è‰² */
  border: 2px solid #ccc; /* ã‚°ãƒ¬ãƒ¼ã®æ ç·š */
  cursor: pointer;
  transition: background 0.2s ease, transform 0.2s ease;
}

.test-card button:hover {
  background-color: #f7c4d1; /* ã»ã‚“ã®å°‘ã—æ˜ã‚‹ã„ãƒ”ãƒ³ã‚¯ã«å¤‰åŒ– */
  transform: translateY(-2px); /* ã‚¯ãƒªãƒƒã‚¯æ„Ÿã‚’å‡ºã™ */
}
/* === å›½èªã‚«ãƒ¼ãƒ‰ç¾¤ï¼ˆã‚ªãƒ¬ãƒ³ã‚¸ï¼‰ === */
.japanese-card::before,
.japanese-card::after {
  content: '';
  position: absolute;
  width: 0;
  height: 0;
  border-style: solid;
  z-index: 1;
}

.japanese-card::before {
  top: 0;
  left: 0;
  border-width: 60px 60px 0 0;
  border-color: #fff6e5 transparent transparent transparent;
}

.japanese-card::after {
  bottom: 0;
  right: 0;
  border-width: 0 0 60px 60px;
  border-color: transparent transparent #fff6e5 transparent;
}

/* å›½èªã‚¿ã‚¤ãƒˆãƒ«ã¯è–„ã‚ªãƒ¬ãƒ³ã‚¸ */
.japanese-card .test-title {
  color: #f7cfa0;
}

/* å›½èªã‚«ãƒ¼ãƒ‰å†…ã®æ ç·šã¯è–„ã‚ªãƒ¬ãƒ³ã‚¸ */
.japanese-card .test-card {
  border: 2px solid #f7cfa0;
}

/* å›½èªãƒœã‚¿ãƒ³ï¼ˆè–„ã‚ªãƒ¬ãƒ³ã‚¸ç³»ï¼‰ */
.japanese-card .test-card button {
  font-size: 17px;
  padding: 12px 32px;
  border-radius: 8px;
  background-color: #f7cfa0;
  color: #fff;
  border: 2px solid #ccc;
  cursor: pointer;
  transition: background 0.2s ease, transform 0.2s ease;
}

.japanese-card .test-card button:hover {
  background-color: #f9dcb5;
  transform: translateY(-2px);
}

/* === ç¤¾ä¼šã‚«ãƒ¼ãƒ‰ç¾¤ï¼ˆè–„ã„é»„è‰²ï¼‰ === */
.social-card::before,
.social-card::after {
  content: '';
  position: absolute;
  width: 0;
  height: 0;
  border-style: solid;
  z-index: 1;
}

.social-card::before {
  top: 0;
  left: 0;
  border-width: 60px 60px 0 0;
  border-color: #fffbe0 transparent transparent transparent;
}

.social-card::after {
  bottom: 0;
  right: 0;
  border-width: 0 0 60px 60px;
  border-color: transparent transparent #fffbe0 transparent;
}

/* ç¤¾ä¼šã‚¿ã‚¤ãƒˆãƒ«ã¯è–„ã„é»„è‰² */
.social-card .test-title {
  color: #f9e58a;
}

/* ç¤¾ä¼šã‚«ãƒ¼ãƒ‰å†…ã®æ ç·šã¯è–„ã„é»„è‰² */
.social-card .test-card {
  border: 2px solid #f9e58a;
}

/* ç¤¾ä¼šãƒœã‚¿ãƒ³ï¼ˆè–„é»„è‰²ç³»ï¼‰ */
.social-card .test-card button {
  font-size: 17px;
  padding: 12px 32px;
  border-radius: 8px;
  background-color: #f9e58a;
  color: #fff;
  border: 2px solid #ccc;
  cursor: pointer;
  transition: background 0.2s ease, transform 0.2s ease;
}

.social-card .test-card button:hover {
  background-color: #faec9e;
  transform: translateY(-2px);
}

/* === ç†ç§‘ã‚«ãƒ¼ãƒ‰ç¾¤ï¼ˆè–„ã„ç·‘ï¼‰ === */
.science-card::before,
.science-card::after {
  content: '';
  position: absolute;
  width: 0;
  height: 0;
  border-style: solid;
  z-index: 1;
}

.science-card::before {
  top: 0;
  left: 0;
  border-width: 60px 60px 0 0;
  border-color: #edfff0 transparent transparent transparent;
}

.science-card::after {
  bottom: 0;
  right: 0;
  border-width: 0 0 60px 60px;
  border-color: transparent transparent #edfff0 transparent;
}

/* ç†ç§‘ã‚¿ã‚¤ãƒˆãƒ«ã¯è–„ç·‘ */
.science-card .test-title {
  color: #a3e6b1;
}

/* ç†ç§‘ã‚«ãƒ¼ãƒ‰å†…ã®æ ç·šã¯è–„ç·‘ */
.science-card .test-card {
  border: 2px solid #a3e6b1;
}

/* ç†ç§‘ãƒœã‚¿ãƒ³ï¼ˆè–„ç·‘ç³»ï¼‰ */
.science-card .test-card button {
  font-size: 17px;
  padding: 12px 32px;
  border-radius: 8px;
  background-color: #a3e6b1;
  color: #fff;
  border: 2px solid #ccc;
  cursor: pointer;
  transition: background 0.2s ease, transform 0.2s ease;
}

.science-card .test-card button:hover {
  background-color: #b5ecc0;
  transform: translateY(-2px);
}


`;
document.head.appendChild(styleTag);



// ==========================
// ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ç™»éŒ²
// ==========================

// è‹±èªãƒ†ã‚¹ãƒˆç³»
const startBtn = document.getElementById('start-speed');
if (startBtn) startBtn.addEventListener('click', async () => {
    if (confirm('ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã—ã¾ã™ã€‚åˆ¶é™æ™‚é–“ã¯15åˆ†ã§ã™ã€‚')) await startTest();
});

const grammarBtn = document.getElementById('start-grammar');
if (grammarBtn) grammarBtn.addEventListener('click', async () => {
    if (confirm('æ–‡æ³•ç‰¹è¨“ã‚’é–‹å§‹ã—ã¾ã™ã€‚50å•é€£ç¶šã§å‡ºé¡Œã•ã‚Œã¾ã™ã€‚')) {
        await startGrammarTraining();
    }
});

const wordtestBtn = document.getElementById('start-wordtest');
if (wordtestBtn) wordtestBtn.addEventListener('click', renderWordTestMenu);


// ç¤¾ä¼šãƒ†ã‚¹ãƒˆç³»ï¼š
const nenBtn = document.getElementById('start-nen');
if (nenBtn) {
    nenBtn.addEventListener('click', () => {
        renderNenSetup();
    });
}

const ichimonBtn = document.getElementById('start-ichimon');
if (ichimonBtn) {
    ichimonBtn.addEventListener('click', () => {
        renderIchimonTrainingSetup();
    });
}
}


//// ---------------------------
// å¹´å·ãƒ†ã‚¹ãƒˆç¯„å›²è¨­å®šç”»é¢
// ---------------------------
function renderNenSetup() {
    const content = document.getElementById('content'); // ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„é ˜åŸŸ
    content.innerHTML = `
        <div class="card" style="max-width:600px; margin:50px auto; padding:32px; text-align:center; box-shadow:0 4px 12px rgba(0,0,0,0.1); border-radius:16px;">
            <h2 style="margin-bottom:24px; font-size:1.8em; color:#333;">å¹´å·ãƒ†ã‚¹ãƒˆ ç¯„å›²è¨­å®š</h2>
            
            <div style="display:flex; justify-content:center; align-items:center; gap:12px; margin-bottom:32px; font-size:1.2em;">
                <label></label>
                <input type="number" id="nen-start" placeholder="" style="width:140px; padding:14px; border-radius:10px; border:1px solid #ccc; text-align:center; font-size:1.2em;">
                <span>ï½</span>
                <input type="number" id="nen-end" placeholder="" style="width:140px; padding:14px; border-radius:10px; border:1px solid #ccc; text-align:center; font-size:1.2em;">
            </div>

            <div style="margin-bottom:32px;">
                <label style="display:block; margin-bottom:12px; font-weight:600;">å•é¡Œæ•°ã‚’é¸æŠï¼š</label>
                <button class="btn-num" data-num="10" style="background-color:white; color:#333; padding:16px 32px; border-radius:12px; border:2px solid #ccc; margin-right:12px; font-size:1.2em; cursor:pointer;">10å•</button>
                <button class="btn-num" data-num="20" style="background-color:white; color:#333; padding:16px 32px; border-radius:12px; border:2px solid #ccc; margin-right:12px; font-size:1.2em; cursor:pointer;">20å•</button>
                <button class="btn-num" data-num="30" style="background-color:white; color:#333; padding:16px 32px; border-radius:12px; border:2px solid #ccc; font-size:1.2em; cursor:pointer;">30å•</button>
            </div>

            <div style="display:flex; justify-content:center; gap:16px;">
                <button id="start-nen-test" style="
                    background-color:#fff4b8; 
                    color:#333; 
                    font-size:1.2em; 
                    padding:12px 32px; 
                    border:none; 
                    border-radius:12px; 
                    cursor:pointer;
                    transition:0.2s;
                ">
                    ã¯ã˜ã‚ã‚‹
                </button>

                <button id="back-to-main" style="
                    background-color:#e0e0e0;
                    color:#333;
                    font-size:1.2em;
                    padding:12px 32px;
                    border:none;
                    border-radius:12px;
                    cursor:pointer;
                    transition:0.2s;
                ">
                    æˆ»ã‚‹
                </button>
            </div>
        </div>
    `;

    let selectedNum = 10; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ10å•

    // å•é¡Œæ•°é¸æŠãƒœã‚¿ãƒ³
    const numButtons = document.querySelectorAll('.btn-num');
    numButtons.forEach(btn => {
        btn.addEventListener('click', (e) => {
            selectedNum = parseInt(e.currentTarget.dataset.num);
            numButtons.forEach(b => {
                b.style.backgroundColor = 'white';
                b.style.border = '2px solid #ccc';
            });
            e.currentTarget.style.backgroundColor = '#fff4b8';
            e.currentTarget.style.border = '2px solid #f5c000';
        });
    });

    // ã€Œã¯ã˜ã‚ã‚‹ã€ãƒœã‚¿ãƒ³
    document.getElementById('start-nen-test').addEventListener('click', () => {
        const start = parseInt(document.getElementById('nen-start').value);
        const end = parseInt(document.getElementById('nen-end').value);

        if (isNaN(start) || isNaN(end)) {
            alert('ç¯„å›²ã®é–‹å§‹ã¨çµ‚äº†ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            return;
        }
        if (start > end) {
            alert('é–‹å§‹ã¯çµ‚äº†ã‚ˆã‚Šå°ã•ã„å€¤ã«ã—ã¦ãã ã•ã„ã€‚');
            return;
        }

        startNenTest(start, end, selectedNum);
    });

    // ã€Œæˆ»ã‚‹ã€ãƒœã‚¿ãƒ³
    document.getElementById('back-to-main').addEventListener('click', () => {
        renderTestMenu(); // å…ƒã®ãƒ†ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã™
    });
}

// ---------------------------
// å¹´å·ãƒ†ã‚¹ãƒˆé–‹å§‹é–¢æ•°ï¼ˆå®Œå…¨ç‰ˆãƒ»shuffle å®šç¾©å«ã‚€ï¼‰
// -------------------------------------
async function startNenTest(start, end, numQuestions) {
    const content = document.getElementById('content');

    try {
        const qSnap = await getDocs(collection(db, 'social_year_questions'));
        let docs = qSnap.docs.map(d => ({ id: d.id, ...d.data() }));

        // ç¯„å›²ãƒ•ã‚£ãƒ«ã‚¿
        let filtered = docs.filter(d => {
            const y = parseInt(d.year, 10);
            return !isNaN(y) && y >= start && y <= end;
        });

        if (filtered.length === 0) {
            content.innerHTML = `<div class="card" style="text-align:center; padding:32px;">
                ç¯„å›²å†…ã«å‡ºé¡Œå¯èƒ½ãªå•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚ç¯„å›²ã‚’å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚
            </div>`;
            return;
        }

        // ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦å‡ºé¡Œæ•°ã ã‘åˆ‡ã‚Šå–ã‚Š
        filtered = shuffleArrayForNen(filtered).slice(0, numQuestions);

        const answers = [];
        let currentIndex = 0;
        let showingAnswer = false;

        // -------------------------------------
        // å•é¡Œç”»é¢æç”»
        // -------------------------------------
        function renderQuestion() {
            const q = filtered[currentIndex];

            content.innerHTML = `
                <div class="card" style="max-width:700px; margin:50px auto; padding:32px; text-align:center; 
                     box-shadow:0 4px 12px rgba(0,0,0,0.1); border-radius:16px; position:relative;">

                    <h3 style="margin-bottom:24px; font-size:1.3em;">
                        å•é¡Œ ${currentIndex + 1} / ${filtered.length}
                    </h3>

                    <div style="font-size:1.6em; margin-bottom:32px; line-height:1.6;">
                        ${escHtml(q.question)}
                    </div>

                    <input type="number" id="user-answer"
                        style="width:200px; padding:16px; border-radius:8px; border:1px solid #ccc; 
                        text-align:center; font-size:1.4em;">

                    <div id="correct-answer" style="margin-top:32px; font-size:1.4em; color:red;"></div>

                    <div style="margin-top:32px;">
                        <button id="next-btn" onclick="handleNext()" style="
                            background-color:#fff4b8; 
                            color:#333; 
                            font-size:1.4em; 
                            padding:12px 32px; 
                            border:none; 
                            border-radius:12px; 
                            cursor:pointer;
                        ">æ¬¡ã¸</button>
                    </div>
                </div>

                <!-- â—‹Ã—ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
                <div id="popup-feedback" style="
                    display:none;
                    position:fixed;
                    top:50%;
                    left:50%;
                    transform:translate(-50%, -50%);
                    font-size:8em;
                    font-weight:bold;
                    pointer-events:none;
                    opacity:0;
                    transition: opacity 0.3s ease;
                "></div>
            `;
        }

        // -------------------------------------
        // â—‹Ã—ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤º
        // -------------------------------------
        function showPopup(correct) {
            const popup = document.getElementById('popup-feedback');
            if (!popup) return;
            popup.textContent = correct ? "â—‹" : "Ã—";
            popup.style.color = correct ? "green" : "red";
            popup.style.display = "block";
            popup.style.opacity = "1";

            setTimeout(() => {
                popup.style.opacity = "0";
            }, 800);
        }

        // -------------------------------------
        // æ¬¡ã¸ãƒœã‚¿ãƒ³å‡¦ç†ï¼ˆonclickã§ç›´æ¥å‘¼ã¶ï¼‰
        // -------------------------------------
        // window ã«ã¶ã‚‰ä¸‹ã’ã¦ã‚°ãƒ­ãƒ¼ãƒãƒ«å‘¼ã³å‡ºã—å¯èƒ½ã«ã™ã‚‹
        window.handleNext = function () {
            // guard: if content was replaced and elements missing, ignore
            const ansInput = document.getElementById('user-answer');
            const correctEl = document.getElementById('correct-answer');
            if (!ansInput || !correctEl) return;

            const q = filtered[currentIndex];
            const userInput = ansInput.value.trim();

            if (!showingAnswer) {
                answers.push(userInput);
                showingAnswer = true;

                const correct = String(q.year);
                const isCorrect = userInput === correct;

                showPopup(isCorrect);

                correctEl.textContent = correct;
                ansInput.disabled = true;
            } else {
                showingAnswer = false;
                currentIndex++;

                if (currentIndex < filtered.length) {
                    renderQuestion();
                } else {
                    renderResult();
                }
            }
        };

        // -------------------------------------
        // çµæœç”»é¢
        // -------------------------------------
        function renderResult() {
            let score = 0;
            let resultHTML = `
                <div class="card" style="max-width:700px; margin:50px auto; padding:32px; 
                    box-shadow:0 4px 12px rgba(0,0,0,0.1); border-radius:16px;">
                <h2 style="margin-bottom:24px;">çµæœ</h2>
                <div style="display:flex; flex-direction:column; gap:12px;">
            `;

            filtered.forEach((q, idx) => {
                const userAns = answers[idx];
                const correct = String(q.year);
                const isCorrect = userAns === correct;

                if (isCorrect) score++;

                resultHTML += `
                    <div style="padding:12px; border-radius:8px; background:${isCorrect ? '#d4f8d4' : '#f8d4d4'};">
                        <div style="font-weight:700;">å•é¡Œ: ${escHtml(q.question)}</div>
                        <div>ã‚ãªãŸã®ç­”ãˆ: ${escHtml(userAns || '-')} / æ­£è§£: ${escHtml(correct)}</div>
                    </div>
                `;
            });

 try {
        if (typeof addBnp === 'function') {
            addBnp(score);
            console.log("BNPã«ã‚¹ã‚³ã‚¢ã‚’åŠ ç®—:", score);
        }
    } catch(e) {
        console.warn("BNPåŠ ç®—ã‚¨ãƒ©ãƒ¼", e);
    }

            resultHTML += `
                </div>
                <h3 style="margin-top:24px;">åˆè¨ˆå¾—ç‚¹: ${score} / ${filtered.length}</h3>
                <button id="back-to-setup" style="
                    margin-top:24px; background-color:#e0e0e0; padding:12px 32px; 
                    border:none; border-radius:12px; cursor:pointer;">
                    ç¯„å›²è¨­å®šã«æˆ»ã‚‹
                </button>
            </div>
            `;

            content.innerHTML = resultHTML;

            const backBtn = document.getElementById('back-to-setup');
            if (backBtn) {
                backBtn.addEventListener('click', () => {
                    renderNenSetup();
                });
            }
        }

        // æœ€åˆã®å•é¡Œã‚’è¡¨ç¤º
        renderQuestion();

    } catch (err) {
        console.error(err);
        content.innerHTML = `<div class="card" style="text-align:center; padding:32px; color:#c00;">
            å•é¡Œã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${escHtml(err.message || err)}
        </div>`;
    }
}

// -------------------------------------
// é…åˆ—ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã™ã‚‹ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼ˆã“ã®ãƒ•ã‚¡ã‚¤ãƒ«å†…ã«å¿…ãšç½®ã„ã¦ãã ã•ã„ï¼‰
// -------------------------------------
function shuffleArrayForNen(arr) {
    const a = Array.isArray(arr) ? [...arr] : [];
    for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
}












// ===== å˜èªãƒ†ã‚¹ãƒˆï¼šãƒ¢ãƒ¼ãƒ‰ãƒ»ãƒ¬ãƒ™ãƒ«ãƒ»å‡ºé¡Œæ•°é¸æŠç”»é¢ =====
function renderWordTestMenu(defaultMode = 'en-ja') {
  document.getElementById('content').innerHTML = `
    <div class="card" style="max-width:800px;margin:auto;padding:24px;">
      <h2 style="text-align:center;margin-bottom:24px;">å˜èªãƒ†ã‚¹ãƒˆ</h2>

      <!-- ãƒ¢ãƒ¼ãƒ‰é¸æŠ -->
      <div style="margin-bottom:24px;">
        <h3 style="margin-bottom:12px;">ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„</h3>
        <div style="display:flex;gap:16px;flex-wrap:wrap;justify-content:center;">
    <label class="wt-mode-card">
  <input type="radio" name="wt-mode" value="en-ja" ${defaultMode==='en-ja'?'checked':''} hidden>
  <div class="wt-card-content">
    <div class="wt-card-title">è‹± â†’ æ—¥</div>
    <div class="wt-card-sub">è‹±å˜èªã‹ã‚‰æ„å‘³ã‚’é¸ã¶</div>
  </div>
</label>
<label class="wt-mode-card">
  <input type="radio" name="wt-mode" value="ja-en" ${defaultMode==='ja-en'?'checked':''} hidden>
  <div class="wt-card-content">
    <div class="wt-card-title">æ—¥ â†’ è‹±</div>
    <div class="wt-card-sub">æ—¥æœ¬èªã‹ã‚‰è‹±å˜èªã‚’å…¥åŠ›ã™ã‚‹</div>
  </div>
</label>
<label class="wt-mode-card">
  <input type="radio" name="wt-mode" value="mywords" ${defaultMode==='mywords'?'checked':''} hidden>
  <div class="wt-card-content">
    <div class="wt-card-title">MyWords</div>
    <div class="wt-card-sub">è‡ªåˆ†ã®è‹¦æ‰‹å˜èªã‹ã‚‰å‡ºé¡Œ</div>
  </div>
</label>
        </div>
      </div>

      <!-- ãƒ¬ãƒ™ãƒ«é¸æŠ -->
      <div style="margin-bottom:24px;">
        <h3 style="margin-bottom:12px;">ãƒ¬ãƒ™ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</h3>
        <div style="display:flex;gap:12px;flex-wrap:wrap;justify-content:center;">
          ${['A','B','C','D','E'].map(l=>`
            <label class="wt-level-btn" data-level="${l}">
              <input type="checkbox" class="wt-level" value="${l}" ${l==='A' ? 'checked':''} hidden>
              <div class="wt-level-circle">${l}</div>
            </label>
          `).join('')}
        </div>
      </div>

      <!-- å‡ºé¡Œæ•°é¸æŠ -->
      <div style="margin-bottom:24px;">
        <h3 style="margin-bottom:12px;">å‡ºé¡Œæ•°ã‚’é¸æŠã—ã¦ãã ã•ã„</h3>
        <div style="display:flex;gap:16px;flex-wrap:wrap;justify-content:center;">
          ${[20,50,100].map(n=>`
            <label class="wt-count-card">
              <input type="radio" name="wt-count" value="${n}" ${n===20?'checked':''} hidden>
              <div class="wt-card-content">
                <div class="wt-card-title">${n}å•</div>
              </div>
            </label>
          `).join('')}
        </div>
      </div>

      <!-- ãƒœã‚¿ãƒ³ -->
      <div style="text-align:center;margin-top:24px;">
        <button class="btn-plain btn-primary" id="wt-start" style="padding:10px 24px;font-size:16px;">ãƒ†ã‚¹ãƒˆé–‹å§‹</button>
        <button class="btn-plain" id="wt-back" style="padding:10px 24px;font-size:16px;margin-left:8px;">æˆ»ã‚‹</button>
      </div>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ -->
    <div id="range-modal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);align-items:center;justify-content:center;z-index:1000;">
      <div style="background:#fff;padding:24px;border-radius:12px;max-width:300px;width:100%;text-align:center;">
        <h3 style="margin-bottom:12px;">å‡ºé¡Œç¯„å›²ã‚’å…¥åŠ›</h3>
        <div style="margin-bottom:12px;">
          <label>From: <input type="number" id="range-from" style="width:70px; height:30px; font-size:16px;"></label>
          <label style="margin-left:12px;">
To: <input type="number" id="range-to" style="width:70px; height:30px; font-size:16px;"></label>
        </div>
        <div>
          <button class="btn-plain btn-primary" id="range-ok" style="margin-right:8px;">OK</button>
          <button class="btn-plain" id="range-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
      </div>
    </div>
  `;

  // æˆ»ã‚‹ãƒœã‚¿ãƒ³
  document.getElementById('wt-back').addEventListener('click', renderTestMenu);

 // ãƒ¢ãƒ¼ãƒ‰ã‚«ãƒ¼ãƒ‰é¸æŠãƒã‚¤ãƒ©ã‚¤ãƒˆ
document.querySelectorAll('.wt-mode-card').forEach(label => {
  label.addEventListener('click', () => {
    document.querySelectorAll('.wt-mode-card input').forEach(inp => inp.checked = false);
    const input = label.querySelector('input');
    input.checked = true;

    // MyWordsé¸æŠæ™‚ã¯ãƒ¬ãƒ™ãƒ«ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
    const levelBtns = document.querySelectorAll('.wt-level-btn input');
    if (input.value === 'mywords') {
      levelBtns.forEach(btn => btn.disabled = true);
      document.querySelectorAll('.wt-level-btn').forEach(lbl => lbl.classList.add('disabled'));
    } else {
      levelBtns.forEach(btn => btn.disabled = false);
      document.querySelectorAll('.wt-level-btn').forEach(lbl => lbl.classList.remove('disabled'));
    }
  });
});



// ãƒšãƒ¼ã‚¸åˆæœŸè¡¨ç¤ºæ™‚ã«MyWordsãƒ¢ãƒ¼ãƒ‰ãŒé¸æŠã•ã‚Œã¦ã„ãŸã‚‰ãƒ¬ãƒ™ãƒ«ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
if (defaultMode === 'mywords') {
  document.querySelectorAll('.wt-level-btn input').forEach(btn => btn.disabled = true);
  document.querySelectorAll('.wt-level-btn').forEach(lbl => lbl.classList.add('disabled'));
}

  // ãƒ¬ãƒ™ãƒ«ãƒœã‚¿ãƒ³é¸æŠï¼†ç¯„å›²ãƒ¢ãƒ¼ãƒ€ãƒ«
  let activeLevelInput = null;
  document.querySelectorAll('.wt-level-btn').forEach(label=>{
    label.addEventListener('click', ()=>{
      const input = label.querySelector('input');
      input.checked = !input.checked;
      label.classList.toggle('selected', input.checked);
      if(input.checked){
        activeLevelInput = input;
        const prev = input.dataset.range ? input.dataset.range.split('-') : ['1','50'];
        document.getElementById('range-from').value = prev[0];
        document.getElementById('range-to').value = prev[1];
        document.getElementById('range-modal').style.display = 'flex';
      } else {
        input.dataset.range = '';
      }
    });
  });

  // ãƒ¢ãƒ¼ãƒ€ãƒ«OK
  document.getElementById('range-ok').addEventListener('click', ()=>{
    if(!activeLevelInput) return;
    const from = document.getElementById('range-from').value;
    const to = document.getElementById('range-to').value;
    if(!from || !to || isNaN(from) || isNaN(to)){
      alert('æ­£ã—ã„æ•°å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }
    activeLevelInput.dataset.range = `${from}-${to}`;
    document.getElementById('range-modal').style.display = 'none';
    activeLevelInput = null;
  });

  // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚­ãƒ£ãƒ³ã‚»ãƒ«
  document.getElementById('range-cancel').addEventListener('click', ()=>{
    if(activeLevelInput){
      activeLevelInput.checked = false;
      activeLevelInput.classList.remove('selected');
      activeLevelInput = null;
    }
    document.getElementById('range-modal').style.display = 'none';
  });

  // å‡ºé¡Œæ•°é¸æŠã‚«ãƒ¼ãƒ‰
  document.querySelectorAll('.wt-count-card').forEach(label=>{
    label.addEventListener('click', ()=>{
      document.querySelectorAll('.wt-count-card input').forEach(inp=>inp.checked=false);
      label.querySelector('input').checked = true;
    });
  });

  // ãƒ†ã‚¹ãƒˆé–‹å§‹
 document.getElementById('wt-start').addEventListener('click', () => {
  const mode = document.querySelector('input[name="wt-mode"]:checked').value;
  const count = Number(document.querySelector('input[name="wt-count"]:checked').value);

  let levels = [];
  if (mode !== 'mywords') {
    levels = Array.from(document.querySelectorAll('.wt-level:checked')).map(x => {
      const [from, to] = (x.dataset.range || '1-50').split('-');
      return { level: x.value, from: Number(from), to: Number(to) };
    });
    if (levels.length === 0) {
      alert('ãƒ¬ãƒ™ãƒ«ã‚’1ã¤ä»¥ä¸Šé¸ã‚“ã§ãã ã•ã„');
      return;
    }
  }

  if (mode === 'mywords') {
    if (myWordList.length === 0) {
      alert('ãƒã‚¤å˜èªãƒªã‚¹ãƒˆã«å˜èªãŒã‚ã‚Šã¾ã›ã‚“');
      return;
    }
    // MyWordsãƒ†ã‚¹ãƒˆã¯è‹±â†’æ—¥å›ºå®š
    startWordTest({
      mode: 'en-ja',
      levels: [{ level: '', from: 1, to: myWordList.length }],
      count: count,
      words: shuffleArray([...myWordList])  // ãƒªã‚¹ãƒˆã‹ã‚‰ã‚·ãƒ£ãƒƒãƒ•ãƒ«
    });
  } else {
    startWordTest({ mode, levels, count });
  }
});


  // å…ƒã®ã‚¹ã‚¿ã‚¤ãƒ«
  const styleTag = document.createElement('style');
  styleTag.innerHTML = `
    .wt-mode-card { flex: 1 1 200px; cursor: pointer; border: 2px solid #d0d7dc; border-radius: 12px; transition: all 0.2s ease; }
    .wt-mode-card:hover { border-color: #007bff; box-shadow: 0 0 0 3px rgba(0,123,255,0.1); }
    .wt-card-content { padding:16px; text-align:center; }
    .wt-card-title { font-weight:700; font-size:18px; margin-bottom:4px; }
    .wt-card-sub { color:#555; font-size:14px; }
    .wt-mode-card input:checked + .wt-card-content { background-color:#cce4ff; color:#003366; border-radius:10px; border-color:#80bfff; }
    .wt-level-btn { cursor: pointer; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; border: 2px solid #d0d7dc; font-weight: bold; font-size: 18px; transition: all 0.2s ease; }
    .wt-level-btn:hover { border-color: #007bff; box-shadow: 0 0 0 3px rgba(0,123,255,0.1); }
    .wt-level-btn input:checked + .wt-level-circle, .wt-level-btn input:checked + div { background-color:#cce4ff; color:#003366; border-color:#80bfff; }
    .wt-level-circle { width:100%; height:100%; display:flex; align-items:center; justify-content:center; border-radius:50%; }
    .wt-count-card { flex: 1 1 80px; cursor: pointer; border: 2px solid #d0d7dc; border-radius: 12px; transition: all 0.2s ease; }
    .wt-count-card:hover { border-color: #007bff; box-shadow: 0 0 0 3px rgba(0,123,255,0.1); }
    .wt-count-card input:checked + .wt-card-content { background-color:#cce4ff; color:#003366; border-radius:10px; border-color:#80bfff; }
    .wt-level-btn.disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

  `;
  document.head.appendChild(styleTag);
}

// ===== Firebase & Utility =====
async function loadWordData() {
  const levels = ['A','B','C','D','E'];
  const wordData = {};
  for(const lvl of levels){
    const docRef = doc(db,'wordLists',lvl);
    const docSnap = await getDoc(docRef);
    if(docSnap.exists()){
      const data = docSnap.data();
      wordData[lvl] = data.words || [];
    } else {
      console.warn(`ãƒ¬ãƒ™ãƒ« ${lvl} ã®ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
      wordData[lvl] = [];
    }
  }
  return wordData;
}
function shuffleArray(array){ return array.sort(()=>Math.random()-0.5); }

function selectWordsForTest(wordData, levels){
  const selected = [];
  for(const lvl of levels){
    const allWords = wordData[lvl.level] || [];
    const from = Math.max(0,lvl.from-1);
    const to = Math.min(allWords.length,lvl.to);
    selected.push(...allWords.slice(from,to));
  }
  return shuffleArray(selected);
}

function makeChoices(correctWord, allWords){
  // åŒã˜å“è©ã®å€™è£œ
  const samePOS = allWords.filter(w => w.pos === correctWord.pos && w.ja !== correctWord.ja);
  let choices = shuffleArray(samePOS).slice(0, 3);

  // ã‚‚ã—3ã¤ã«æº€ãŸãªã‘ã‚Œã°ä»–ã®å˜èªã‹ã‚‰è£œå……
  if (choices.length < 3) {
    const others = allWords.filter(w => w.ja !== correctWord.ja && !choices.includes(w));
    const needed = 3 - choices.length;
    choices.push(...shuffleArray(others).slice(0, needed));
  }

  return shuffleArray([correctWord.ja, ...choices.map(w => w.ja)]);
}

// ===== ãƒ†ã‚¹ãƒˆæœ¬ä½“ =====
let testWords = [];
let currentIndex = 0;
let score = 0;
let userAnswers = [];
let testMode = "en-ja";
let streakCount = 0;

async function startWordTest({ mode, levels, count, words = null }) {
  let selectedWords;
  if (words) {
    selectedWords = words.slice(0, count);
  } else {
    const wordData = await loadWordData();
    selectedWords = selectWordsForTest(wordData, levels).slice(0, count);
  }

  testMode = mode;
  testWords = selectedWords;
  currentIndex = 0;
  score = 0;
  userAnswers = [];
  streakCount = 0;
  nextQuestion();
}

function nextQuestion() {
  // âœ… ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ä¸­ã¯æ¬¡ã®å•é¡Œã‚’å‡ºã•ãªã„
  const oldFeedback = document.getElementById('answer-feedback');
  if (oldFeedback) return;

  // âœ… æœ€å¾Œã®å•é¡ŒãŒçµ‚ã‚ã£ãŸã‚‰çµæœç”»é¢ã¸
  if (!testWords || currentIndex >= testWords.length) {
    renderTestResult();
    return;
  }

  const w = testWords[currentIndex];
  if (testMode === "en-ja") {
    const choices = makeChoices(w, testWords);
    renderWordQuestion(w.en, choices, currentIndex, testWords.length);
  } else if (testMode === "ja-en") {
    renderWordQuestionInput(w.ja, w.en, currentIndex, testWords.length);
  }
  currentIndex++;
}


// ===== è‹±â†’æ—¥ =====
function renderWordQuestion(question, choices, index, total, timeLeft = 3) {
  document.getElementById("content").innerHTML = `
    <div id="test-area" class="card" style="max-width:600px;margin:auto;padding:24px;text-align:center;">
      <h2>å•é¡Œ ${index + 1} / ${total}</h2>
      <div style="margin:16px 0;font-size:36px;font-weight:bold;">${question}</div>
      <div id="choice-container" style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:16px;">
        ${choices
          .map(
            (c, i) =>
              `<button class="btn-plain btn-choice" data-choice="${i}" style="padding:20px;font-size:20px;">${c}</button>`
          )
          .join("")}
      </div>
      <div style="margin-top:20px;height:8px;background:#eee;border-radius:4px;">
        <div id="time-bar" style="height:100%;width:100%;background:#007bff;border-radius:4px;"></div>
      </div>
    </div>
  `;

  const bar = document.getElementById("time-bar");
  let start = Date.now();
  window.choiceLocked = false; // â† æ–°è¦ï¼šå•é¡Œã”ã¨ã«ãƒ­ãƒƒã‚¯è§£é™¤

  const timer = setInterval(() => {
    const elapsed = (Date.now() - start) / 1000;
    bar.style.width = `${Math.max(0, 100 * (1 - elapsed / timeLeft))}%`;
    if (elapsed >= timeLeft) {
      clearInterval(timer);
      if (!window.choiceLocked) {
        window.choiceLocked = true;
        disableChoices();
        checkAnswer(null, choices);
      }
    }
  }, 30);

  // é¸æŠè‚¢ã‚¯ãƒªãƒƒã‚¯å‡¦ç†ï¼ˆ1å›ã ã‘å›ç­”å¯ï¼‰
  document.querySelectorAll(".btn-choice").forEach((btn) => {
    btn.addEventListener("click", () => {
      if (window.choiceLocked) return; // â† æ–°è¦ï¼šã™ã§ã«ã‚¯ãƒªãƒƒã‚¯æ¸ˆã¿ãªã‚‰ç„¡è¦–
      window.choiceLocked = true;

      clearInterval(timer);
      disableChoices();

      checkAnswer(btn.dataset.choice, choices);
    });
  });

  // é¸æŠè‚¢ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
  function disableChoices() {
    document.querySelectorAll(".btn-choice").forEach((b) => {
      b.style.pointerEvents = "none"; // ã‚¯ãƒªãƒƒã‚¯ç„¡åŠ¹åŒ–
      b.style.opacity = "0.6"; // è¦‹ãŸç›®ã§ç„¡åŠ¹ã£ã½ã
    });
  }
}

// ===== æ—¥â†’è‹±ï¼ˆå…¥åŠ›å½¢å¼ï¼‰ =====
function renderWordQuestionInput(question, answer, index, total, timeLeft = 10) {
  const masked = answer[0] + " " + "_ ".repeat(answer.length - 1);
  document.getElementById("content").innerHTML = `
    <div id="test-area" class="card" style="max-width:600px;margin:auto;padding:24px;text-align:center;">
      <h2>å•é¡Œ ${index + 1} / ${total}</h2>
      <div style="margin:16px 0;font-size:28px;">${question}</div>
      <div id="masked-display" style="margin-bottom:16px;font-size:26px;letter-spacing:6px;color:#555;">${masked}</div>
      <input id="answer-input" type="text" placeholder="è‹±å˜èªã‚’å…¥åŠ›"
        style="padding:12px;font-size:22px;width:80%;text-align:center;border:1px solid #ccc;border-radius:8px;">
      <div style="margin-top:16px;">
        <button class="btn-plain btn-primary" id="submit-answer" style="padding:10px 24px;">æ±ºå®š</button>
      </div>
      <div style="margin-top:20px;height:8px;background:#eee;border-radius:4px;">
        <div id="time-bar" style="height:100%;width:100%;background:#28a745;border-radius:4px;"></div>
      </div>
    </div>
  `;

  const bar = document.getElementById("time-bar");
  let start = Date.now();
  const timer = setInterval(() => {
    const elapsed = (Date.now() - start) / 1000;
    bar.style.width = `${Math.max(0, 100 * (1 - elapsed / timeLeft))}%`;
    if (elapsed >= timeLeft) {
      clearInterval(timer);
      checkAnswerInput("", answer);
    }
  }, 30);

  const input = document.getElementById("answer-input");
  const maskedDisplay = document.getElementById("masked-display");

  // å…¥åŠ›ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åæ˜ ï¼ˆ2æ–‡å­—ç›®ã‹ã‚‰åæ˜ ï¼‰
input.addEventListener("input", () => {
  const val = input.value.toLowerCase();

  // å…¥åŠ›ã®å…ˆé ­æ–‡å­—ï¼ˆé ­æ–‡å­—ï¼‰ã¯ç„¡è¦–ã—ã¦ã€2æ–‡å­—ç›®ä»¥é™ã ã‘ä½¿ã†
  const subVal = val.slice(1);

  let display = answer[0] + " ";
  for (let i = 1; i < answer.length; i++) {
    display += (subVal[i - 1] ? subVal[i - 1] : "_") + " ";
  }

  maskedDisplay.textContent = display.trim();
});

  document.getElementById("submit-answer").addEventListener("click", () => {
    clearInterval(timer);
    const val = input.value.trim();
    checkAnswerInput(val, answer);
  });
}


// ===== æ­£è§£ãƒ»ä¸æ­£è§£åˆ¤å®šã¨è¡¨ç¤ºï¼ˆä¿®æ­£ç‰ˆï¼‰ =====
function checkAnswer(selectedIndex, choices) {
  // currentIndex ã¯æ¬¡ã«é€²ã‚€ãŸã‚ã« ++ ã•ã‚Œã¦ã„ã‚‹è¨­è¨ˆ -> åˆ¤å®šå¯¾è±¡ã¯ currentIndex - 1
  if (currentIndex <= 0 || currentIndex - 1 >= testWords.length) return;
  const w = testWords[currentIndex - 1];
  const selected = selectedIndex !== null ? choices[selectedIndex] : null;
  const isCorrect = selected === w.ja;

  // çµæœã‚’è¨˜éŒ²ï¼ˆè©³ç´°ç”»é¢ç”¨ï¼‰
  userAnswers.push({ word: w, selected: selected, correct: w.ja });

  if (isCorrect) {
    // æ­£è§£
    score++;
    streakCount++;
    // MyWords ã«å…¥ã£ã¦ã„ã‚‹ãªã‚‰é€²æ—ã‚’æ›´æ–°ï¼ˆen ã§ç®¡ç†ï¼‰
    updateMyWordProgress(w.en);
  } else {
    // ä¸æ­£è§£ï¼šMyWords ã«è‡ªå‹•è¿½åŠ ï¼ˆé‡è¤‡ã¯ addToMyWordList ãŒå¼¾ãï¼‰
    addToMyWordList(w);
    streakCount = 0;
  }

  updateStreakDisplay();
  // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¡¨ç¤ºï¼ˆã€‡/Ã—ï¼‰ã—ã¦ã‹ã‚‰æ¬¡ã®å•é¡Œã¸
  showAnswerFeedback(isCorrect, nextQuestion);
}

// ===== æ—¥â†’è‹±ï¼ˆå…¥åŠ›å½¢å¼ï¼‰ã®åˆ¤å®šã§ MyWords æ›´æ–°ç­‰ã‚’è¡Œã† =====
function checkAnswerInput(userInput, correct) {
  if (currentIndex <= 0 || currentIndex - 1 >= testWords.length) return;
  const isCorrect = String(userInput || "").trim().toLowerCase() === String(correct || "").trim().toLowerCase();

  // è©³ç´°ä¿å­˜ï¼ˆè‹±èªã‚’ correctã€ja ã¯ç©ºæ–‡å­—ã‹ã‚ã‚Œã°ã‚»ãƒƒãƒˆï¼‰
  userAnswers.push({ word: { en: correct, ja: "" }, selected: userInput, correct: correct });

  if (isCorrect) {
    score++;
    streakCount++;
    // jaâ†’en ãƒ¢ãƒ¼ãƒ‰ã§ã‚‚ MyWords ãŒå­˜åœ¨ã—ã¦ã„ãŸã‚‰é€²æ—æ›´æ–°
    updateMyWordProgress(correct);
  } else {
    // ä¸æ­£è§£ãªã‚‰ MyWords ã«è¿½åŠ ï¼ˆja ã¯ç©ºã ãŒç®¡ç†ä¸Šã¯ en ãŒã‚ã‚Œã° OKï¼‰
    addToMyWordList({ en: correct, ja: "" });
    streakCount = 0;
  }

  updateStreakDisplay();
  showAnswerFeedback(isCorrect, nextQuestion);
}

// MyWords ã«è¿½åŠ ã™ã‚‹é–¢æ•°ï¼ˆé‡è¤‡ãƒã‚§ãƒƒã‚¯ã‚ã‚Šï¼‰
// è¿½åŠ ï¼šMyWords ã«å˜èªã‚’è¿½åŠ ï¼ˆé‡è¤‡ãƒã‚§ãƒƒã‚¯ã‚ã‚Šï¼‰ â€” Firestore ã«ä¿å­˜
async function addToMyWordList(wordObj) {
  if (!wordObj || !wordObj.en) return;

  // é‡è¤‡ãƒã‚§ãƒƒã‚¯
  if (myWordList.some(w => w.en === wordObj.en)) {
    // æ—¢ã«ã‚ã‚‹ -> ä½•ã‚‚ã—ãªã„
    return;
  }

  // ãƒ­ãƒ¼ã‚«ãƒ«ãƒªã‚¹ãƒˆæ›´æ–°
  myWordList.push({
    en: wordObj.en,
    ja: wordObj.ja || "",
    pos: wordObj.pos || "",
    level: wordObj.level || "",
    correctCount: 0
  });

  // Firestore ã«ä¿å­˜ï¼ˆéåŒæœŸï¼‰
  await saveMyWordListToFirestore();
}

// æ›´æ–°ï¼šæ­£è§£å›æ•°ã‚’å¢—ã‚„ã™ï¼ˆ5å›ã§å‰Šé™¤ï¼‰ â€” Firestore ã«ä¿å­˜
async function updateMyWordProgress(en) {
  if (!en) return;
  const target = myWordList.find(item => item.en === en);
  if (!target) return;
  target.correctCount = (target.correctCount || 0) + 1;
  if (target.correctCount >= 5) {
    // ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤
    myWordList = myWordList.filter(item => item.en !== en);
  }
  await saveMyWordListToFirestore();
}

// ===== æ­£è§£ãƒ»ä¸æ­£è§£ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¡¨ç¤ºï¼ˆä¸­å¤®é…ç½®ãƒ»å¤§ãã‚ãƒ»é‡è¤‡é˜²æ­¢ï¼‹ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆå¾Œã«é·ç§»ï¼‰ =====
let feedbackTimeout = null; // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã§ä¿æŒï¼ˆå‰ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’æ­¢ã‚ã‚‹ç”¨ï¼‰

function showAnswerFeedback(isCorrect, callback) {
  // æ—¢å­˜ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’å¼·åˆ¶å‰Šé™¤
  if (document.getElementById('answer-feedback')) return;
  const oldFeedback = document.getElementById('answer-feedback');
  if (oldFeedback) oldFeedback.remove();

  // å‰å›ã®ã‚¿ã‚¤ãƒãƒ¼ãŒã‚ã‚Œã°ãƒªã‚»ãƒƒãƒˆ
  if (feedbackTimeout) clearTimeout(feedbackTimeout);

  // ãƒ†ã‚¹ãƒˆéƒ¨åˆ†ã®ä¸­å¤®ã‚’åŸºæº–ã«è¡¨ç¤º
  const testArea = document.getElementById('test-area') || document.body;
  const rect = testArea.getBoundingClientRect();

  const feedback = document.createElement('div');
  feedback.id = 'answer-feedback';
  feedback.textContent = isCorrect ? 'ã€‡' : 'Ã—';

  // ===== ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š =====
  feedback.style.position = 'absolute';
  feedback.style.left = `${rect.width / 2}px`;
  feedback.style.top = `${rect.height / 2.2}px`; // å°‘ã—ä¸Šå¯„ã‚Šã«ï¼ˆä¸­å¤®è¿‘ãï¼‰
  feedback.style.transform = 'translate(-50%, -50%)';
  feedback.style.fontSize = '180px'; // å¤§ããï¼
  feedback.style.fontWeight = '900';
  feedback.style.color = isCorrect
    ? 'rgba(0, 180, 0, 0.4)'
    : 'rgba(255, 0, 0, 0.4)';
  feedback.style.zIndex = '9999';
  feedback.style.pointerEvents = 'none';
  feedback.style.opacity = '1';
  feedback.style.transition = 'opacity 0.8s ease';
  feedback.style.textShadow = '0 0 20px rgba(0,0,0,0.2)';

  // ===== ãƒ†ã‚¹ãƒˆé ˜åŸŸå†…ã«è¿½åŠ  =====
  testArea.appendChild(feedback);

  // ===== ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆã—ã¦å‰Šé™¤ + æ¬¡ã®å•é¡Œã¸ =====
  feedbackTimeout = setTimeout(() => {
    feedback.style.opacity = '0';
    setTimeout(() => {
      feedback.remove();
      if (typeof callback === 'function') callback();
    }, 800);
  }, 800);
}


function updateStreakDisplay() {
  const card = document.querySelector('.card');
  if (!card) return; // å•é¡Œã‚«ãƒ¼ãƒ‰ãŒãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„

  let streakEl = document.getElementById('streak-display');
  if (!streakEl) {
    streakEl = document.createElement('div');
    streakEl.id = 'streak-display';
    streakEl.style.position = 'absolute';
    streakEl.style.top = '8px';
    streakEl.style.right = '16px';
    streakEl.style.fontSize = '16px';
    streakEl.style.fontWeight = 'bold';
    streakEl.style.color = '#28a745';
    card.style.position = 'relative'; // ã‚«ãƒ¼ãƒ‰ã‚’åŸºæº–ã«çµ¶å¯¾é…ç½®
    card.appendChild(streakEl);
  }

  if (streakCount >= 3) {
    streakEl.textContent = `${streakCount}å•é€£ç¶šæ­£è§£ä¸­ï¼`;
    streakEl.style.display = 'block';
  } else {
    streakEl.style.display = 'none';
  }
}

// ===== çµæœãƒ»è©³ç´°ç”»é¢ =====

// Firestore ã«çµæœã‚’ä¿å­˜ã™ã‚‹é–¢æ•°
// ===== å˜èªãƒ†ã‚¹ãƒˆçµæœã‚’ Firestore ã«ä¿å­˜ =====
async function saveWordTestResult(score, totalQuestions, answersArray = []) {
  try {
    if (!currentUser) {
      alert("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„");
      return;
    }

    const uid = currentUser.id;

    const answers = (answersArray || []).map(q => ({
      question: q.question || q.word || '',
      selected: q.userAnswer || q.selected || '',
      correctAnswer: q.correctAnswer || q.correct || '',
      isCorrect: q.isCorrect === true || q.userAnswer === q.correctAnswer,
      score: q.isCorrect === true || q.userAnswer === q.correctAnswer ? 1 : 0
    }));

    await addDoc(collection(db, "results"), {
      uid,
      type: "å˜èªãƒ†ã‚¹ãƒˆ",
      score,
      fullScore: totalQuestions,
      answers,
      createdAt: new Date()
    });

    console.log("âœ… å˜èªãƒ†ã‚¹ãƒˆçµæœã‚’Firestoreã«ä¿å­˜ã—ã¾ã—ãŸ");
  } catch (err) {
    console.error("âŒ saveWordTestResult error", err);
    alert("ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + err.message);
  }
}


// renderTestResult â€” çµæœç”»é¢ã‚’æç”»ã—ã€ä¿å­˜ã‚’å‘¼ã¶
async function renderTestResult() {
  // streak éè¡¨ç¤ºï¼ˆã‚ã‚Œã°ï¼‰
  const streakEl = document.getElementById('streak-display');
  if (streakEl) streakEl.style.display = 'none';

  // Firestore ã«çµæœã‚’ä¿å­˜ï¼ˆéåŒæœŸï¼‰
  try {
    saveWordTestResult(score, testWords.length);
  } catch (e) {
    console.error('saveWordTestResult å‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼:', e);
  }

// âœ… BNPåŠ ç®—å‡¦ç†ã‚’è¿½åŠ ï¼ˆçµæœç”»é¢åˆ‡ã‚Šæ›¿ãˆæ™‚ã«ä¸€åº¦ã ã‘ï¼‰
  try {
    if (typeof addBnp === 'function') {
      await addBnp(score);
      console.log('âœ… BNPã«ã‚¹ã‚³ã‚¢ã‚’åŠ ç®—ã—ã¾ã—ãŸ');
    } else {
      console.warn('âš ï¸ addBnp é–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
    }
  } catch (e) {
    console.warn('addBnp at end failed', e);
  }

  // çµæœç”»é¢ã‚’æç”»
  document.getElementById("content").innerHTML = `
    <div class="card" style="max-width:600px;margin:auto;padding:24px;text-align:center;">
      <h2>ãƒ†ã‚¹ãƒˆçµ‚äº†</h2>
      <p style="font-size:28px;font-weight:bold;">æ­£ç­”æ•°: ${score} / ${testWords.length}</p>
      <div style="margin-top:16px;">
        <button class="btn-plain btn-primary" id="btn-retry">ã‚‚ã†ä¸€åº¦</button>
        <button class="btn-plain" id="btn-menu">ãƒ†ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
        <button class="btn-plain" id="btn-details" style="margin-left:8px;">ãã‚ã—ãè¦‹ã‚‹</button>
      </div>
    </div>
  `;

  // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
  document.getElementById("btn-retry").addEventListener("click", renderWordTestMenu);
  document.getElementById("btn-menu").addEventListener("click", renderTestMenu);
  document.getElementById("btn-details").addEventListener("click", renderTestDetails);
}



// ===== è§£ç­”è©³ç´°ç”»é¢ =====
function renderTestDetails() {
  document.getElementById("content").innerHTML = `
    <div class="card" style="max-width:700px;margin:auto;padding:24px;">
      <h2 style="text-align:center;margin-bottom:16px;">è§£ç­”è©³ç´°</h2>
      <div style="max-height:500px;overflow-y:auto;" id="detail-answers">
        <!-- å€‹åˆ¥è§£ç­”ã¯JSã§è¿½åŠ  -->
      </div>
      <div style="text-align:center;margin-top:16px;">
        <button class="btn-plain btn-primary" id="btn-retry-detail" style="margin-right:8px;">ã‚‚ã†ä¸€åº¦</button>
        <button class="btn-plain btn-primary" id="btn-result-detail">ãƒ†ã‚¹ãƒˆçµæœã«æˆ»ã‚‹</button>
        <button class="btn-plain btn-primary" id="btn-menu-detail" style="margin-left:8px;">ãƒ†ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
      </div>
    </div>
  `;

  // ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
  document.getElementById("btn-retry-detail").addEventListener("click", renderWordTestMenu);
  document.getElementById("btn-result-detail").addEventListener("click", renderTestResult);
  document.getElementById("btn-menu-detail").addEventListener("click", renderTestMenu);

  // å€‹åˆ¥è§£ç­”ã®æç”»ã¨ã€Œãƒã‚¤å˜èªãƒªã‚¹ãƒˆã€ãƒœã‚¿ãƒ³è¨­å®š
  const container = document.getElementById('detail-answers');
  container.innerHTML = ''; // ã‚¯ãƒªã‚¢

  userAnswers.forEach((ua, i) => {
    const item = document.createElement('div');
    item.style.border = '1px solid #ddd';
    item.style.borderRadius = '8px';
    item.style.padding = '12px';
    item.style.marginBottom = '12px';
    item.style.backgroundColor = ua.selected === ua.correct ? '#d4edda' : '#f8d7da';

    const info = document.createElement('div');
    info.innerHTML = `
      <strong>Q${i+1}: ${ua.word.en}</strong><br>
      ã‚ãªãŸã®è§£ç­”: <span style="font-weight:bold;">${ua.selected || 'ï¼ˆæœªå›ç­”ï¼‰'}</span><br>
      æ­£è§£: <span style="font-weight:bold;">${ua.correct}</span><br>
      <span style="color:${ua.selected===ua.correct?'green':'red'}; font-weight:bold;">
        ${ua.selected===ua.correct?'æ­£è§£':'ä¸æ­£è§£'}
      </span>
    `;

    const btn = document.createElement('button');
    btn.className = 'btn-plain btn-secondary';
    btn.style.marginTop = '6px';

    const alreadyAdded = myWordList.some(w => w.en === ua.word.en);
    if (alreadyAdded) {
      btn.textContent = 'è¿½åŠ æ¸ˆã¿';
      btn.style.backgroundColor = '#aaa';
      btn.disabled = true;
    } else {
      btn.textContent = 'ãƒã‚¤å˜èªãƒªã‚¹ãƒˆã«è¿½åŠ ';
      btn.addEventListener('click', () => {
        addToMyWordList(ua.word);
        btn.textContent = 'è¿½åŠ æ¸ˆã¿';
        btn.style.backgroundColor = '#aaa';
        btn.disabled = true;
      });
    }

    item.appendChild(info);
    item.appendChild(btn);
    container.appendChild(item);
  });
}


// ===== ãƒã‚¤å˜èªãƒªã‚¹ãƒˆ =====
// === Firestore ã«ä¿å­˜ / èª­ã¿è¾¼ã¿ã™ã‚‹é–¢æ•°ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ MyWordsï¼‰ ===

// Firestoreã¸ä¿å­˜
async function saveMyWordListToFirestore() {
  if (!currentUser) {
    console.warn("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„ã®ã§ä¿å­˜ã—ã¾ã›ã‚“");
    return;
  }
  try {
    const uid = currentUser.id;
    await setDoc(doc(db, "myWords", uid), {
      words: myWordList,
      updatedAt: new Date()
    });
    console.log("âœ… Firestoreã«ãƒã‚¤å˜èªãƒªã‚¹ãƒˆã‚’ä¿å­˜:", myWordList.length, "èª");
  } catch (e) {
    console.error("âŒ Firestoreä¿å­˜ã‚¨ãƒ©ãƒ¼:", e);
  }
}

// Firestoreã‹ã‚‰èª­ã¿è¾¼ã¿
async function loadMyWordListFromFirestore() {
  if (!currentUser) {
    console.warn('loadMyWordListFromFirestore: not logged in');
    myWordList = [];
    return [];
  }
  try {
    const uid = currentUser.id;
    const dSnap = await getDoc(doc(db, 'myWords', uid));
    if (!dSnap.exists()) {
      console.log('â„¹ï¸ myWordsã«ãƒ‡ãƒ¼ã‚¿ãªã—ï¼ˆåˆå›ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰');
      myWordList = [];
      return myWordList;
    }
    const data = dSnap.data();
    myWordList = Array.isArray(data.words) ? data.words : [];
    console.log('âœ… Firestoreã‹ã‚‰ãƒã‚¤å˜èªãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿:', myWordList);
    return myWordList;
  } catch (err) {
    console.error('âŒ loadMyWordListFromFirestore error', err);
    myWordList = [];
    return myWordList;
  }
}

// âœ… ãƒã‚¤å˜èªãƒªã‚¹ãƒˆç”»é¢ã®æç”»ï¼ˆFirestoreã‹ã‚‰æœ€æ–°ã‚’å–å¾—ã—ã¦è¡¨ç¤ºï¼‰
async function renderMyWordList() {
  if (!currentUser) {
    document.getElementById('content').innerHTML = `<p style="text-align:center;">ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚</p>`;
    return;
  }

  // ğŸ”½ Firestoreã‹ã‚‰æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰
  await loadMyWordListFromFirestore();

  // ğŸ”½ è¡¨ç¤ºã‚’ç”Ÿæˆ
  document.getElementById('content').innerHTML = `
    <div class="card" style="max-width:800px;margin:auto;padding:24px;">
      <h2 style="text-align:center;">ãƒã‚¤å˜èªãƒªã‚¹ãƒˆ</h2>
      <table style="width:100%;border-collapse:collapse;margin-top:16px;">
        <thead>
          <tr style="background:#f0f0f0;">
            <th style="padding:8px;border:1px solid #ccc;">è‹±èª</th>
            <th style="padding:8px;border:1px solid #ccc;">æ—¥æœ¬èª</th>
            <th style="padding:8px;border:1px solid #ccc;">å“è©</th>
            <th style="padding:8px;border:1px solid #ccc;">ãƒ¬ãƒ™ãƒ«</th>
            <th style="padding:8px;border:1px solid #ccc;">æ­£ç­”æ•°</th>
          </tr>
        </thead>
        <tbody>
          ${myWordList.length === 0
            ? `<tr><td colspan="5" style="text-align:center;padding:12px;">ã¾ã å˜èªãŒã‚ã‚Šã¾ã›ã‚“</td></tr>`
            : myWordList.map(w => `
              <tr>
                <td style="padding:8px;border:1px solid #ccc;">${w.en}</td>
                <td style="padding:8px;border:1px solid #ccc;">${w.ja}</td>
                <td style="padding:8px;border:1px solid #ccc;">${w.pos || '-'}</td>
                <td style="padding:8px;border:1px solid #ccc;">${w.level || '-'}</td>
                <td style="padding:8px;border:1px solid #ccc;color:#28a745;">${'â—'.repeat(w.correctCount || 0)}</td>
              </tr>
            `).join('')}
        </tbody>
      </table>
      <div style="text-align:center;margin-top:16px;">
        <button class="btn-plain btn-primary" id="mywords-test-btn">MyWordsã§ãƒ†ã‚¹ãƒˆ</button>
      </div>
    </div>
  `;

// MyWordsã§ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ã®å‹•ä½œ
document.getElementById('mywords-test-btn').addEventListener('click', () => {
  renderWordTestMenu('mywords'); // â† ãƒ¢ãƒ¼ãƒ‰æŒ‡å®šã—ã¦ç”»é¢ã¸é·ç§»
});

}


// ===== å˜èªãƒªã‚¹ãƒˆç®¡ç†ç”»é¢ =====
async function renderWordList() {
  document.getElementById('content').innerHTML = `
    <div class="card">
      <h2>å˜èªãƒªã‚¹ãƒˆç®¡ç†</h2>
      
      <div style="margin-bottom:12px;">
        <label>ãƒ¬ãƒ™ãƒ«é¸æŠï¼š</label>
        <select id="wordlist-level">
          <option value="A">A</option>
          <option value="B">B</option>
          <option value="C">C</option>
          <option value="D">D</option>
          <option value="E">E</option>
        </select>
        <button class="btn-plain btn-primary" id="load-wordlist">èª­ã¿è¾¼ã¿</button>
      </div>

      <div id="wordlist-table-container" style="margin-top:12px;">
        <table id="wordlist-table" class="word-table">
          <thead>
            <tr>
              <th style="width:60px;">#</th>
              <th>è‹±èª</th>
              <th>æ—¥æœ¬èª</th>
              <th>å“è©</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <button class="btn-plain btn-secondary" id="add-row" style="margin-top:10px;">ï¼‹ è¡Œã‚’è¿½åŠ </button>
      </div>

      <h3 style="margin-top:20px;">Excelã‹ã‚‰è²¼ã‚Šä»˜ã‘</h3>
      <p style="font-size:0.9em;color:#555;">ã€Œè‹±èªã€â†’ã€Œæ—¥æœ¬èªã€â†’ã€Œå“è©ã€ã®é †ã«ã‚¿ãƒ–åŒºåˆ‡ã‚Šã§è²¼ã‚Šä»˜ã‘ã§ãã¾ã™ã€‚</p>
      <textarea id="paste-area" rows="5" style="width:100%;"></textarea>
      <button class="btn-plain btn-secondary" id="paste-add">è²¼ã‚Šä»˜ã‘å†…å®¹ã‚’è¿½åŠ </button>

      <div style="margin-top:20px;">
        <button class="btn-plain btn-primary" id="save-wordlist">ä¿å­˜</button>
        <button class="btn-plain" id="back-main">æˆ»ã‚‹</button>
      </div>
    </div>
  `;

  // æˆ»ã‚‹ãƒœã‚¿ãƒ³
  document.getElementById('back-main').addEventListener('click', renderTestMenu);

  // ã€Œè¡Œã‚’è¿½åŠ ã€ãƒœã‚¿ãƒ³
  document.getElementById('add-row').addEventListener('click', ()=>{
    addWordRow();
  });

  // ã€Œèª­ã¿è¾¼ã¿ã€ãƒœã‚¿ãƒ³
  document.getElementById('load-wordlist').addEventListener('click', async ()=>{
    const level = document.getElementById('wordlist-level').value;
    await loadWordList(level);
  });

  // ã€Œè²¼ã‚Šä»˜ã‘è¿½åŠ ã€ãƒœã‚¿ãƒ³
  document.getElementById('paste-add').addEventListener('click', ()=>{
    const text = document.getElementById('paste-area').value.trim();
    if(!text) return;
    const rows = text.split(/\n/).map(r => r.split(/\t/));
    for(const row of rows){
      if(row.length >= 2){
        addWordRow(row[0], row[1], row[2] || '');
      }
    }
  });

  // ã€Œä¿å­˜ã€ãƒœã‚¿ãƒ³
  document.getElementById('save-wordlist').addEventListener('click', async ()=>{
    const level = document.getElementById('wordlist-level').value;
    await saveWordList(level);
  });
}

// ===== è¡Œã‚’è¿½åŠ ã™ã‚‹é–¢æ•° =====
function addWordRow(en = '', ja = '', pos = '') {
  const table = document.getElementById('wordlist-table').querySelector('tbody');
  const index = table.children.length + 1;
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td>${index}</td>
    <td contenteditable="true">${en}</td>
    <td contenteditable="true">${ja}</td>
    <td contenteditable="true">${pos}</td>
    <td><button class="btn-plain btn-danger delete-row">å‰Šé™¤</button></td>
  `;
  table.appendChild(tr);

  tr.querySelector('.delete-row').addEventListener('click', ()=>{
    tr.remove();
    updateWordRowNumbers();
  });
}

// ===== è¡Œç•ªå·ã‚’æ›´æ–° =====
function updateWordRowNumbers(){
  const rows = document.querySelectorAll('#wordlist-table tbody tr');
  rows.forEach((tr, i)=>{
    tr.children[0].textContent = i + 1;
  });
}

// ===== å˜èªãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿ =====
async function loadWordList(level) {
  const tableBody = document.querySelector('#wordlist-table tbody');
  tableBody.innerHTML = 'èª­ã¿è¾¼ã¿ä¸­...';
  try {
    const docRef = doc(db, 'wordLists', level);
    const snap = await getDoc(docRef);
    const data = snap.exists() ? snap.data().words || [] : [];

    // è¡¨ã‚’ã‚¯ãƒªã‚¢ã—ã¦å†æç”»
    tableBody.innerHTML = '';
    for(const w of data){
      addWordRow(w.en, w.ja, w.pos);
    }
  } catch(err) {
    console.error('å˜èªãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', err);
    tableBody.innerHTML = '<tr><td colspan="5">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</td></tr>';
  }
}

// ===== å˜èªãƒªã‚¹ãƒˆä¿å­˜ =====
async function saveWordList(level) {
  try {
    const rows = Array.from(document.querySelectorAll('#wordlist-table tbody tr'));
    const words = rows.map(tr=>{
      const tds = tr.querySelectorAll('td');
      return {
        en: tds[1].textContent.trim(),
        ja: tds[2].textContent.trim(),
        pos: tds[3].textContent.trim(),
      };
    });
    const docRef = doc(db, 'wordLists', level);
    await setDoc(docRef, { words });
    alert('ä¿å­˜ã—ã¾ã—ãŸï¼');
  } catch(err) {
    console.error('å˜èªãƒªã‚¹ãƒˆä¿å­˜ã‚¨ãƒ©ãƒ¼:', err);
    alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
}


// ===== BNP ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦– =====
function initBnpWatcher() {
  if (!currentUser || !currentUser.id) return;

  const userRef = doc(db, "users", currentUser.id);

  // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–
  onSnapshot(userRef, (snap) => {
    if (!snap.exists()) return;
    const data = snap.data();
    const bnpValue = data.bnp || 0;

    // #bnp-display ã«åæ˜ 
    const el = document.getElementById('bnp-display');
    if (el) el.textContent = `${bnpValue} bnp`;
  });
}


//
if(currentUser && currentUser.id){
  initBnpWatcher();
}

// loginUser().then(user => { currentUser = user; initBnpWatcher(); });

    
function renderHistory() {
  document.getElementById('content').innerHTML = `
    <div class="card">
      <h2 style="margin-bottom:12px;">éå»ã®æˆç¸¾</h2>
      <p>é–²è¦§ã—ãŸã„ãƒ†ã‚¹ãƒˆã®ç¨®é¡ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚</p>

      <!-- è‹±èªã®å¤§ããªã‚«ãƒ¼ãƒ‰ -->
      <div class="card" style="border:2px solid #bbb; padding:16px 16px; margin-top:16px;">
        <h3 style="margin:2px 0; font-size:32px; color:#f5b5c5; font-weight:900;">è‹±èª</h3>
        <div style="display:flex; gap:12px; flex-wrap:wrap; margin-top:12px;">
          <div class="small-card" style="
            width:250px; height:76px; display:flex; align-items:center; justify-content:center;
            text-align:center; border:2px solid #f5b5c5; border-radius:12px; cursor:pointer;
            font-size:16px; font-weight:bold;"
            data-type="é€Ÿèª­åŠ›æ¸¬å®šãƒ†ã‚¹ãƒˆ">é€Ÿèª­åŠ›æ¸¬å®šãƒ†ã‚¹ãƒˆ</div>
          <div class="small-card" style="
            width:250px; height:76px; display:flex; align-items:center; justify-content:center;
            text-align:center; border:2px solid #f5b5c5; border-radius:12px; cursor:pointer;
            font-size:16px; font-weight:bold;"
            data-type="æ–‡æ³•ç‰¹è¨“">æ–‡æ³•ç‰¹è¨“</div>
          <div class="small-card" style="
            width:250px; height:76px; display:flex; align-items:center; justify-content:center;
            text-align:center; border:2px solid #f5b5c5; border-radius:12px; cursor:pointer;
            font-size:16px; font-weight:bold;"
            data-type="å˜èªãƒ†ã‚¹ãƒˆ">å˜èªãƒ†ã‚¹ãƒˆ</div>
          <div class="small-card" style="
            width:250px; height:76px; display:flex; align-items:center; justify-content:center;
            text-align:center; border:2px solid #f5b5c5; border-radius:12px; cursor:not-allowed; opacity:0.6;
            font-size:16px; font-weight:bold;">
            ãƒªã‚¹ãƒ‹ãƒ³ã‚°ç‰¹è¨“ï¼ˆæœªå®Ÿè£…ï¼‰
          </div>
        </div>
      </div>

      <!-- ç¤¾ä¼šã®å¤§ããªã‚«ãƒ¼ãƒ‰ -->
      <div class="card" style="border:2px solid #bbb; padding:16px 16px; margin-top:16px;">
        <h3 style="margin:2px 0; font-size:32px; color:#f9e58a; font-weight:900;">ç¤¾ä¼š</h3>
        <div style="display:flex; gap:12px; flex-wrap:wrap; margin-top:12px;">
          <div class="small-card" style="
            width:250px; height:76px; display:flex; align-items:center; justify-content:center;
            text-align:center; border:2px solid #f9e58a; border-radius:12px; cursor:pointer;
            font-size:16px; font-weight:bold;"
            data-type="ä¸€å•ä¸€ç­”">ä¸€å•ä¸€ç­”</div>
        </div>
      </div>

      <!-- é¸æŠã—ãŸãƒ†ã‚¹ãƒˆçµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
      <div id="history-list" style="margin-top:16px;"></div>
    </div>
  `;

  // å°ã‚«ãƒ¼ãƒ‰ã®ã‚¯ãƒªãƒƒã‚¯å‡¦ç†
  const cardContainer = document.querySelectorAll('.small-card');
  cardContainer.forEach(card => {
    card.addEventListener('click', () => {
      cardContainer.forEach(c => c.style.boxShadow = 'none');
      card.style.boxShadow = '0 6px 18px rgba(0,0,0,0.12)';
      const type = card.getAttribute('data-type');
      loadHistory(type);
    });
  });
}




// --- å›ç­”ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ­£è¦åŒ–ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ ---
function normalizeAnswer(a){
  // a: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰æ¥ã‚‹å…ƒã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆå¤ã„å½¢å¼ãƒ»æ–°ã—ã„å½¢å¼ã©ã¡ã‚‰ã§ã‚‚ï¼‰
  const selected = (a && (a.selected !== undefined ? a.selected : (a.userAnswer !== undefined ? a.userAnswer : (a.selectedValue !== undefined ? a.selectedValue : null)))) || null;
  const correctAnswers = (a && (a.correctAnswer || a.correctAnswers || a.answer || []));
  // isCorrect ãŒã‚ã‚Œã°å„ªå…ˆã€ãªã‘ã‚Œã° correct (boolean) ã‚’ä½¿ã†
  let isCorrect = (a && typeof a.isCorrect === 'boolean') ? a.isCorrect : (a && typeof a.correct === 'boolean' ? a.correct : null);

  if(isCorrect === null){
    // è‡ªå‹•åˆ¤å®šï¼ˆselected ãŒ null => æœªè§£ç­”ã¨ã™ã‚‹ï¼‰
    if(selected === null || selected === undefined || selected === ''){
      isCorrect = false;
    } else {
      // selected ãŒé…åˆ—ã‹ã©ã†ã‹ã§åˆ¤å®šã‚’åˆ†ã‘ã‚‹
      if(Array.isArray(correctAnswers) && Array.isArray(selected)){
        // é…åˆ—åŒå£«ã‚’ãƒˆãƒªãƒ ã—ã¦æ¯”è¼ƒï¼ˆé †åºã¾ã§ä¸€è‡´ï¼‰
        const eq = selected.length === correctAnswers.length &&
                   selected.every((v,i)=>String(v).trim().toLowerCase() === String(correctAnswers[i]).trim().toLowerCase());
        isCorrect = !!eq;
      } else if(Array.isArray(correctAnswers)){
        // correctAnswers ã®ã„ãšã‚Œã‹ã« selected ãŒä¸€è‡´ã™ã‚Œã°æ­£è§£
        isCorrect = correctAnswers.some(c => String(c).trim().toLowerCase() === String(selected).trim().toLowerCase());
      } else {
        isCorrect = false;
      }
    }
  }

  return {
    question: a && (a.question || a.q || '') || '',
    selected,
    correctAnswers: Array.isArray(correctAnswers) ? correctAnswers : (correctAnswers ? [correctAnswers] : []),
    isCorrect: !!isCorrect,
    score: (a && (a.score || 0)) || 0
  };
}

async function showSavedResult(docId){
  if(!docId) return;
  const content = document.getElementById('content');
  if(!content) return;
  content.innerHTML = `<div class="card"><h2>è©³ç´°ã‚’èª­ã¿è¾¼ã¿ä¸­...</h2></div>`;

  try{
    const dSnap = await getDoc(doc(db,'results',docId));
    if(!dSnap.exists()){
      content.innerHTML = `<div class="card"><h2>è©²å½“ã®è¨˜éŒ²ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</h2></div>`;
      return;
    }
    const d = dSnap.data();
    const created = formatDateForDisplay(d.createdAt);

    let html = `<div class="card">
      <h2>ãƒ†ã‚¹ãƒˆçµæœã®è©³ç´°</h2>
      <div style="margin-top:8px;">
        <p><strong>ãƒ†ã‚¹ãƒˆç¨®åˆ¥:</strong> ${escapeHtml(d.testType || d.type || '')}</p>
        <p><strong>ã‚¹ã‚³ã‚¢:</strong> ${escapeHtml(String(d.score || 0))} ç‚¹</p>
        <p><strong>WPM:</strong> ${Number(d.wpm || 0).toFixed(2)}</p>
        <p><strong>çµŒéç§’æ•°:</strong> ${escapeHtml(String(d.elapsed || 0))} ç§’</p>
        <p><strong>ç·å˜èªæ•°:</strong> ${escapeHtml(String(d.totalWords != null ? d.totalWords : ''))}</p>
        <p style="color:#999;"><strong>ä¿å­˜æ—¥æ™‚:</strong> ${escapeHtml(created)}</p>
      </div>
      <hr style="margin:12px 0;" />
      <h3>è¨­å•ã”ã¨ã®è§£ç­”</h3>
    `;

    const answersRaw = Array.isArray(d.answers) ? d.answers : [];
    if(answersRaw.length === 0){
      html += `<div style="color:#666;padding:12px;border:1px dashed #eef3f5;border-radius:8px">è¨­å•ã”ã¨ã®è¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
    } else {
      answersRaw.forEach((a, idx) => {
        const n = normalizeAnswer(a);
        const status = n.selected === null || n.selected === undefined || n.selected === '' ? 'æœªè§£ç­”' : (n.isCorrect ? 'â­• æ­£è§£' : 'âŒ ä¸æ­£è§£');
        const color = n.selected === null || n.selected === undefined || n.selected === '' ? 'gray' : (n.isCorrect ? 'green' : 'red');

        html += `<div style="margin:8px 0; padding:8px; border-left:4px solid ${color}; background:#fff;">
          <p><strong>Q${idx+1}:</strong> ${escapeHtml(n.question || '')}</p>
          <p><strong>ã‚ãªãŸã®è§£ç­”:</strong> ${escapeHtml(Array.isArray(n.selected) ? n.selected.join(' / ') : (n.selected || 'ãªã—'))}</p>
          <p style="color:${color}; font-weight:bold;">${status}</p>
        </div>`;
      });
    }

    html += `<div style="text-align:right; margin-top:12px;">
        <button class="btn-plain btn-primary" id="back-history-btn">ä¸€è¦§ã«æˆ»ã‚‹</button>
      </div></div>`;

    content.innerHTML = html;

    document.getElementById('back-history-btn').addEventListener('click', ()=> {
      renderHistory();
    });

  }catch(err){
    console.error('showSavedResult error', err);
    content.innerHTML = `<div class="card"><h2>èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h2><div style="color:#c00">${escapeHtml(err.message || err)}</div></div>`;
  }
}



// ãƒ˜ãƒ«ãƒ‘: createdAt ãŒ Timestamp ã‹ Date ã‹åˆ¤å®šã—ã¦è¡¨ç¤ºç”¨ã«æ–‡å­—åˆ—åŒ–
function formatDateForDisplay(createdAt){
  if(!createdAt) return '';
  // Firestore Timestamp ã®å ´åˆ
  if(typeof createdAt.toDate === 'function') {
    return createdAt.toDate().toLocaleString();
  }
  // Date ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚„ ISO æ–‡å­—åˆ—ç­‰
  try {
    const d = (createdAt instanceof Date) ? createdAt : new Date(createdAt);
    return isNaN(d.getTime()) ? '' : d.toLocaleString();
  } catch(e){ return ''; }
}

async function loadHistory(type){
  if(!currentUser){
    alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„');
    return;
  }
  const container = document.getElementById('history-list');
  if(!container) return;
  container.innerHTML = '<div style="color:#666">èª­ã¿è¾¼ã¿ä¸­...</div>';

  try{
    const q = query(
      collection(db,'results'),
      where('uid','==', currentUser.id),
      where('type','==', type),
      orderBy('createdAt','desc')
    );
    const snap = await getDocs(q);
    if(snap.empty){
      container.innerHTML = `<div style="color:#666;padding:12px;border:1px dashed #eef3f5;border-radius:8px">è©²å½“ã™ã‚‹å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
      return;
    }

    let html = '<div style="display:flex;flex-direction:column;gap:8px;">';
    snap.forEach(docSnap=>{
      const d = docSnap.data();
      const created = formatDateForDisplay(d.createdAt);
      html += `
        <div style="padding:12px;border:1px solid #eef3f5;border-radius:8px;background:#fff;display:flex;justify-content:space-between;align-items:center;">
          <div>
            <div style="font-weight:700">${escapeHtml(type)}</div>
            <div style="font-size:14px;color:#666;margin-top:6px;">${escapeHtml(String(d.score || 0))} ç‚¹ â€¢ WPM: ${Number(d.wpm || 0).toFixed(2)} â€¢ ${escapeHtml(String(d.elapsed || 0))} ç§’</div>
            <div style="font-size:12px;color:#999;margin-top:6px;">${escapeHtml(created)}</div>
          </div>
          <div style="display:flex;flex-direction:column;gap:6px;">
            <button class="btn-plain" data-id="${docSnap.id}" data-action="detail">ãã‚ã—ãè¦‹ã‚‹</button>
            <button class="btn-plain" data-id="${docSnap.id}" data-action="download" style="display:none">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
          </div>
        </div>
      `;
    });
    html += '</div>';
    container.innerHTML = html;

    // attach handlers
    container.querySelectorAll('button[data-action="detail"]').forEach(btn=>{
      btn.addEventListener('click', ()=> showSavedResult(btn.getAttribute('data-id')));
    });

  }catch(err){
    console.error('loadHistory error', err);
    container.innerHTML = `<div style="color:#c00">å±¥æ­´ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${escapeHtml(err.message || err)}</div>`;
  }
}

    // ===== å•é¡Œä½œæˆï¼ˆä»¥å‰ã®ã²ãªå½¢ãã®ã¾ã¾ï¼‰ =====
    function renderCreateForm(){
      document.getElementById('content').innerHTML = `
        <div class="card">
          <h2>å•é¡Œä½œæˆï¼ˆç®¡ç†è€…ï¼‰</h2>
          <div>
            <label>è‹±æ–‡ï¼ˆPassageï¼‰</label>
            <textarea id="part-passage" rows="6" style="width:100%; padding:8px; border-radius:6px; border:1px solid #d0d7dc;"></textarea>
          </div>
          <div id="questions-area" style="margin-top:12px;"></div>
          <div style="margin-top:10px; display:flex; gap:8px;">
            <button id="add-question" class="btn-plain btn-primary">è¨­å•ã‚’è¿½åŠ </button>
            <button id="save-part" class="btn-plain" style="background:#2c3e50;color:#fff">ä¿å­˜</button>
          </div>
        </div>
      `;
      document.getElementById('add-question').addEventListener('click', ()=> addQuestionBlock());
      document.getElementById('save-part').addEventListener('click', ()=> savePartToFirestore());
      addQuestionBlock();
    }

    function addQuestionBlock(){
      const qArea = document.getElementById('questions-area');
      const div = document.createElement('div');
      div.className = 'q-block';
      div.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <strong>è¨­å•</strong>
          <div>
            <button class="btn-plain btn-danger btn-delete-q" type="button">è¨­å•ã‚’å‰Šé™¤</button>
          </div>
        </div>
        <input class="q-text" type="text" placeholder="è¨­å•æ–‡ã‚’å…¥åŠ›" style="width:100%; margin-top:8px; padding:8px; border-radius:6px; border:1px solid #d0d7dc;" />
        <div class="choices-area" style="margin-top:8px;"></div>
        <div style="margin-top:6px;">
          <button class="btn-plain btn-secondary btn-add-choice" type="button">é¸æŠè‚¢ã‚’è¿½åŠ </button>
        </div>
      `;
      qArea.appendChild(div);
      div.querySelector('.btn-delete-q').addEventListener('click', ()=> div.remove());
      div.querySelector('.btn-add-choice').addEventListener('click', ()=> addChoiceRow(div));
      // add two default choices
      addChoiceRow(div); addChoiceRow(div);
    }

    function addChoiceRow(qBlock, choice=null){
      const area = qBlock.querySelector('.choices-area');
      const div = document.createElement('div');
      div.className = 'choice-row';
      div.innerHTML = `
        <input type="text" class="choice-text" placeholder="é¸æŠè‚¢ãƒ†ã‚­ã‚¹ãƒˆ"/>
        <input type="number" class="choice-score" placeholder="ã‚¹ã‚³ã‚¢" value="0" />
        <select class="choice-correct">
          <option value="false">ä¸æ­£è§£</option>
          <option value="true">æ­£è§£</option>
        </select>
        <button class="btn-plain btn-danger btn-del-choice" type="button">å‰Šé™¤</button>
      `;
      area.appendChild(div);
      div.querySelector('.btn-del-choice').addEventListener('click', ()=> div.remove());
      if(choice){
        div.querySelector('.choice-text').value = choice.text || '';
        div.querySelector('.choice-score').value = (choice.score!=null) ? choice.score : 0;
        div.querySelector('.choice-correct').value = choice.correct ? 'true' : 'false';
      }
    }

    // ===== Firestore: ä¿å­˜ï¼ˆaddDocï¼‰ =====
    async function savePartToFirestore(){
      const passage = document.getElementById('part-passage').value.trim();
      if(!passage){ alert('è‹±æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
      const qNodes = document.querySelectorAll('.q-block');
      const questions = [];
      qNodes.forEach(q=>{
        const text = q.querySelector('.q-text').value.trim();
        const choices = [];
        q.querySelectorAll('.choice-row').forEach(c=>{
          const chText = c.querySelector('.choice-text').value.trim();
          const chScore = Number(c.querySelector('.choice-score').value || 0);
          const chCorrect = c.querySelector('.choice-correct') ? (c.querySelector('.choice-correct').value === 'true') : false;
          choices.push({ text: chText, score: chScore, correct: chCorrect });
        });
        if(text) questions.push({ text, choices });
      });
      if(questions.length===0){ alert('è¨­å•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

      try{
        await addDoc(collection(db,'parts'), {
          passage,
          questions,
          createdBy: currentUser ? currentUser.id : 'unknown',
          createdAt: new Date()
        });
        alert('ä¿å­˜ã—ã¾ã—ãŸï¼');
        renderCreateForm();
      }catch(err){
        console.error(err);
        alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (err.message || err));
      }
    }

   

// ===== ãƒ†ã‚¹ãƒˆå®Ÿè£…éƒ¨åˆ†ï¼ˆæ”¹è‰¯ãƒ»ç½®æ›ç”¨ï¼‰ =====
let testActive = false;
let testStartTime = 0;
let testRemaining = 0;
let testTimerInterval = null;
let partPool = []; // all parts from Firestore
let usedIds = [];
let totalWords = 0;
let obtainedScore = 0;
let fullScore = 0;
let answers = []; // è§£ç­”ãƒ­ã‚°ã‚’ä¿å­˜

function disableMenus(flag){
  ['menu-userinfo','menu-test','menu-history','menu-create','menu-list','menu-audio','menu-studylog'].forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    if(flag) el.classList.add('disabled'); else el.classList.remove('disabled');
  });
}

async function startTest(){
  console.log('DEBUG: startTest called');
  const snap = await getDocs(collection(db,'parts'));
  partPool = [];
  snap.forEach(doc => partPool.push({ id: doc.id, ...doc.data() }));
  if(partPool.length === 0){ alert('ã¾ã å•é¡ŒãŒä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚'); return; }

  // init
  testActive = true;
  usedIds = [];
  totalWords = 0;
  obtainedScore = 0;
  fullScore = 0;
  answers = [];
  testStartTime = Date.now();
  testRemaining = 15 * 60; // 15 minutes

  const testTimerEl = document.getElementById('test-timer');
  if (testTimerEl) testTimerEl.classList.remove('hidden');

  updateTestTimerDisplay();
  if(testTimerInterval) clearInterval(testTimerInterval);
  testTimerInterval = setInterval(()=>{
    testRemaining--;
    updateTestTimerDisplay();
    if(testRemaining <= 0){
      // ã‚¿ã‚¤ãƒ ã‚¢ãƒƒãƒ—æ™‚ã¯çµæœã¸
      endTest().catch(err => console.error('endTest error on timeout', err));
    }
  }, 1000);
  disableMenus(true);
  showNextPart();
}

function updateTestTimerDisplay(){
  const mm = String(Math.floor(testRemaining / 60)).padStart(2, '0');
  const ss = String(testRemaining % 60).padStart(2, '0');
  const el = document.getElementById('test-timer');
  if (el) el.textContent = `ãƒ†ã‚¹ãƒˆæ®‹ã‚Š: ${mm}:${ss}`;
}

function pickRandomPart(){
  const remaining = partPool.filter(p => !usedIds.includes(p.id));
  if(remaining.length === 0) return null;
  const idx = Math.floor(Math.random() * remaining.length);
  return remaining[idx];
}

function showNextPart(){
  if(!testActive) return;
  const part = pickRandomPart();
  if(!part){
    // no more parts â†’ çµæœã¸
    endTest().catch(err => console.error('endTest error (no more parts)', err));
    return;
  }
  usedIds.push(part.id);

  // compute word count for this part and add
  const words = (part.passage || '').trim().split(/\s+/).filter(Boolean).length;
  totalWords += words;

  // compute this part's max score
  let partMax = 0;
  (part.questions || []).forEach(q=>{
    (q.choices || []).forEach(c=>{
      if(typeof c.correct === 'boolean' ? c.correct : String(c.correct) === 'true'){
        partMax += Number(c.score || 0);
      }
    });
  });
  fullScore += partMax;

  // render part
  let html = `<div class="card"><h2>Part</h2><div style="white-space:pre-line;margin-bottom:12px">${escapeHtml(part.passage||'')}</div>`;
  (part.questions || []).forEach((q, qi) => {
    html += `<div class="q-block"><p>${escapeHtml(q.text||'')}</p>`;
    (q.choices || []).forEach((c, ci) => {
      const scoreAttr = Number(c.score || 0);
      const correctAttr = (typeof c.correct === 'boolean' ? c.correct : String(c.correct) === 'true') ? 'true' : 'false';
      // data-text ã¯ç”Ÿãƒ†ã‚­ã‚¹ãƒˆï¼ˆã‚¨ã‚¹ã‚±ãƒ¼ãƒ—æ¸ˆï¼‰ã‚’å…¥ã‚Œã¦ãŠã
      html += `<div><label><input type="radio" name="q${qi}" data-score="${scoreAttr}" data-correct="${correctAttr}" data-text="${escapeHtml(c.text||'')}"> ${escapeHtml(c.text||'')}</label></div>`;
    });
    html += `</div>`;
  });
  html += `<div style="text-align:right;margin-top:10px;"><button class="btn-plain btn-primary" id="next-part-btn">æ¬¡ã®Partã¸</button></div></div>`;
  document.getElementById('content').innerHTML = html;

  // next handler
  const nextBtn = document.getElementById('next-part-btn');
  if(!nextBtn){
    console.warn('next-part-btn ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    return;
  }
  nextBtn.addEventListener('click', ()=> {
    console.log('DEBUG: next-part clicked for part id', part.id);
    const qCount = (part.questions || []).length;
    for(let qi=0; qi<qCount; qi++){
      const sel = document.querySelector(`input[name="q${qi}"]:checked`);
      if(sel){
        const s = Number(sel.dataset.score || 0);
        obtainedScore += s;
        const correct = (sel.dataset.correct === "true");
        const selected = sel.dataset.text || null;

        // æ­£ã—ã„ç­”ãˆã‚’æŠ½å‡ºï¼ˆé…åˆ—ï¼‰
        const correctAnswers = (part.questions[qi].choices || [])
          .filter(c => (typeof c.correct === 'boolean' ? c.correct : String(c.correct) === 'true'))
          .map(c => c.text);

        answers.push({
          question: part.questions[qi].text,
          selected,
          correct,
          score: s,
          correctAnswer: correctAnswers
        });
      } else {
        // æœªè§£ç­”
        const correctAnswers = (part.questions[qi].choices || [])
          .filter(c => (typeof c.correct === 'boolean' ? c.correct : String(c.correct) === 'true'))
          .map(c => c.text);

        answers.push({
          question: part.questions[qi].text,
          selected: null,
          correct: false,
          score: 0,
          correctAnswer: correctAnswers
        });
      }
    }

    // æ®‹ã‚Šã®ãƒ‘ãƒ¼ãƒˆãŒã‚ã‚Œã°æ¬¡ã¸ã€ãªã‘ã‚Œã° endTest
    const remaining = partPool.filter(p => !usedIds.includes(p.id));
    if(remaining.length === 0){
      endTest().catch(err => console.error('endTest error from next handler', err));
    } else {
      showNextPart();
    }
  }, { once: true }); // è¤‡æ•°ãƒã‚¤ãƒ³ãƒ‰ã‚’é¿ã‘ã‚‹ãŸã‚ once:true
}

async function endTest(){
  try {
    console.log('DEBUG: endTest start');
    if(!testActive) return;
    stopTest();

    const elapsed = Math.floor((Date.now() - testStartTime) / 1000);
    const elapsedSec = elapsed > 0 ? elapsed : 1;
    const scoreRatio = fullScore > 0 ? (obtainedScore / fullScore) : 0;
    const wpm = (totalWords / elapsedSec * 60) * scoreRatio;

    // ãƒ©ãƒ³ã‚¯åˆ¤å®šï¼ˆã”æŒ‡å®šã®é–¾å€¤ã¯ã€Œè¶…ãˆã‚‹ã¨ã€ãªã®ã§ > ã‚’ä½¿ç”¨ï¼‰
    let rank = "ãƒãƒ¼ãƒãƒ«";
    let rankColor = "#2c3e50";
    if(obtainedScore > 75){ rank = "ãƒ—ãƒ©ãƒãƒŠ"; rankColor = "#bcd"; } // è–„ã„è‰²
    else if(obtainedScore > 61){ rank = "ã‚´ãƒ¼ãƒ«ãƒ‰"; rankColor = "#ffd700"; }
    else if(obtainedScore > 50){ rank = "ã‚·ãƒ«ãƒãƒ¼"; rankColor = "#c0c0c0"; }
    else if(obtainedScore > 41){ rank = "ãƒ–ãƒ­ãƒ³ã‚º"; rankColor = "#cd7f32"; }

    // ã¾ãšç”»é¢ã‚’è¡¨ç¤ºï¼ˆä¿å­˜ã¯å¾Œå›ã—ï¼‰
    renderResultScreen({ rank, rankColor, obtainedScore, wpm, elapsedSec, totalWords });

    // éåŒæœŸã§ä¿å­˜ï¼ˆå¤±æ•—ã—ã¦ã‚‚æç”»ã¯æ­¢ã‚ãªã„ï¼‰
    (async () => {
      try {
        const uid = currentUser ? currentUser.id : 'guest';
        await addDoc(collection(db,"results"),{
          uid,
          type: "é€Ÿèª­åŠ›æ¸¬å®šãƒ†ã‚¹ãƒˆ", // â† è¿½åŠ : ãƒ†ã‚¹ãƒˆç¨®åˆ¥
          score: obtainedScore,
          fullScore,
          elapsed: elapsedSec,
          wpm,
          rank,
          answers,
          createdAt: new Date()
        });
        await addBnp(obtainedScore);
        console.log('results saved');
      } catch(saveErr){
        console.warn('results save failed', saveErr);
      }
    })();

    disableMenus(false);
  } catch (err) {
    console.error('endTest å†…ã§ä¾‹å¤–:', err);
    alert('çµæœè¡¨ç¤ºã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚Console ã‚’ç¢ºèªã—ã¦ãã ã•ã„: ' + (err && err.message ? err.message : err));
  }
}

// çµæœç”»é¢ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’åˆ†é›¢ï¼ˆãƒ¬ãƒ“ãƒ¥ãƒ¼ã¸æˆ»ã‚‹éš›ã« endTest ã‚’å†å®Ÿè¡Œã—ãªã„ãŸã‚ï¼‰
function renderResultScreen({ rank, rankColor, obtainedScore, wpm, elapsedSec, totalWords }){
  // ãƒ©ãƒ³ã‚¯ã«å¿œã˜ã¦ãƒˆãƒ­ãƒ•ã‚£ãƒ¼ã‚’è¡¨ç¤º
  let trophyHtml = "";
  if(rank !== "ãƒ–ãƒ­ãƒ³ã‚º"){ // ãƒ–ãƒ­ãƒ³ã‚ºä»¥ä¸Šã ã‘è¡¨ç¤º
    let size = "80px";
    if(rank === "ã‚·ãƒ«ãƒãƒ¼"){ size = "90px"; }
    if(rank === "ã‚´ãƒ¼ãƒ«ãƒ‰"){ size = "100px"; }
    if(rank === "ãƒ—ãƒ©ãƒãƒŠ"){ size = "110px"; }

    trophyHtml = `
      <div style="font-size:${size}; color:${rankColor}; text-align:center; margin-bottom:10px;">
        <i class="fas fa-trophy trophy-anim"></i>
      </div>
    `;
  }

  document.getElementById('content').innerHTML = `
    <div class="card" style="border:3px solid ${rankColor}; text-align:center; padding:20px;">
      <h2 style="color:${rankColor}; margin:0 0 8px 0;">${escapeHtml(rank)}</h2>
      ${trophyHtml}
      <div style="font-size:2.8em; font-weight:bold; color:${rankColor}; margin:10px 0;">
        ${obtainedScore}
      </div>
      <div style="text-align:right; margin-top:10px;">
        <p style="margin:0 0 6px 0;"><strong>WPM:</strong> ${wpm.toFixed(2)}</p>
        <p style="margin:0 0 6px 0;"><strong>çµŒéç§’æ•°:</strong> ${elapsedSec}</p>
        <p style="margin:0;"><strong>ç·å˜èªæ•°:</strong> ${totalWords}</p>
      </div>
      <div style="text-align:right; margin-top:12px;">
        <button class="btn-plain" id="review-btn">ãã‚ã—ãè¦‹ã‚‹</button>
        <button class="btn-plain btn-primary" id="close-btn">çµæœç”»é¢ã‚’é–‰ã˜ã‚‹</button>
      </div>
    </div>
  `;

  // ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²
  const reviewBtn = document.getElementById('review-btn');
  if(reviewBtn) reviewBtn.addEventListener('click', showDetailedReview);
  const closeBtn = document.getElementById('close-btn');
  if(closeBtn) closeBtn.addEventListener('click', ()=> {
    // ãƒ›ãƒ¼ãƒ ã«æˆ»ã™ï¼ˆæ—¢å­˜ã® renderHomeã‚’ä½¿ã†ï¼‰
    if(typeof renderHome === 'function') renderHome();
    else document.getElementById('content').innerHTML = `<div class="card"><h2>ãƒ›ãƒ¼ãƒ </h2></div>`;
  });
}

function showDetailedReview(){
  let html = `<div class="card"><h2>ãƒ†ã‚¹ãƒˆè¦‹ç›´ã—</h2>`;
  answers.forEach((a, idx) => {
  let status, color;

  if (!a.selected) {
    status = "æœªè§£ç­”";
    color = "gray";
  } else if (a.correct) {
    status = "â­• æ­£è§£";
    color = "green";
  } else {
    status = "âŒ ä¸æ­£è§£";
    color = "red";
  }

  html += `<div style="margin:8px 0; padding:8px; border-left:4px solid ${color}; background:#fff;">
    <p><strong>Q${idx+1}:</strong> ${escapeHtml(a.question || '')}</p>
    <p><strong>ã‚ãªãŸã®è§£ç­”:</strong> ${escapeHtml(a.selected || 'ãªã—')}</p>
    <p style="color:${color}; font-weight:bold;">${status}</p>
  </div>`;
});



  html += `<div style="text-align:right; margin-top:12px;">
      <button class="btn-plain btn-primary" id="back-result-btn">çµæœç”»é¢ã«æˆ»ã‚‹</button>
    </div></div>`;
  document.getElementById('content').innerHTML = html;
  const backBtn = document.getElementById('back-result-btn');
  if(backBtn) backBtn.addEventListener('click', ()=> {
    // å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆçµæœã®æ•°å€¤ã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«æ®‹ã£ã¦ã„ã‚‹ï¼‰
    const elapsed = Math.floor((Date.now() - testStartTime) / 1000);
    const elapsedSec = elapsed > 0 ? elapsed : 1;
    const scoreRatio = fullScore > 0 ? (obtainedScore / fullScore) : 0;
    const wpm = (totalWords / elapsedSec * 60) * scoreRatio;
    let rank = "ãƒãƒ¼ãƒãƒ«";
    let rankColor = "#2c3e50";
    if(obtainedScore > 80){ rank = "ãƒ—ãƒ©ãƒãƒŠ"; rankColor = "#bcd"; }
    else if(obtainedScore > 67){ rank = "ã‚´ãƒ¼ãƒ«ãƒ‰"; rankColor = "#ffd700"; }
    else if(obtainedScore > 52){ rank = "ã‚·ãƒ«ãƒãƒ¼"; rankColor = "#c0c0c0"; }
    else if(obtainedScore > 43){ rank = "ãƒ–ãƒ­ãƒ³ã‚º"; rankColor = "#cd7f32"; }

    renderResultScreen({ rank, rankColor, obtainedScore, wpm, elapsedSec, totalWords });
  });
}

function stopTest(){
  testActive = false;
  if(testTimerInterval) { clearInterval(testTimerInterval); testTimerInterval = null; }
  const el = document.getElementById('test-timer');
  if (el) el.classList.add('hidden');
}

// helper: escapeHtml to keep layout safe
function escapeHtml(s){
  if(!s) return '';
  return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}
// ===== ãƒ†ã‚¹ãƒˆå®Ÿè£…éƒ¨åˆ†ï¼ˆæ”¹è‰¯ç‰ˆï¼‰ã“ã“ã¾ã§ =====




    // ===== å•é¡Œä¸€è¦§ï¼ˆç®¡ç†è€…ï¼‰ & ç·¨é›†æ©Ÿèƒ½ =====
    async function loadPartsList(){
      try{
        const q = query(collection(db,'parts'), orderBy('createdAt','desc'));
        const snap = await getDocs(q);
        let html = `<div class="card"><h2>å•é¡Œä¸€è¦§</h2>`;
        if (snap.empty) {
          html += `<div style="margin-top:12px;padding:12px;border:1px dashed #eef3f5;border-radius:8px;color:#666">ä¿å­˜ã•ã‚ŒãŸå•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
        } else {
          snap.forEach(documentSnap => {
            const d = documentSnap.data();
            html += `<div class="part-item">
              <div style="font-weight:700">ID: ${documentSnap.id}</div>
              <div style="color:#555;margin-top:6px">${escapeHtml((d.passage||'').slice(0,200))}${(d.passage||'').length>200?'...':''}</div>
              <div style="margin-top:8px;">è¨­å•æ•°: ${(d.questions||[]).length}</div>
              <div class="part-actions">
                <button class="btn-plain btn-primary" data-action="edit" data-id="${documentSnap.id}">ç·¨é›†</button>
                <button class="btn-plain btn-danger" data-action="delete" data-id="${documentSnap.id}">å‰Šé™¤</button>
              </div>
            </div>`;
          });
        }
        html += `</div>`;
        document.getElementById('content').innerHTML = html;

        // attach handlers
        Array.from(document.querySelectorAll('button[data-action]')).forEach(b=>{
          b.addEventListener('click', async ()=>{
            const action = b.getAttribute('data-action');
            const id = b.getAttribute('data-id');
            if(action === 'delete'){
              if(confirm('ã“ã®å•é¡Œã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){
                try {
                  await deleteDoc(doc(db,'parts',id));
                  alert('å‰Šé™¤ã—ã¾ã—ãŸ');
                  loadPartsList(); // immediate refresh
                } catch(err) {
                  console.error(err);
                  alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (err.message || err));
                }
              }
            } else if(action === 'edit'){
              editPart(id);
            }
          });
        });
      }catch(err){
        console.error(err);
        alert('ä¸€è¦§å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // editPart: load doc and render create-form populated, then update on save
    async function editPart(id){
      try{
        const docRef = doc(db,'parts',id);
        const snap = await getDoc(docRef);
        if(!snap.exists()){
          alert('è©²å½“ã®PartãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          return;
        }
        const d = snap.data();

        // render same create form but we fill values and change save handler to update
        document.getElementById('content').innerHTML = `
          <div class="card">
            <h2>å•é¡Œç·¨é›†</h2>
            <div>
              <label>è‹±æ–‡ï¼ˆPassageï¼‰</label>
              <textarea id="part-passage" rows="6" style="width:100%; padding:8px; border-radius:6px; border:1px solid #d0d7dc;"></textarea>
            </div>
            <div id="questions-area" style="margin-top:12px;"></div>
            <div style="margin-top:10px; display:flex; gap:8px;">
              <button id="add-question" class="btn-plain btn-primary">è¨­å•ã‚’è¿½åŠ </button>
              <button id="save-part" class="btn-plain" style="background:#2c3e50;color:#fff">å¤‰æ›´ã‚’ä¿å­˜</button>
            </div>
          </div>
        `;
        document.getElementById('add-question').addEventListener('click', ()=> addQuestionBlock());
        // populate
        document.getElementById('part-passage').value = d.passage || '';
        const qArea = document.getElementById('questions-area');
        qArea.innerHTML = '';
        (d.questions || []).forEach(qobj=>{
          const div = document.createElement('div');
          div.className = 'q-block';
          div.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <strong>è¨­å•</strong>
              <div>
                <button class="btn-plain btn-danger btn-delete-q" type="button">è¨­å•ã‚’å‰Šé™¤</button>
              </div>
            </div>
            <input class="q-text" type="text" placeholder="è¨­å•æ–‡ã‚’å…¥åŠ›" style="width:100%; margin-top:8px; padding:8px; border-radius:6px; border:1px solid #d0d7dc;" />
            <div class="choices-area" style="margin-top:8px;"></div>
            <div style="margin-top:6px;">
              <button class="btn-plain btn-secondary btn-add-choice" type="button">é¸æŠè‚¢ã‚’è¿½åŠ </button>
            </div>
          `;
          qArea.appendChild(div);
          div.querySelector('.btn-delete-q').addEventListener('click', ()=> div.remove());
          div.querySelector('.btn-add-choice').addEventListener('click', ()=> addChoiceRow(div));
          div.querySelector('.q-text').value = qobj.text || '';
          const choicesArea = div.querySelector('.choices-area');
          choicesArea.innerHTML = '';
          (qobj.choices || []).forEach(ch=>{
            addChoiceRow(div, { text: ch.text, score: ch.score, correct: ch.correct });
          });
        });

        // save (update) handler
        const saveBtn = document.getElementById('save-part');
        const handler = async ()=>{
          const passage = document.getElementById('part-passage').value.trim();
          const questions = [];
          document.querySelectorAll('.q-block').forEach(q=>{
            const text = q.querySelector('.q-text').value.trim();
            const choices = [];
            q.querySelectorAll('.choice-row').forEach(c=>{
              const chText = c.querySelector('.choice-text').value.trim();
              const chScore = Number(c.querySelector('.choice-score').value || 0);
              const chCorrect = c.querySelector('.choice-correct') ? (c.querySelector('.choice-correct').value === 'true') : false;
              choices.push({ text: chText, score: chScore, correct: chCorrect });
            });
            if(text) questions.push({ text, choices });
          });
          if(questions.length===0){ alert('è¨­å•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
          try{
            await updateDoc(docRef, { passage, questions, updatedAt: new Date() });
            alert('æ›´æ–°ã—ã¾ã—ãŸ');
            loadPartsList(); // immediate reflect in list
          }catch(err){
            console.error(err);
            alert('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (err.message||err));
          } finally {
            saveBtn.removeEventListener('click', handler);
          }
        };
        saveBtn.addEventListener('click', handler);

      }catch(err){
        console.error(err);
        alert('ç·¨é›†ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

/* ================= æ–‡æ³•ç‰¹è¨“ï¼ˆç®¡ç†è€…ä½œæˆ + å­¦ç¿’è€…å‘ã‘ 50 å•ç‰¹è¨“ï¼‰ ================= */

// === æ–‡æ³•ç‰¹è¨“ç”¨ã‚¿ã‚¤ãƒãƒ¼ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ï¼‰ ===
let grammarTimerInterval = null;
let grammarRemaining = 0;

// ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤ºæ›´æ–°ï¼ˆ#test-timer ã‚’ä½¿ã†ï¼‰
function updateGrammarTimer(){
  const el = document.getElementById('test-timer');
  if(!el) return;
  const mm = String(Math.floor(grammarRemaining / 60)).padStart(2,'0');
  const ss = String(grammarRemaining % 60).padStart(2,'0');
  el.textContent = `æ–‡æ³•æ®‹ã‚Š: ${mm}:${ss}`;
}

// ----- ãƒãƒŠãƒæ“ä½œãƒ˜ãƒ«ãƒ‘ãƒ¼ -----
// users/<userid>.banapo ã«åŠ ç®—ã™ã‚‹ã‚·ãƒ³ãƒ—ãƒ«å®Ÿè£…
async function addBanapo(amount){
  if(!currentUser || !currentUser.id) return;
  amount = Number(amount || 0);
  if(amount <= 0) return;
  try{
    const uRef = doc(db,'users', currentUser.id);
    const snap = await getDoc(uRef);
    if(snap.exists()){
      const d = snap.data();
      const cur = Number(d.banapo || 0) || 0;
      await updateDoc(uRef, { banapo: cur + amount });
    } else {
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒãªã‘ã‚Œã°ä½œã‚‹ï¼ˆmergeã§ä»–é …ç›®ã‚’å£Šã•ãªã„ï¼‰
      await setDoc(uRef, { username: currentUser.id, banapo: amount }, { merge: true });
    }
    // ãƒ˜ãƒƒãƒ€ãƒ¼è¡¨ç¤ºãŒã‚ã‚Œã°æ›´æ–°
    if(typeof refreshHeaderBanapoDisplay === 'function') {
      try { refreshHeaderBanapoDisplay(); } catch(e){ /* ignore */ }
    } else {
      // äº’æ›æ€§ã®ãŸã‚ã€ã„ãã¤ã‹ã®IDã‚’è©¦ã—ã¦æ›´æ–°
      const el = document.getElementById('banapo-amount') || document.getElementById('banapo-display') || document.getElementById('banapo-val') || document.getElementById('banapo-number');
      if(el){
        // éåŒæœŸã«æœ€æ–°å€¤ã‚’å–ã‚Šã«è¡Œã
        const snap2 = await getDoc(uRef);
        const newVal = snap2.exists() ? Number(snap2.data().banapo || 0) : 0;
        el.textContent = `${newVal} bnp`;
      }
    }
  }catch(err){
    console.warn('addBanapo error', err);
  }
}

// ----- ç®¡ç†ç”¨ç”»é¢ï¼ˆãã®ã¾ã¾ï¼‰ -----
async function renderGrammarAdminHome(){
  document.getElementById('content').innerHTML = `
    <div class="card">
      <h2>æ–‡æ³•å•é¡Œä½œæˆï¼ˆç®¡ç†è€…ï¼‰</h2>
      <div style="display:flex;gap:12px;margin-top:12px;">
        <div class="card" style="flex:1;cursor:pointer;text-align:center" id="grammar-add-card">
          <h3>è¿½åŠ ä½œæˆ</h3>
          <p>æ–°ã—ã„æ–‡æ³•å•é¡Œã‚’è¿½åŠ ã—ã¾ã™</p>
        </div>
        <div class="card" style="flex:1;cursor:pointer;text-align:center" id="grammar-edit-card">
          <h3>ç·¨é›† / å‰Šé™¤</h3>
          <p>æ—¢å­˜å•é¡Œã‚’ä¸€è¦§ãƒ»ç·¨é›†ãƒ»å‰Šé™¤ã—ã¾ã™</p>
        </div>
      </div>
    </div>
  `;
  document.getElementById('grammar-add-card').addEventListener('click', renderGrammarAddForm);
  document.getElementById('grammar-edit-card').addEventListener('click', renderGrammarEditList);
}

function sanitizeCsvToArray(s){
  if(!s) return [];
  return s.split(',').map(x=>x.trim()).filter(Boolean);
}

function renderGrammarAddForm(){
  document.getElementById('content').innerHTML = `
    <div class="card">
      <h2>æ–‡æ³•å•é¡Œã‚’è¿½åŠ </h2>
      <div style="display:flex;flex-direction:column;gap:8px;">
        <label>å½¢å¼:
          <select id="g-type">
            <option value="multiple">æŠä¸€ (multiple)</option>
            <option value="reorder">ä¸¦ã¹æ›¿ãˆ (reorder)</option>
            <option value="fill">é©èªè£œå…… (fill)</option>
            <option value="translate">å’Œæ–‡è‹±è¨³ (translate)</option>
          </select>
        </label>
        <label>è¨­å•æ–‡:<br>
  <textarea id="g-question" rows="4" style="width:100%; padding:8px; resize:vertical;"></textarea>
</label>
        <label id="label-choices">é¸æŠè‚¢ / å˜èª (ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š):<br><textarea id="g-choices" style="width:100%;height:80px;padding:8px;"></textarea></label>
        <label>æ­£è§£ (ä¸¦ã³ãƒ»å˜èªã¯ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§):<br><input type="text" id="g-answer" style="width:100%; padding:8px;" /></label>
        <label>ã‚¹ã‚³ã‚¢:<br><input type="number" id="g-score" value="1" style="width:120px; padding:6px;" /></label>
        <div style="display:flex;gap:8px;">
          <button id="g-save" class="btn-plain btn-primary">ä¿å­˜</button>
          <button id="g-cancel" class="btn-plain">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
        <div style="font-size:12px;color:#666">
          â€»ã€Œä¸¦ã¹æ›¿ãˆã€ã¯ choices ã«ã‚«ãƒ¼ãƒ‰ã®èªã‚’ã€answer ã«æ­£ã—ã„é †ã‚’ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§å…¥ã‚Œã¦ãã ã•ã„ã€‚<br>
          â€»ã€Œé©èªè£œå……ã€ã€Œå’Œæ–‡è‹±è¨³ã€ã¯ answer ã«æ­£ç­”æ–‡å­—åˆ—ï¼ˆè¤‡æ•°å¯ï¼‰ã‚’ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§å…¥åŠ›ã€‚
        </div>
      </div>
    </div>
  `;

  // ä¿å­˜
  document.getElementById('g-save').addEventListener('click', async ()=>{
    const type = document.getElementById('g-type').value;
    const question = (document.getElementById('g-question')||{value:''}).value.trim();
    const choices = sanitizeCsvToArray((document.getElementById('g-choices')||{value:''}).value);
    const answer = sanitizeCsvToArray((document.getElementById('g-answer')||{value:''}).value);
    const score = Number((document.getElementById('g-score')||{value:1}).value) || 1;
    if(!question){ alert('è¨­å•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    try{
      await addDoc(collection(db,'grammarQuestions'), {
        type, question, choices, answer, score, createdBy: currentUser ? currentUser.id : 'unknown', createdAt: new Date()
      });
      alert('ä¿å­˜ã—ã¾ã—ãŸ');
      renderGrammarAdminHome();
    }catch(err){
      console.error('grammar save err', err);
      alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (err.message || err));
    }
  });

  document.getElementById('g-cancel').addEventListener('click', ()=> renderGrammarAdminHome());
}

// æ—¢å­˜ã® renderGrammarEditList ã‚’ã“ã®é–¢æ•°ã§ä¸¸ã”ã¨ç½®ãæ›ãˆã¦ãã ã•ã„
async function renderGrammarEditList(){
  try{
    const container = document.getElementById('content');
    if(!container) return;

    // UIï¼ˆæ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ï¼‹ä¸€è¦§é ˜åŸŸï¼‰
    container.innerHTML = `
      <div class="card">
        <h2>æ–‡æ³•å•é¡Œ ä¸€è¦§ï¼ˆç·¨é›†ï¼‰</h2>

        <div style="display:flex;gap:8px;margin-top:8px;align-items:center;">
          <input type="text" id="grammar-search-input" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢ï¼ˆè¨­å•ãƒ»å½¢å¼ãƒ»é¸æŠè‚¢ã‚’éƒ¨åˆ†ä¸€è‡´ï¼‰..." style="flex:1;padding:8px;">
          <button id="grammar-search-clear" class="btn-plain" style="white-space:nowrap;">ã‚¯ãƒªã‚¢</button>
        </div>

        <div id="grammar-meta" style="margin-top:8px;color:#666;font-size:13px;"></div>
        <div id="grammar-list" style="margin-top:12px;"></div>
      </div>
    `;

    const listEl = document.getElementById('grammar-list');
    const metaEl = document.getElementById('grammar-meta');
    const inputEl = document.getElementById('grammar-search-input');
    const clearBtn = document.getElementById('grammar-search-clear');

    // Firestore ã‹ã‚‰å…¨ä»¶å–å¾—ï¼ˆç®¡ç†è€…ãŒæ‰±ã†æƒ³å®šãªã®ã§ä¸€åº¦ã«å–å¾—ã—ã¦ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§çµã‚‹ï¼‰
    const qRef = query(collection(db,'grammarQuestions'), orderBy('createdAt','desc'));
    const snap = await getDocs(qRef);
    const allQuestions = snap.docs.map(d => ({ id: d.id, ...d.data() }));

    // ç©ºãƒã‚§ãƒƒã‚¯
    if(allQuestions.length === 0){
      listEl.innerHTML = `<div style="padding:12px;color:#666">å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
      metaEl.textContent = `åˆè¨ˆ: 0 å•`;
      return;
    }

    // æç”»é–¢æ•°ï¼ˆé…åˆ—ã‚’å—ã‘å–ã£ã¦ä¸€è¦§ã‚’æç”»ï¼‰
    function renderList(arr){
      if(!arr || arr.length === 0){
        listEl.innerHTML = `<div style="padding:12px;color:#666">è©²å½“ã™ã‚‹å•é¡Œã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
        metaEl.textContent = `è¡¨ç¤º: 0 / åˆè¨ˆ: ${allQuestions.length} å•`;
        return;
      }

      metaEl.textContent = `è¡¨ç¤º: ${arr.length} / åˆè¨ˆ: ${allQuestions.length} å•`;
      listEl.innerHTML = arr.map(item => {
        const d = item || {};
        return `
          <div style="border:1px solid #eef3f5;padding:8px;margin-top:8px;border-radius:6px;">
            <div><strong>${escapeHtml(d.type||'')}</strong> â€” ${escapeHtml((d.question||'').slice(0,200))}</div>
            <div style="margin-top:6px;font-size:13px;color:#666">
              ã‚¹ã‚³ã‚¢: ${escapeHtml(String(d.score || ''))} â€¢ ä½œæˆè€…: ${escapeHtml(d.createdBy || '')}
            </div>
            <div style="margin-top:8px;display:flex;gap:8px;">
              <button class="btn-plain btn-primary" data-action="edit" data-id="${d.id}">ç·¨é›†</button>
              <button class="btn-plain btn-danger" data-action="delete" data-id="${d.id}">å‰Šé™¤</button>
            </div>
          </div>
        `;
      }).join('');

      // ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä»˜ä¸ï¼ˆæç”»ã®åº¦ã«å†ç™»éŒ²ï¼‰
      Array.from(listEl.querySelectorAll('button[data-action]')).forEach(btn=>{
        btn.addEventListener('click', async () => {
          const action = btn.getAttribute('data-action');
          const id = btn.getAttribute('data-id');
          if(action === 'delete'){
            if(!confirm('å‰Šé™¤ã—ã¦ã‚ˆã„ã§ã™ã‹ï¼Ÿ')) return;
            try{
              await deleteDoc(doc(db,'grammarQuestions',id));
              alert('å‰Šé™¤ã—ã¾ã—ãŸ');
              // ãƒ­ãƒ¼ã‚«ãƒ«é…åˆ—ã‹ã‚‰å‰Šé™¤ã—ã¦å†æç”»
              const idx = allQuestions.findIndex(x => x.id === id);
              if(idx !== -1) allQuestions.splice(idx, 1);
              renderList(allQuestions);
            }catch(err){
              console.error(err);
              alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
          } else if(action === 'edit'){
            // æ—¢å­˜ã®ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ é–‹ãé–¢æ•°ã‚’å†åˆ©ç”¨
            openGrammarEditForm(id);
          }
        });
      });
    }

    // æœ€åˆã¯å…¨ä»¶è¡¨ç¤º
    renderList(allQuestions);

    // æ¤œç´¢ï¼ˆãƒ‡ãƒã‚¦ãƒ³ã‚¹ä»˜ãã§éƒ¨åˆ†ä¸€è‡´ã€‚è¨­å•ãƒ»å½¢å¼ãƒ»é¸æŠè‚¢ã‚’æ¤œç´¢å¯¾è±¡ï¼‰
    let timeoutId = null;
    inputEl.addEventListener('input', (ev) => {
      clearTimeout(timeoutId);
      timeoutId = setTimeout(() => {
        const kw = (ev.target.value || '').trim().toLowerCase();
        if(kw === ''){
          renderList(allQuestions);
          return;
        }
        const filtered = allQuestions.filter(item => {
          const q = String(item.question || '').toLowerCase();
          if(q.includes(kw)) return true;
          const t = String(item.type || '').toLowerCase();
          if(t.includes(kw)) return true;
          if(Array.isArray(item.choices) && item.choices.join(' ').toLowerCase().includes(kw)) return true;
          // è¿½åŠ : ä½œæˆè€…ã‚„ã‚¹ã‚³ã‚¢ãªã©ã‚’æ¤œç´¢å¯¾è±¡ã«ã—ãŸã‘ã‚Œã°ã“ã“ã«è¶³ã›ã¾ã™
          return false;
        });
        renderList(filtered);
      }, 180); // 180ms ãƒ‡ãƒã‚¦ãƒ³ã‚¹
    });

    // ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³
    clearBtn.addEventListener('click', () => {
      inputEl.value = '';
      renderList(allQuestions);
      inputEl.focus();
    });

  }catch(err){
    console.error('renderGrammarEditList err', err);
    alert('ä¸€è¦§å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
}


async function openGrammarEditForm(id){
  try{
    const docRef = doc(db,'grammarQuestions',id);
    const snap = await getDoc(docRef);
    if(!snap.exists()){ alert('è©²å½“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }
    const d = snap.data();
    document.getElementById('content').innerHTML = `
      <div class="card">
        <h2>ç·¨é›†: ${escapeHtml(d.question||'')}</h2>
        <div style="display:flex;flex-direction:column;gap:8px;">
          <label>å½¢å¼:
            <select id="eg-type">
              <option value="multiple">multiple</option>
              <option value="reorder">reorder</option>
              <option value="fill">fill</option>
              <option value="translate">translate</option>
            </select>
          </label>
          <label>è¨­å•æ–‡:<br>
  <textarea id="eg-question" rows="4" style="width:100%;padding:8px; resize:vertical;"></textarea>
</label>
          <label>é¸æŠè‚¢ / å˜èª (ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š):<textarea id="eg-choices" style="width:100%;height:80px;padding:8px;"></textarea></label>
          <label>æ­£è§£ (ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š):<input id="eg-answer" style="width:100%;padding:8px;" /></label>
          <label>ã‚¹ã‚³ã‚¢:<input id="eg-score" type="number" style="width:120px;padding:6px;" /></label>
          <div style="display:flex;gap:8px;">
            <button id="eg-save" class="btn-plain btn-primary">ä¿å­˜</button>
            <button id="eg-cancel" class="btn-plain">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          </div>
        </div>
      </div>
    `;
    // populate
    document.getElementById('eg-type').value = d.type || 'multiple';
    document.getElementById('eg-question').value = d.question || '';
    document.getElementById('eg-choices').value = (d.choices||[]).join(', ');
    document.getElementById('eg-answer').value = (d.answer||[]).join(', ');
    document.getElementById('eg-score').value = d.score || 1;

    document.getElementById('eg-save').addEventListener('click', async ()=>{
      const type = document.getElementById('eg-type').value;
      const question = document.getElementById('eg-question').value.trim();
      const choices = sanitizeCsvToArray(document.getElementById('eg-choices').value);
      const answer = sanitizeCsvToArray(document.getElementById('eg-answer').value);
      const score = Number(document.getElementById('eg-score').value) || 1;
      if(!question){ alert('è¨­å•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
      try{
        await updateDoc(docRef, { type, question, choices, answer, score, updatedAt: new Date() });
        alert('æ›´æ–°ã—ã¾ã—ãŸ');
        renderGrammarEditList();
      }catch(err){ console.error(err); alert('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
    });
    document.getElementById('eg-cancel').addEventListener('click', renderGrammarEditList);

  }catch(err){
    console.error(err);
    alert('ç·¨é›†ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
}

/* ===== å­¦ç¿’è€…å‘ã‘: æ–‡æ³•ç‰¹è¨“ï¼ˆ50å•ãƒ©ãƒ³ãƒ€ãƒ ãƒ»é‡è¤‡ãªã—ï¼‰ ===== */
async function startGrammarTraining(){
  try{
    const snap = await getDocs(collection(db,'grammarQuestions'));
    let questions = [];
    snap.forEach(s => questions.push({ id: s.id, ...s.data() }));
    if(questions.length === 0){ alert('æ–‡æ³•å•é¡ŒãŒã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚'); return; }

    // ã‚·ãƒ£ãƒƒãƒ•ãƒ«
    questions = questions.sort(()=>Math.random()-0.5).slice(0,50);

    // çŠ¶æ…‹
    let idx = 0;
    let score = 0;
    const answersRecord = [];
    const startTime = Date.now();

    // UI: show timer in header
    const testTimerEl = document.getElementById('test-timer');
    if(testTimerEl) testTimerEl.classList.remove('hidden');

    // disable menus while training
    disableMenus(true);

    // --- ã‚¿ã‚¤ãƒãƒ¼åˆæœŸåŒ–ï¼ˆ5åˆ† = 300ç§’ï¼‰ ---
    grammarRemaining = 5 * 60;
    updateGrammarTimer();
    if(grammarTimerInterval) { clearInterval(grammarTimerInterval); grammarTimerInterval = null; }
    grammarTimerInterval = setInterval(()=> {
      grammarRemaining--;
      updateGrammarTimer();
      if(grammarRemaining <= 0){
        // ã‚¿ã‚¤ãƒ ã‚¢ãƒƒãƒ—: å¼·åˆ¶çµ‚äº†
        // move index to end and renderQ once (renderQ will handle save & cleanup)
        idx = questions.length;
        try { renderQ(); } catch(e){ /* ignore */ }
        if(grammarTimerInterval){ clearInterval(grammarTimerInterval); grammarTimerInterval = null; }
      }
    }, 1000);

    // render é–¢æ•°
    async function renderQ(){
      // çµ‚äº†åˆ†å²
      if(idx >= questions.length){
        // clear timer & hide
        if(grammarTimerInterval){ clearInterval(grammarTimerInterval); grammarTimerInterval = null; }
        if(testTimerEl) testTimerEl.classList.add('hidden');
        // allow menus again
        disableMenus(false);

        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        // ä¿å­˜ï¼ˆçµæœã‚’ DB ã«è¿½åŠ ã—ã€ãƒãƒŠãƒã‚’åŠ ç®—ï¼‰
        await saveGrammarResult(score, elapsed, answersRecord);
        // è¡¨ç¤º
        renderGrammarResult(score, elapsed, answersRecord);
        return;
      }

      const q = questions[idx];
      let html = `
        <div class="card">
          <h2>Q${idx+1}/${questions.length}</h2>
          <div style="margin-top:8px; white-space:pre-wrap;">${escapeHtml(q.question||'')}</div>
          <div style="margin-top:12px;" id="g-body"></div>
          <div style="margin-top:12px;text-align:right;">
            <button class="btn-plain" id="g-skip">ã‚¹ã‚­ãƒƒãƒ—</button>
            <button class="btn-plain btn-primary" id="g-submit">å›ç­”</button>
          </div>
        </div>
      `;
      document.getElementById('content').innerHTML = html;

      const body = document.getElementById('g-body');

      if(q.type === 'multiple'){
        // ãƒ©ã‚¸ã‚ªã§è¡¨ç¤º
        (q.choices || []).forEach((c, i)=>{
          const div = document.createElement('div');
          div.innerHTML = `<label><input type="radio" name="g-choice" value="${escapeHtml(c)}" data-correct="${(q.answer||[]).includes(c) ? 'true' : 'false'}" data-score="${q.score||1}"> ${escapeHtml(c)}</label>`;
          body.appendChild(div);
        });
      } else if(q.type === 'reorder'){
        // ----- ä¸¦ã¹æ›¿ãˆ UI: èªç¾¤ï¼ˆå¯é¸ï¼‰ ã¨ è§£ç­”æ¬„ï¼ˆé»’æ ï¼‰ ã‚’åˆ†ã‘ã¦è¡¨ç¤º -----
        const avail = document.createElement('div');
        avail.id = 'g-avail';
        avail.style.display = 'flex';
        avail.style.flexWrap = 'wrap';
        avail.style.gap = '6px';
        avail.style.marginBottom = '8px';

        (q.choices || []).forEach((w,i)=>{
          const b = document.createElement('button');
          b.className = 'btn-plain';
          b.type = 'button';
          b.textContent = w;
          b.dataset.word = w;
          b.style.cursor = 'pointer';
          b.addEventListener('click', ()=> {
            const picked = document.getElementById('g-picked');
            const newb = document.createElement('button');
            newb.className = 'btn-plain';
            newb.type = 'button';
            newb.textContent = w;
            newb.dataset.word = w;
            newb.style.cursor = 'pointer';
            newb.addEventListener('click', ()=> {
              const availEl = document.getElementById('g-avail');
              if(availEl) availEl.appendChild(b);
              const pickedEl = document.getElementById('g-picked');
              if(pickedEl) pickedEl.removeChild(newb);
            });
            const pickedEl = document.getElementById('g-picked');
            if(pickedEl) pickedEl.appendChild(newb);
            if(b.parentElement) b.parentElement.removeChild(b);
          });
          avail.appendChild(b);
        });

        const picked = document.createElement('div');
        picked.id = 'g-picked';
        picked.style.minHeight = '40px';
        picked.style.display = 'flex';
        picked.style.flexWrap = 'wrap';
        picked.style.gap = '6px';
        picked.style.border = '2px solid #000';
        picked.style.padding = '8px';
        picked.style.marginTop = '8px';
        picked.style.background = '#fff';

        const resetWrap = document.createElement('div');
        resetWrap.style.marginTop = '8px';
        resetWrap.innerHTML = `<button class="btn-plain" id="g-reset">ãƒªã‚»ãƒƒãƒˆ</button>`;

        body.appendChild(document.createElement('div'));
        body.appendChild(avail);
        body.appendChild(resetWrap);
        body.appendChild(picked);

        document.getElementById('g-reset').addEventListener('click', ()=> {
          const pickedEl = document.getElementById('g-picked');
          const availEl = document.getElementById('g-avail');
          if(!pickedEl || !availEl) return;
          while(pickedEl.firstChild){
            const nb = pickedEl.firstChild;
            const w = nb.dataset.word;
            const ob = document.createElement('button');
            ob.className = 'btn-plain';
            ob.type = 'button';
            ob.textContent = w;
            ob.dataset.word = w;
            ob.style.cursor = 'pointer';
            ob.addEventListener('click', ()=> {
              const newb = document.createElement('button');
              newb.className = 'btn-plain';
              newb.type = 'button';
              newb.textContent = w;
              newb.dataset.word = w;
              newb.style.cursor = 'pointer';
              newb.addEventListener('click', ()=> {
                pickedEl.removeChild(newb);
                availEl.appendChild(ob);
              });
              pickedEl.appendChild(newb);
              availEl.removeChild(ob);
            });
            availEl.appendChild(ob);
            pickedEl.removeChild(nb);
          }
        });

      } else if(q.type === 'fill'){
        body.innerHTML = `<input type="text" id="g-fill" style="width:100%;padding:8px;" placeholder="å˜èªã‚’å…¥åŠ›" />`;
      } else if(q.type === 'translate'){
        body.innerHTML = `<textarea id="g-translate" style="width:100%;padding:8px;" rows="4" placeholder="è‹±æ–‡ã‚’å…¥åŠ›"></textarea>`;
      }

      // ã‚¹ã‚­ãƒƒãƒ—
      document.getElementById('g-skip').addEventListener('click', ()=> {
        answersRecord.push({
  question: q.question,
  selected: null,        // çµ±ä¸€ã‚­ãƒ¼å
  isCorrect: false,      // æœªè§£ç­”ã¯ false
  score: 0,
  correctAnswer: q.answer || []
});
        idx++;
        renderQ();
      });

      // æå‡º
      document.getElementById('g-submit').addEventListener('click', ()=> {
        let userAns = null;
        let correct = false;
        let addScore = 0;
        if(q.type === 'multiple'){
          const sel = document.querySelector('input[name="g-choice"]:checked');
          if(sel){
            userAns = sel.value;
            correct = (sel.dataset.correct === 'true');
            addScore = correct ? Number(sel.dataset.score||q.score||1) : 0;
          } else {
            userAns = null;
            correct = false;
            addScore = 0;
          }
        } else if(q.type === 'reorder'){
          const pickedEl = document.getElementById('g-picked');
          const arr = Array.from(pickedEl.children).map(b => b.dataset.word);
          userAns = arr;
          const target = q.answer || [];
          const eq = (a,b) => a.length===b.length && a.every((v,i)=>String(v).trim() === String(b[i]).trim());
          correct = eq(arr, target);
          addScore = correct ? (q.score || 1) : 0;
        } else if(q.type === 'fill'){
          const v = (document.getElementById('g-fill')||{value:''}).value.trim();
          userAns = v;
          const possible = (q.answer||[]).map(x=>String(x).trim().toLowerCase());
          correct = possible.includes(String(v).trim().toLowerCase());
          addScore = correct ? (q.score || 1) : 0;
        } else if(q.type === 'translate'){
          const v = (document.getElementById('g-translate')||{value:''}).value.trim();
          userAns = v;
          const possible = (q.answer||[]).map(x=>String(x).trim().toLowerCase());
          correct = possible.includes(String(v).trim().toLowerCase());
          addScore = correct ? (q.score || 1) : 0;
        }

        answersRecord.push({
  question: q.question,
  selected: userAns,          // é¸ã‚“ã å€¤ï¼ˆæ–‡å­—åˆ— or é…åˆ—ï¼‰
  isCorrect: !!correct,       // çœŸå½ã‚’æ˜ç¤º
  score: addScore,
  correctAnswer: q.answer || []
});
        score += addScore;

        // 
        idx++;
        renderQ();
      });

    } // renderQ é–¢æ•° end

    // æœ€åˆã‚’è¡¨ç¤º
    renderQ();

  }catch(err){
    console.error('startGrammarTraining err', err);
    alert('æ–‡æ³•ç‰¹è¨“ã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (err && err.message ? err.message : err));
    // å®‰å…¨å‡¦ç†
    if(grammarTimerInterval){ clearInterval(grammarTimerInterval); grammarTimerInterval = null; }
    const testTimerEl = document.getElementById('test-timer');
    if(testTimerEl) testTimerEl.classList.add('hidden');
    disableMenus(false);
  }
}

// ä¿å­˜
async function saveGrammarResult(score, elapsedSec, answersRecord){
  try{
    const uid = currentUser ? currentUser.id : 'guest';
    await addDoc(collection(db,'results'), {
      uid,
      type: 'æ–‡æ³•ç‰¹è¨“',
      testType: 'grammar',
      score,
      elapsed: elapsedSec,
      answers: answersRecord,
      createdAt: new Date()
    });
    // çµ‚äº†æ™‚ã«ä¸€åº¦ã ã‘ãƒãƒŠãƒã‚’åŠ ç®—ï¼ˆã‚¹ã‚³ã‚¢ã‚’ãã®ã¾ã¾åŠ ç®—ï¼‰
    try { 
      if(typeof addBnp === 'function') {
        await addBnp(score);
      }
    } catch(e){ console.warn('addBnp at end failed', e); }
  }catch(err){
    console.warn('saveGrammarResult failed', err);
  }
}

// çµæœè¡¨ç¤º
function renderGrammarResult(score, elapsedSec, answersRecord){
  // çµæœç”»é¢ã‚’æç”»
  document.getElementById('content').innerHTML = `
    <div class="card">
      <h2>æ–‡æ³•ç‰¹è¨“ çµæœ</h2>
      <p>ç²å¾—ã‚¹ã‚³ã‚¢: ${score}</p>
      <p>çµŒéç§’æ•°: ${elapsedSec} ç§’</p>
      <div style="text-align:right;margin-top:12px;">
        <button id="g-to-home" class="btn-plain">ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
        <button id="g-review" class="btn-plain btn-primary">è©³ç´°ã‚’è¦‹ã‚‹</button>
      </div>
    </div>
  `;

  // ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹
  const toHomeBtn = document.getElementById('g-to-home');
  if(toHomeBtn){
    toHomeBtn.addEventListener('click', ()=> {
      if(typeof renderHome === 'function') renderHome();
      else document.getElementById('content').innerHTML = `<div class="card"><h2>ãƒ›ãƒ¼ãƒ </h2></div>`;
    });
  }

  // ã€Œè©³ç´°ã‚’è¦‹ã‚‹ã€
  const reviewBtn = document.getElementById('g-review');
  if(reviewBtn){
    reviewBtn.addEventListener('click', async ()=> {
      try {
        // æœ€æ–°ã®è‡ªåˆ†ã®çµæœã‚’å–å¾—
        const qSnap = await getDocs(query(collection(db,'results'), orderBy('createdAt','desc')));
        let found = null;
        qSnap.forEach(docSnap=>{
          if(found) return;
          const d = docSnap.data();
          if(d.uid !== (currentUser ? currentUser.id : 'guest')) return;
          if((d.testType && d.testType === 'grammar') || (d.type && d.type === 'æ–‡æ³•ç‰¹è¨“')){
            found = { id: docSnap.id, data: d };
          }
        });

        if(!found){ alert('è©³ç´°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }

        // answers ã‚’æ­£è¦åŒ–ã—ã¦è¡¨ç¤º
        const arr = Array.isArray(found.data.answers) ? found.data.answers : [];

        function _normalizeAnswer(a){
          if(!a) return { question:'', selected:null, isCorrect:false, score:0, correctAnswer:[] };
          const question = a.question || a.q || '';
          const selected = ('selected' in a) ? a.selected
                        : ('userAnswer' in a) ? a.userAnswer
                        : ('selectedAnswer' in a) ? a.selectedAnswer
                        : null;
          const isCorrect = ('isCorrect' in a) ? !!a.isCorrect
                         : ('correct' in a) ? !!a.correct
                         : false;
          const correctAnswer = a.correctAnswer || a.correctAnswers || a.answer || a.correct || [];
          return {
            question,
            selected,
            isCorrect,
            score: a.score || 0,
            correctAnswer: Array.isArray(correctAnswer) ? correctAnswer : [String(correctAnswer)]
          };
        }

        let html = `<div class="card"><h2>æ–‡æ³•ç‰¹è¨“ï¼šè©³ç´°</h2>`;
        arr.forEach((raw,i)=>{
          const n = _normalizeAnswer(raw);
          const isUnanswered = (
            n.selected === null ||
            n.selected === undefined ||
            (typeof n.selected === 'string' && n.selected.trim() === '') ||
            (Array.isArray(n.selected) && n.selected.length === 0)
          );
          let statusText, color;
          if(isUnanswered){
            statusText = 'æœªè§£ç­”';
            color = 'gray';
          } else if(n.isCorrect){
            statusText = 'â­• æ­£è§£';
            color = 'green';
          } else {
            statusText = 'âŒ ä¸æ­£è§£';
            color = 'red';
          }

          const yourAnsDisplay = Array.isArray(n.selected) ? n.selected.join(' / ') : (n.selected || 'ãªã—');
          const correctAnsDisplay = (n.correctAnswer || []).map(x => escapeHtml(String(x))).join(' / ');

          html += `<div style="margin:6px 0;padding:8px;border-left:4px solid ${color};">
            <p><strong>Q${i+1}:</strong> ${escapeHtml(n.question||'')}</p>
            <p>ã‚ãªãŸã®è§£ç­”: ${escapeHtml(yourAnsDisplay)}</p>
            <p style="color:${color};font-weight:bold">${statusText}</p>
          </div>`;
        });
        html += `<div style="text-align:right;margin-top:12px;">
          <button id="back-to-results" class="btn-plain btn-primary">çµæœã¸æˆ»ã‚‹</button>
        </div></div>`;

        // è©³ç´°ç”»é¢ã‚’æç”»
        document.getElementById('content').innerHTML = html;

        // æˆ»ã‚‹ãƒœã‚¿ãƒ³
        const backBtn = document.getElementById('back-to-results');
        if(backBtn){
          backBtn.addEventListener('click', ()=> {
            renderGrammarResult(found.data.score, found.data.elapsed, found.data.answers || []);
          });
        }

      } catch(err){
        console.error('g review err', err);
        alert('è©³ç´°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (err && err.message ? err.message : err));
      }
    });
  }
}


/* ================= end: æ–‡æ³•ç‰¹è¨“ ================= */





    // ===== åˆè¡¨ç¤ºã¯ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ï¼ˆä½•ã‚‚å¤‰æ›´ã—ãªã„ï¼‰ =====
    // end of module

  
    // â˜…â˜… è¿½åŠ ã“ã“ã¾ã§ â˜…â˜…

    /* ============== ã“ã“ã‹ã‚‰æ–°è¦è¿½åŠ : ãƒ›ãƒ¼ãƒ ç”»é¢ã¨ãŠçŸ¥ã‚‰ã›æ©Ÿèƒ½ ============== */
    /* è¿½åŠ ãƒãƒªã‚·ãƒ¼:
       - ã²ãªå½¢A1 ã®æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã¯ä¸€åˆ‡å¤‰æ›´ã—ã¦ã„ã¾ã›ã‚“ï¼ˆä¸Šæ›¸ãã€å‰Šé™¤ãªã—ï¼‰ã€‚
       - ä»¥ä¸‹ã¯ã€Œè¿½åŠ å®Ÿè£…ã€ã®ã¿ã§ã€ãƒ­ã‚°ã‚¤ãƒ³ç›´å¾Œã«ãƒ›ãƒ¼ãƒ ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã«æ—¢å­˜ã® showMain() ã®å‹•ä½œã‚’ãƒ©ãƒƒãƒ—ã—ã¦ã„ã¾ã™ã€‚
       - Firestore ã« notices ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½¿ã„ã¾ã™ã€‚ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ§‹é€ :
         { title, body, createdBy, createdAt }
    */

    // ãƒ©ãƒƒãƒ—ã—ã¦å…ƒã® showMain ã‚’æ‹¡å¼µ: ãƒ­ã‚°ã‚¤ãƒ³ç›´å¾Œã«ãƒ›ãƒ¼ãƒ ã‚’è¡¨ç¤ºã™ã‚‹
    if (typeof showMain === 'function') {
      const __orig_showMain = showMain;
      showMain = function(...args){
        __orig_showMain.apply(this, args);
        // è¡¨ç¤ºãŒåˆ‡ã‚Šæ›¿ã‚ã£ãŸç›´å¾Œã«ãƒ›ãƒ¼ãƒ ã‚’è¡¨ç¤º
        renderHome();
      };
    }

    // ãƒ­ã‚´ã‚¯ãƒªãƒƒã‚¯ã§ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹
    const logoEl = document.querySelector('.logo');
    if (logoEl) {
      logoEl.style.cursor = 'pointer';
      logoEl.addEventListener('click', (e) => {
        e.preventDefault();
        renderHome();
      });
    }

// ãƒ›ãƒ¼ãƒ ç”»é¢æç”»
function renderHome() {
  const today = new Date();
  const privateExamDate = new Date('2026-02-10');
  const publicExamDate = new Date('2026-03-11');

  const privateDiff = Math.ceil((privateExamDate - today) / (1000 * 60 * 60 * 24));
  const publicDiff = Math.ceil((publicExamDate - today) / (1000 * 60 * 60 * 24));

  document.getElementById('content').innerHTML = `
    <div class="home-layout">
      <div class="card home-card">
        <h2>ã‚ˆã†ã“ãã€${currentUser ? escapeHtml(currentUser.nickname || currentUser.id) : 'ã‚²ã‚¹ãƒˆ'} ã•ã‚“ã€‚</h2>
        <p></p>

      </div>

      <div class="exam-side">
        <div class="exam-card private-exam">
          <h3>ç§ç«‹å…¥è©¦ã¾ã§</h3>
          <div class="exam-days">${privateDiff}æ—¥</div>
          <div class="exam-date">ï¼ˆ2026å¹´2æœˆ10æ—¥ ç«ï¼‰</div>
        </div>

        <div class="exam-card public-exam">
          <h3>å…¬ç«‹å…¥è©¦ã¾ã§</h3>
          <div class="exam-days">${publicDiff}æ—¥</div>
          <div class="exam-date">ï¼ˆ2026å¹´3æœˆ11æ—¥ æ°´ï¼‰</div>
        </div>
      </div>
    </div>

    <div class="card" id="notices-card">
      <h3>ãŠã—ã‚‰ã›</h3>
      <div id="notices-list" style="margin-top:12px;"></div>
      <div id="notice-admin-controls" style="margin-top:12px;"></div>
    </div>
  `;

  // ã‚¹ã‚¿ã‚¤ãƒ«
  const styleTag = document.createElement('style');
  styleTag.innerHTML = `
    /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    .home-layout {
      display: flex;
      flex-wrap: wrap;
      align-items: stretch;
      gap: 20px;
      justify-content: center;
      margin: 20px auto 32px;
      max-width: 1200px;
    }

    .home-card {
      flex: 1 1 320px;
      background: linear-gradient(135deg, #ffffff, #fafafa);
      border: 1px solid #e5e7eb;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .home-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.08);
    }

    .exam-side {
      display: flex;
      flex-direction: column;
      gap: 16px;
      flex: 1 1 300px;
    }

    /* ã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³ */
    .exam-card {
      background: #ffffff;
      border-radius: 14px;
      text-align: center;
      padding: 20px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.07);
      border: 1px solid transparent;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .exam-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 6px 14px rgba(0,0,0,0.08);
    }

    .exam-card h3 {
      font-size: 18px;
      color: #333;
      margin-bottom: 10px;
      font-weight: 600;
    }

    .exam-days {
      font-size: 36px;
      font-weight: bold;
      margin-bottom: 6px;
    }

    .exam-date {
      font-size: 14px;
      color: #666;
    }

    /* è‰²ãƒ†ãƒ¼ãƒ */
    .private-exam {
      background: linear-gradient(135deg, #ffeef3, #fff7fa);
      border-color: #f8b6c7;
      color: #c62f63;
    }

.maple-img {
  position: absolute;
  bottom: 12px;
  right: 12px;
  width: 90px;
  height: auto;
  opacity: 0.95;
  pointer-events: none; /* ã‚¯ãƒªãƒƒã‚¯ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„ã‚ˆã†ã« */
}

/* .home-card ã« position: relative ã‚’è¿½åŠ ã—ã¦åŸºæº–ã«ã™ã‚‹ */
.home-card {
  position: relative;
}


    .public-exam {
      background: linear-gradient(135deg, #edf6ff, #f6fbff);
      border-color: #9ac8f5;
      color: #3178c6;
    }
  `;
  document.head.appendChild(styleTag);

  // ãŠçŸ¥ã‚‰ã›è¡¨ç¤º
  loadNotices();
  renderNoticeAdminControlsIfAllowed();
}



// ç®¡ç†è€…ãªã‚‰æŠ•ç¨¿UIã‚’è¡¨ç¤º
function renderNoticeAdminControlsIfAllowed() {
  const ctrl = document.getElementById('notice-admin-controls');
  if (!ctrl) return;
  ctrl.innerHTML = '';

  if (currentUser && currentUser.role === 'admin') {
    ctrl.innerHTML = `
      <div style="display:flex;flex-direction:column;gap:8px">
        <input id="new-notice-title" placeholder="ã‚¿ã‚¤ãƒˆãƒ«" style="padding:8px;border-radius:6px;border:1px solid #d0d7dc;width:100%" />
        <textarea id="new-notice-body" placeholder="æœ¬æ–‡" rows="4" style="padding:8px;border-radius:6px;border:1px solid #d0d7dc;width:100%"></textarea>
        <div style="display:flex;gap:8px">
          <button id="btn-create-notice" class="btn-plain btn-primary">æŠ•ç¨¿</button>
          <button id="btn-refresh-notice" class="btn-plain">æ›´æ–°</button>
        </div>
      </div>
    `;
    document.getElementById('btn-create-notice').addEventListener('click', createNotice);
    document.getElementById('btn-refresh-notice').addEventListener('click', loadNotices);
  }
}


// ãŠçŸ¥ã‚‰ã›ã‚’èª­ã¿è¾¼ã‚“ã§è¡¨ç¤º
async function loadNotices() {
  try {
    const q = query(collection(db, 'notices'), orderBy('createdAt', 'desc'));
    const snap = await getDocs(q);
    const listEl = document.getElementById('notices-list');
    if (!listEl) return;

    if (snap.empty) {
      listEl.innerHTML = `
        <div style="color:#666;padding:12px;border:1px dashed #eef3f5;border-radius:8px">
          ç¾åœ¨ãŠçŸ¥ã‚‰ã›ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
        </div>`;
      return;
    }

    let html = '';
    snap.forEach(docSnap => {
      const d = docSnap.data();
      const createdAt = d.createdAt?.toDate ? d.createdAt.toDate() : new Date(d.createdAt);
      const dateStr = createdAt ? createdAt.toLocaleString() : '';
      html += `
        <div style="padding:12px;border-bottom:1px solid #f0f4f6;margin-bottom:8px;">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:700">${escapeHtml(d.title || 'ï¼ˆç„¡é¡Œï¼‰')}</div>
            <div style="font-size:12px;color:#666">
              ${escapeHtml(d.createdBy || '')}${dateStr ? ' â€¢ ' + escapeHtml(dateStr) : ''}
            </div>
          </div>
          <div style="margin-top:8px;white-space:pre-wrap">${escapeHtml(d.body || '')}</div>
          <div style="margin-top:8px;" data-notice-id="${docSnap.id}"></div>
        </div>
      `;
    });

    listEl.innerHTML = html;

    // ç®¡ç†è€…ãªã‚‰ç·¨é›†ãƒ»å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
    if (currentUser && currentUser.role === 'admin') {
      const noticeWrappers = listEl.querySelectorAll('div[data-notice-id]');
      noticeWrappers.forEach(wrapper => {
        const id = wrapper.getAttribute('data-notice-id');
        wrapper.innerHTML = `
          <div style="display:flex;gap:8px">
            <button class="btn-plain" data-notice-action="edit" data-id="${id}">ç·¨é›†</button>
            <button class="btn-plain btn-danger" data-notice-action="delete" data-id="${id}">å‰Šé™¤</button>
          </div>
        `;
      });

      // ã‚¤ãƒ™ãƒ³ãƒˆå‰²ã‚Šå½“ã¦
      Array.from(listEl.querySelectorAll('button[data-notice-action]')).forEach(b => {
        b.addEventListener('click', async () => {
          const action = b.getAttribute('data-notice-action');
          const id = b.getAttribute('data-id');
          if (action === 'delete') {
            if (confirm('ãŠçŸ¥ã‚‰ã›ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
              try {
                await deleteDoc(doc(db, 'notices', id));
                alert('å‰Šé™¤ã—ã¾ã—ãŸ');
                loadNotices();
              } catch (err) {
                console.error(err);
                alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (err.message || err));
              }
            }
          } else if (action === 'edit') {
            openEditNoticeDialog(id);
          }
        });
      });
    }

  } catch (err) {
    console.error(err);
    alert('ãŠçŸ¥ã‚‰ã›ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (err.message || err));
  }
}


    // ãŠçŸ¥ã‚‰ã›ä½œæˆ
    async function createNotice(){
      const title = (document.getElementById('new-notice-title') || {value:''}).value.trim();
      const body = (document.getElementById('new-notice-body') || {value:''}).value.trim();
      if(!title && !body){ alert('ã‚¿ã‚¤ãƒˆãƒ«ã¾ãŸã¯æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
      try{
        await addDoc(collection(db,'notices'), {
          title,
          body,
          createdBy: currentUser ? currentUser.id : 'unknown',
          createdAt: new Date()
        });
        // clear inputs
        document.getElementById('new-notice-title').value = '';
        document.getElementById('new-notice-body').value = '';
        // å³æ™‚åæ˜ 
        loadNotices();
        alert('æŠ•ç¨¿ã—ã¾ã—ãŸ');
      }catch(err){
        console.error(err);
        alert('æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (err.message || err));
      }
    }

    // ç·¨é›†ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ï¼ˆç°¡æ˜“ï¼‰ã‚’å‡ºã—ã€æ›´æ–°ã™ã‚‹
    async function openEditNoticeDialog(id){
      try{
        const docRef = doc(db,'notices',id);
        const snap = await getDoc(docRef);
        if(!snap.exists()){
          alert('è©²å½“ã®ãŠçŸ¥ã‚‰ã›ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          return;
        }
        const d = snap.data();
        // ç°¡æ˜“ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºï¼ˆDOMä¸Šã«ç”Ÿæˆï¼‰
        const overlay = document.createElement('div');
        overlay.style.position = 'fixed';
        overlay.style.left = '0';
        overlay.style.top = '0';
        overlay.style.width = '100%';
        overlay.style.height = '100%';
        overlay.style.background = 'rgba(0,0,0,0.4)';
        overlay.style.display = 'flex';
        overlay.style.alignItems = 'center';
        overlay.style.justifyContent = 'center';
        overlay.style.zIndex = '9999';
        overlay.innerHTML = `
          <div style="background:#fff;padding:16px;border-radius:8px;max-width:720px;width:90%;">
            <h3>ãŠçŸ¥ã‚‰ã›ç·¨é›†</h3>
            <input id="edit-notice-title" style="width:100%;padding:8px;border:1px solid #d0d7dc;border-radius:6px" value="${escapeHtml(d.title||'')}" />
            <textarea id="edit-notice-body" rows="6" style="width:100%;margin-top:8px;padding:8px;border:1px solid #d0d7dc;border-radius:6px">${escapeHtml(d.body||'')}</textarea>
            <div style="margin-top:8px;display:flex;gap:8px;justify-content:flex-end">
              <button id="cancel-edit" class="btn-plain">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
              <button id="save-edit" class="btn-plain btn-primary">ä¿å­˜</button>
            </div>
          </div>
        `;
        document.body.appendChild(overlay);
        overlay.querySelector('#cancel-edit').addEventListener('click', ()=> overlay.remove());
        overlay.querySelector('#save-edit').addEventListener('click', async ()=>{
          const newTitle = (overlay.querySelector('#edit-notice-title')||{value:''}).value.trim();
          const newBody = (overlay.querySelector('#edit-notice-body')||{value:''}).value.trim();
          try{
            await updateDoc(docRef, { title: newTitle, body: newBody, updatedAt: new Date() });
            alert('æ›´æ–°ã—ã¾ã—ãŸ');
            overlay.remove();
            loadNotices(); // å³æ™‚åæ˜ 
          }catch(err){
            console.error(err);
            alert('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (err.message || err));
          }
        });
      }catch(err){
        console.error(err);
        alert('ç·¨é›†ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (err.message || err));
      }
    }

/* ===== è¿½åŠ æ©Ÿèƒ½: ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ± / éŸ³å£°ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ / å­¦ç¿’ã®è¨˜éŒ² ===== */

// storage ã®å‚ç…§ã¯å…ˆé ­ import ã§èª­ã¿è¾¼ã‚“ã§ã„ã‚‹æƒ³å®š (getStorage, storageRef, uploadBytes, getDownloadURL, deleteObject)
const storage = getStorage(app); // app ã¯æ—¢å­˜ã§åˆæœŸåŒ–æ¸ˆã¿

// ãƒ˜ãƒƒãƒ€ã®ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ è¡¨ç¤ºã‚’æ›´æ–°ï¼ˆFirestore users/<userid> ã® nickname ã‚’ä½¿ç”¨ï¼‰
async function refreshHeaderNickname(){
  if(!currentUser) return;
  try {
    const uRef = doc(db, 'users', currentUser.id);
    const snap = await getDoc(uRef);
    let nickname = currentUser.id;
    if(snap.exists()){
      const data = snap.data();
      if(data && data.nickname) nickname = data.nickname;
    } else {
      // åˆå›: username ã‚’ nickname ã«ã‚»ãƒƒãƒˆ
      await setDoc(uRef, { username: currentUser.id, nickname: currentUser.id }, { merge: true });
      nickname = currentUser.id;
    }
    currentUser.nickname = nickname;
    const nameEl = document.getElementById('user-name');
    if(nameEl) nameEl.textContent = nickname;
  } catch(err){
    console.error('refreshHeaderNickname error', err);
  }
}

// ----- ãƒãƒŠãƒé–¢é€£ -----
// storage ã¯åˆ¥é€”ï¼ˆæ—¢ã« app åˆæœŸåŒ–æ¸ˆã¿ï¼‰
// 1æ—¥ãƒœãƒ¼ãƒŠã‚¹ç”¨ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼: YYYY-MM-DD æ–‡å­—åˆ—ã‚’è¿”ã™
function todayStr(){
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}

// ãƒ˜ãƒƒãƒ€ãƒ¼ã® bnp è¡¨ç¤ºã‚’æ›´æ–°
async function refreshBnpDisplay(){
  try {
    if(!currentUser) return;
    const uRef = doc(db,'users', currentUser.id);
    const snap = await getDoc(uRef);
    let bnp = 0;
    if(snap.exists()){
      const data = snap.data();
      if(data && typeof data.bnp === 'number') bnp = data.bnp;
    } else {
      // åˆæœŸãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆï¼ˆusername / nickname ã¯æ—¢ã« set ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ã‚ã‚Šï¼‰
      await setDoc(uRef, { username: currentUser.id, nickname: currentUser.id, bnp: 0 }, { merge: true });
      bnp = 0;
    }
    // update UI
    const el = document.getElementById('bnp-value');
    if(el) el.textContent = String(bnp);
    // also keep local copy
    currentUser.bnp = bnp;
  } catch(err){
    console.error('refreshBnpDisplay error', err);
  }
}

// bnp ã‚’åŠ ç®—ï¼ˆè² ã®å€¤ã§æ¸›ç®—ã‚‚å¯èƒ½ï¼‰
// returns the new bnp value (number)
async function addBnp(amount){
  try {
    if(!currentUser) return null;
    const uRef = doc(db,'users', currentUser.id);
    const snap = await getDoc(uRef);
    let current = 0;
    if(snap.exists()){
      const data = snap.data();
      current = (data && typeof data.bnp === 'number') ? data.bnp : 0;
    }
    const next = current + Number(amount || 0);
    // ãƒãƒ¼ã‚¸ã§æ›¸ãæˆ»ã—
    await setDoc(uRef, { bnp: next }, { merge: true });
    // UI æ›´æ–°
    const el = document.getElementById('bnp-value');
    if(el) el.textContent = String(next);
    currentUser.bnp = next;
    return next;
  } catch(err){
    console.error('addBnp error', err);
    return null;
  }
}

// ãƒ­ã‚°ã‚¤ãƒ³æ™‚ 1æ—¥ä¸€å›ãƒœãƒ¼ãƒŠã‚¹ +10bnpï¼ˆlastLoginBonus ã«æ—¥ä»˜ã‚’ä¿å­˜ï¼‰
async function creditDailyLoginBonusIfNeeded(){
  try {
    if(!currentUser) return;
    const uRef = doc(db,'users', currentUser.id);
    const snap = await getDoc(uRef);
    const today = todayStr();
    let last = null;
    if(snap.exists()){
      const data = snap.data();
      last = data && data.lastLoginBonus ? data.lastLoginBonus : null;
    }
    if(last !== today){
      // give 10bnp
      await addBnp(10);
      // record the date
      await setDoc(uRef, { lastLoginBonus: today }, { merge: true });
      console.log('daily login bonus granted');
    } else {
      console.log('daily login bonus already granted today');
    }
  } catch(err){
    console.error('creditDailyLoginBonusIfNeeded error', err);
  }
}

// ----- ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ç”»é¢ -----
async function renderUserInfo(){
  if(!currentUser) return;
  const uRef = doc(db, 'users', currentUser.id);
  let data = {};
  try {
    const snap = await getDoc(uRef);
    if(snap.exists()) data = snap.data();
    else {
      await setDoc(uRef, { username: currentUser.id, nickname: currentUser.id }, { merge: true });
      data = { username: currentUser.id, nickname: currentUser.id };
    }
  } catch(err){
    console.error('renderUserInfo load error', err);
    data = { username: currentUser.id, nickname: currentUser.id };
  }

  document.getElementById('content').innerHTML = `
    <div class="card">
      <h2>ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±</h2>
      <p><strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼å</strong>: <span id="ui-username">${escapeHtml(data.username || currentUser.id)}</span></p>
      <p><strong>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</strong>: <span id="ui-password">${escapeHtml(users[currentUser.id] ? users[currentUser.id].password : '')}</span></p>
      <p><strong>ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ </strong>: <input id="ui-nickname" value="${escapeHtml(data.nickname || currentUser.id)}" /> <button id="ui-nickname-save" class="btn-plain btn-primary">ä¿å­˜</button></p>
    </div>
  `;

  document.getElementById('ui-nickname-save').addEventListener('click', async ()=>{
    const newNick = (document.getElementById('ui-nickname') || {value:''}).value.trim() || currentUser.id;
    try {
      await setDoc(uRef, { nickname: newNick }, { merge: true });
      currentUser.nickname = newNick;
      const nameEl = document.getElementById('user-name');
      if(nameEl) nameEl.textContent = newNick;
      alert('ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
    } catch(err){
      console.error('save nickname error', err);
      alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (err.message || err));
    }
  });
}

// ----- éŸ³å£°ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”»é¢ -----
async function renderAudioContent(){
  if(!currentUser) return;

  const isAdmin = currentUser.role === 'admin';
  const uploadUi = isAdmin ? `
    <div style="margin-bottom:12px;">
      <input type="text" id="audio-title" placeholder="ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›" style="padding:6px;border-radius:6px;border:1px solid #d0d7dc;width:60%" />
      <input type="file" id="audio-file" accept="audio/mp3" style="margin-left:8px;" />
      <button id="audio-upload-btn" class="btn-plain btn-primary">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
    </div>
  ` : '';

  document.getElementById('content').innerHTML = `
    <div class="card">
      <h2>éŸ³å£°ã‚³ãƒ³ãƒ†ãƒ³ãƒ„</h2>
      ${uploadUi}
      <div id="audio-items">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>
  `;

  // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†ï¼ˆç®¡ç†è€…ã®ã¿ï¼‰
  if(isAdmin){
    document.getElementById('audio-upload-btn').addEventListener('click', async ()=>{
      const fileInput = document.getElementById('audio-file');
      const title = (document.getElementById('audio-title')||{value:''}).value.trim() || (fileInput.files[0] ? fileInput.files[0].name : 'ç„¡é¡Œ');
      if(!fileInput.files || fileInput.files.length === 0){ alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ (mp3)'); return; }
      const file = fileInput.files[0];
      if(file.type !== 'audio/mpeg' && !file.name.endsWith('.mp3')){ alert('mp3ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
      const storagePath = `audio/${Date.now()}_${file.name}`;
      try {
        const sRef = ref(storage, storagePath);
        await uploadBytes(sRef, file);
        const url = await getDownloadURL(sRef);
        await addDoc(collection(db,'audio'), {
          title,
          path: storagePath,
          url,
          uploadedBy: currentUser.id,
          createdAt: new Date()
        });
        alert('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†');
        renderAudioContent();
      } catch(err){
        console.error('audio upload error', err);
        alert('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (err.message || err));
      }
    });
  }

  // éŸ³å£°ä¸€è¦§ã‚’å–å¾—ã—ã¦è¡¨ç¤º
  try {
    const qAudio = query(collection(db,'audio'), orderBy('createdAt','desc'));
    const snap = await getDocs(qAudio);
    const container = document.getElementById('audio-items');
    if(snap.empty){
      container.innerHTML = `<div style="color:#666;padding:12px;border:1px dashed #eef3f5;border-radius:8px">éŸ³å£°ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
      return;
    }
    let html = '';
    snap.forEach(docSnap => {
      const d = docSnap.data();
      const id = docSnap.id;
      html += `<div style="padding:8px 0;border-bottom:1px solid #f0f4f6;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div>
            <div style="font-weight:700">${escapeHtml(d.title||'ï¼ˆç„¡é¡Œï¼‰')}</div>
            <div style="font-size:12px;color:#666">${escapeHtml(d.uploadedBy||'')} ${d.createdAt ? ' â€¢ ' + new Date(d.createdAt.seconds*1000).toLocaleString() : ''}</div>
          </div>
          <div>
            <button class="btn-plain play-audio-btn" data-url="${escapeHtml(d.url||'')}" data-id="${id}">å†ç”Ÿ</button>
            ${isAdmin ? `<button class="btn-plain btn-danger del-audio-btn" data-id="${id}">å‰Šé™¤</button>` : ''}
          </div>
        </div>
        <div class="audio-player" id="player-${id}" style="margin-top:8px;"></div>
      </div>`;
    });
    container.innerHTML = html;

    // å†ç”Ÿãƒœã‚¿ãƒ³
    Array.from(container.querySelectorAll('.play-audio-btn')).forEach(btn => {
      btn.addEventListener('click', (e)=>{
        const url = btn.getAttribute('data-url');
        const id = btn.getAttribute('data-id');
        const playerDiv = document.getElementById(`player-${id}`);
        if(playerDiv){
          playerDiv.innerHTML = `<audio controls src="${url}">ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ audio ã‚¿ã‚°ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚</audio>`;
        }
      });
    });

    // ç®¡ç†è€…ã®å‰Šé™¤å‡¦ç†ï¼ˆFirestore doc ã¨ Storage ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå‰Šé™¤ï¼‰
    if(isAdmin){
      Array.from(container.querySelectorAll('.del-audio-btn')).forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const id = btn.getAttribute('data-id');
          if(!confirm('ã“ã®éŸ³å£°ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
          try {
            const dSnap = await getDoc(doc(db,'audio',id));
            if(dSnap.exists()){
              const d = dSnap.data();
              if(d && d.path){
                try {
                  const sRef = storageRef(storage, d.path);
                  await deleteObject(sRef); // storage ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å‰Šé™¤
                } catch(e){ console.warn('storage delete error', e); }
              }
            }
            await deleteDoc(doc(db,'audio',id));
            alert('å‰Šé™¤ã—ã¾ã—ãŸ');
            renderAudioContent();
          } catch(err){
            console.error('delete audio error', err);
            alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (err.message || err));
          }
        });
      });
    }
  } catch(err){
    console.error('load audio list error', err);
    const container = document.getElementById('audio-items');
    if(container) container.innerHTML = `<div style="color:#666">éŸ³å£°ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>`;
  }
}

// ----- å­¦ç¿’ã®è¨˜éŒ²ï¼ˆèª­ã¿å–ã‚Šè¡¨ç¤ºã®é››å½¢ï¼‰ -----
async function renderStudyLog(){
  if(!currentUser) return;
  document.getElementById('content').innerHTML = `
    <div class="card">
      <h2>å­¦ç¿’ã®è¨˜éŒ²</h2>
      <div id="studylog-list">èª­ã¿è¾¼ã¿ä¸­...</div>
      <div style="margin-top:12px;">ï¼ˆè¨˜éŒ²ã®è¿½åŠ ã¯å¾Œã§æ‹¡å¼µã§ãã¾ã™ï¼‰</div>
    </div>
  `;
  try {
    const qLog = query(collection(db,'studyLogs'), orderBy('createdAt','desc'));
    const snap = await getDocs(qLog);
    const container = document.getElementById('studylog-list');
    if(snap.empty){ container.innerHTML = '<div style="color:#666">è¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>'; return; }
    let html = '';
    snap.forEach(docSnap=>{
      const d = docSnap.data();
      html += `<div style="padding:8px;border-bottom:1px solid #f0f4f6;">
        <div style="font-weight:700">${escapeHtml(d.title || 'å­¦ç¿’')}</div>
        <div style="font-size:13px;color:#666">${d.createdAt ? new Date(d.createdAt.seconds*1000).toLocaleString() : ''} â€¢ ${escapeHtml(d.user||'')}</div>
        <div style="margin-top:6px;white-space:pre-wrap">${escapeHtml(d.note||'')}</div>
      </div>`;
    });
    container.innerHTML = html;
  } catch(err){
    console.error('renderStudyLog error', err);
    const container = document.getElementById('studylog-list');
    if(container) container.innerHTML = '<div style="color:#666">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
  }
}

// ----- ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚¯ãƒªãƒƒã‚¯ã‚’ç´ã¥ã‘ã‚‹ï¼ˆè¿½åŠ ã—ãŸ li ã®ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²ï¼‰ -----
const menuUserInfoEl = document.getElementById('menu-userinfo');
if(menuUserInfoEl) menuUserInfoEl.addEventListener('click', ()=> { if(!testActive) renderUserInfo(); });

const menuAudioEl = document.getElementById('menu-audio');
if(menuAudioEl) menuAudioEl.addEventListener('click', ()=> { if(!testActive) renderAudioContent(); });

const menuStudyLogEl = document.getElementById('menu-studylog');
if(menuStudyLogEl) menuStudyLogEl.addEventListener('click', ()=> { if(!testActive) renderStudyLog(); });

// ----- showMain ã‚’ãƒ©ãƒƒãƒ—ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’æ›´æ–°ã—ã¦ãƒ›ãƒ¼ãƒ è¡¨ç¤º -----
if (typeof showMain === 'function') {
  const __orig_showMain = showMain;
  showMain = function(...args){
    __orig_showMain.apply(this, args);
    // ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’èª­ã¿å–ã£ã¦ã‹ã‚‰ãƒ›ãƒ¼ãƒ ã‚’æç”»ï¼ˆå¤±æ•—ã—ã¦ã‚‚ãƒ›ãƒ¼ãƒ ã¯æç”»ï¼‰
    refreshHeaderNickname()
      .then(()=>{
        renderHome();
      })
      .catch(()=>{
        renderHome();
      })
      .finally(()=>{
        // ã“ã“ã‹ã‚‰è¿½åŠ  --- â–¼
        refreshBnpDisplay().catch(()=>{});
        creditDailyLoginBonusIfNeeded().catch(()=>{});
        // ã“ã“ã¾ã§è¿½åŠ  --- â–²
      });
  };
}

    /* ============== ã“ã“ã¾ã§ãŠçŸ¥ã‚‰ã›æ©Ÿèƒ½ ============== */
// ----- ç®¡ç†è€…ç”»é¢: ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç† -----
async function renderUserManagement(){
  if(!currentUser || currentUser.role !== 'admin'){
    alert('ç®¡ç†è€…ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã§ã™');
    return;
  }

  document.getElementById('content').innerHTML = `
    <div class="card">
      <h2>ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ï¼ˆç®¡ç†è€…ç”¨ï¼‰</h2>
      <div style="margin-bottom:12px;">
        <input id="um-filter" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã§çµã‚Šè¾¼ã¿" style="padding:8px;border-radius:6px;border:1px solid #d0d7dc;width:40%" />
        <button id="um-refresh" class="btn-plain" style="margin-left:8px;">å†èª­ã¿è¾¼ã¿</button>
      </div>
      <div id="um-list">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>
  `;

  document.getElementById('um-refresh').addEventListener('click', loadUserList);
  document.getElementById('um-filter').addEventListener('input', ()=> { loadUserList(); });

  await loadUserList();
}

async function loadUserList(){
  const container = document.getElementById('um-list');
  if(!container) return;
  container.innerHTML = 'èª­ã¿è¾¼ã¿ä¸­...';

  try {
    const qSnap = await getDocs(collection(db,'users'));
    const filter = (document.getElementById('um-filter')||{value:''}).value.trim().toLowerCase();

    let rows = [];
    qSnap.forEach(d => {
      const item = { id: d.id, ...d.data() };
      if(item.bnp == null) item.bnp = 0;
      if(item.nickname == null) item.nickname = item.username || item.id;
      if(filter && !String(item.id).toLowerCase().includes(filter) && !String(item.username||'').toLowerCase().includes(filter)) return;
      rows.push(item);
    });

    if(rows.length === 0){
      container.innerHTML = '<div style="color:#666">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</div>';
      return;
    }

    let html = `<table style="width:100%;border-collapse:collapse;"><thead>
      <tr style="text-align:left;border-bottom:1px solid #eef3f5;">
        <th style="padding:8px;">ãƒ¦ãƒ¼ã‚¶ãƒ¼ID</th>
        <th>ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ </th>
        <th>BNP</th>
        <th>æ“ä½œ</th>
      </tr></thead><tbody>`;
    rows.forEach(u=>{
      html += `<tr data-uid="${escapeHtml(u.id)}" style="border-bottom:1px solid #f7f9fa;">
        <td style="padding:8px;vertical-align:top;">${escapeHtml(u.id)}</td>
        <td style="vertical-align:top;">
          <input class="um-nickname" value="${escapeHtml(u.nickname||'')}" style="padding:6px;border:1px solid #d0d7dc;border-radius:6px;" />
          <button class="btn-plain um-save-nick" style="margin-left:6px;">ä¿å­˜</button>
        </td>
        <td style="vertical-align:top;">
          <div style="display:flex;gap:8px;align-items:center;">
            <div class="um-bnp-value" style="min-width:80px;font-weight:bold;">${Number(u.bnp||0)}</div>
            <input type="number" class="um-bnpdelta" value="10" style="width:80px;padding:6px;border-radius:6px;border:1px solid #d0d7dc;" />
            <button class="btn-plain um-add">ä»˜ä¸</button>
            <button class="btn-plain btn-danger um-sub">æ²¡å</button>
          </div>
        </td>
        <td style="vertical-align:top;">
          <button class="btn-plain um-set" style="margin-right:6px;">ç›´æ¥è¨­å®š</button>
        </td>
      </tr>`;
    });
    html += `</tbody></table>`;
    container.innerHTML = html;

    // attach handlers
    Array.from(container.querySelectorAll('.um-save-nick')).forEach(btn=>{
      btn.addEventListener('click', async (e)=>{
        const tr = e.target.closest('tr');
        const uid = tr.getAttribute('data-uid');
        const newNick = tr.querySelector('.um-nickname').value.trim() || uid;
        try {
          await updateDoc(doc(db,'users',uid), { nickname: newNick });
          alert('ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
          if(currentUser && currentUser.id === uid){ currentUser.nickname = newNick; const el = document.getElementById('user-name'); if(el) el.textContent = newNick; }
        } catch(err){ console.error(err); alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
      });
    });

    Array.from(container.querySelectorAll('.um-add')).forEach(btn=>{
      btn.addEventListener('click', async (e)=>{
        const tr = e.target.closest('tr');
        const uid = tr.getAttribute('data-uid');
        const delta = Number(tr.querySelector('.um-bnpdelta').value || 0);
        if(!delta){ alert('å¢—æ¸›é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
        if(!confirm(`${uid} ã« ${delta} bnp ã‚’ä»˜ä¸ã—ã¾ã™ã‹ï¼Ÿ`)) return;
        await changeUserBnp(uid, delta, tr);
      });
    });

    Array.from(container.querySelectorAll('.um-sub')).forEach(btn=>{
      btn.addEventListener('click', async (e)=>{
        const tr = e.target.closest('tr');
        const uid = tr.getAttribute('data-uid');
        const delta = Number(tr.querySelector('.um-bnpdelta').value || 0);
        if(!delta){ alert('å¢—æ¸›é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
        if(!confirm(`${uid} ã‹ã‚‰ ${delta} bnp ã‚’æ²¡åã—ã¾ã™ã‹ï¼Ÿ`)) return;
        await changeUserBnp(uid, -delta, tr);
      });
    });

    Array.from(container.querySelectorAll('.um-set')).forEach(btn=>{
      btn.addEventListener('click', async (e)=>{
        const tr = e.target.closest('tr');
        const uid = tr.getAttribute('data-uid');
        const newVal = Number(prompt(`${uid} ã® bnp ã‚’ã„ãã¤ã«è¨­å®šã—ã¾ã™ã‹ï¼Ÿ`, tr.querySelector('.um-bnp-value').textContent) || 0);
        if(isNaN(newVal)){ alert('æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
        if(!confirm(`${uid} ã® bnp ã‚’ ${newVal} ã«è¨­å®šã—ã¾ã™ã‹ï¼Ÿ`)) return;
        try {
          await updateDoc(doc(db,'users',uid), { bnp: newVal });
          tr.querySelector('.um-bnp-value').textContent = newVal;
          if(currentUser && currentUser.id === uid){ refreshHeaderBnp(); } // update header if self
        } catch(err){ console.error(err); alert('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
      });
    });

  } catch(err){
    console.error('loadUserList error', err);
    container.innerHTML = `<div style="color:#666">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>`;
  }
}

// bnp ã‚’å¤‰æ›´ã™ã‚‹å…±é€šå‡¦ç†ï¼ˆèª­ã¿å–ã‚Šâ†’åŠ ç®—â†’ä¿å­˜ï¼‰
async function changeUserBnp(uid, delta, trElement){
  try {
    const uRef = doc(db,'users',uid);
    const snap = await getDoc(uRef);
    let currentVal = 0;
    if(snap.exists()) currentVal = Number(snap.data().bnp || 0);
    const newVal = currentVal + Number(delta || 0);
    await updateDoc(uRef, { bnp: newVal });
    if(trElement){
      trElement.querySelector('.um-bnp-value').textContent = newVal;
    }
    if(currentUser && currentUser.id === uid){
      refreshHeaderBnp();
    }
    alert('æ›´æ–°ã—ã¾ã—ãŸ');
  } catch(err){
    console.error(err);
    alert('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (err.message || err));
  }
}
// âœ… ãƒšãƒ¼ã‚¸å†èª­ã¿è¾¼ã¿ã‚„é–‰ã˜ã‚‹å‰ã«è­¦å‘Šã‚’å‡ºã™
window.addEventListener("beforeunload", function (event) {
  // ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã ã‘è­¦å‘Šã‚’å‡ºã™ï¼ˆcurrentUserãŒå­˜åœ¨ã™ã‚‹ã¨ãï¼‰
  if (typeof currentUser !== "undefined" && currentUser) {
    const message = "å†èª­ã¿è¾¼ã¿ã™ã‚‹ã¨ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã•ã‚Œã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ";
    event.preventDefault();
    event.returnValue = message; // Chrome / Edge å¯¾å¿œ
    return message; // Safari å¯¾å¿œ
  }
});

  </script>


</body>
</html>







